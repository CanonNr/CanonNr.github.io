[{"title":"AQS é¦–èŠ‚ç‚¹ä¸ºä»€ä¹ˆä¸ºnullçš„è™šèŠ‚ç‚¹","url":"/2022/01/06/AQS-%E9%A6%96%E8%8A%82%E7%82%B9%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%BAnull%E7%9A%84%E8%99%9A%E8%8A%82%E7%82%B9/","content":"ä¸€å¥è¯æ€»ç»“èŠ‚ç‚¹å…¥é˜Ÿä¸æ˜¯åŸå­æ“ä½œï¼ï¼ï¼\nç­‰å¾…é˜Ÿåˆ—æ­£åœ¨æœ‰çº¿ç¨‹è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†åªæ˜¯è¿›è¡Œåˆ°äº†TailæŒ‡å‘Headï¼Œæ²¡æœ‰å°†HeadæŒ‡å‘Tailï¼Œæ­¤æ—¶é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ï¼Œéœ€è¦è¿”å›Trueã€‚å¦‚æœHeadæ²¡æœ‰æŒ‡å‘Tailï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿéœ€è¦å°†ç›¸å…³çº¿ç¨‹åŠ å…¥é˜Ÿåˆ—ä¸­ã€‚æ‰€ä»¥è¿™å—ä»£ç æ˜¯ä¸ºäº†è§£å†³æç«¯æƒ…å†µä¸‹çš„å¹¶å‘é—®é¢˜ã€‚\nå…·ä½“ä»£ç ä¸€åˆ‡è¦å…ˆä» tryAcquireå¼€å§‹protected final boolean tryAcquire(int acquires) &#123;    final Thread current = Thread.currentThread();    int c = getState();    if (c == 0) &#123;        if (!hasQueuedPredecessors() &amp;&amp;            compareAndSetState(0, acquires)) &#123;            setExclusiveOwnerThread(current);            return true;        &#125;    &#125;    ......&#125;\n\nåœ¨å°è¯•è·å–é”çš„æ—¶å€™å¦‚æœ State=0(æ²¡æœ‰çº¿ç¨‹æŒæœ‰),ä¼šå°†é”çš„æŒæœ‰è€…è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚\nè€ƒè™‘åˆ°å¹¶å‘çš„é—®é¢˜ï¼Œå¹¶æ²¡æœ‰å› ä¸ºçŠ¶æ€ä¸º0å°±ç›´æ¥ setExclusiveOwnerThread(current)ï¼Œè€Œæ˜¯åŠ äº†ä¸€ä¸ª hasQueuedPredecessorsçš„åˆ¤æ–­\ns = h.nextpublic final boolean hasQueuedPredecessors() &#123;\t// The correctness of this depends on head being initialized\t// before tail and on head.next being accurate if the current\t// thread is first in queue.\tNode t = tail; // Read fields in reverse initialization order\tNode h = head;\tNode s;\treturn h != t &amp;&amp; ((s = h.next) == null || s.thread != Thread.currentThread());&#125;// å¦‚æœåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰æœ‰ä¸€ä¸ªæ’é˜Ÿçš„çº¿ç¨‹ï¼Œåˆ™ä¸ºtrue;// å¦‚æœå½“å‰çº¿ç¨‹ä½äºé˜Ÿåˆ—çš„å¤´éƒ¨æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¸ºfalse\n\nå¦‚ä¸Šæ˜¯æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹ç­‰å¾…è·å–çš„æ—¶é—´è¶…è¿‡å½“å‰çº¿ç¨‹ã€‚\nå¦‚æœè¯´æ­¤æ—¶æ²¡æœ‰äººè·å–é”ï¼Œæ­£å¸¸æ¥è¯´å¤´å’Œå°¾éƒ½æ˜¯å¾…åˆå§‹åŒ–é˜¶æ®µéƒ½ä¸ºnullï¼Œé‚£ä»€ä¹ˆæƒ…å†µä¸‹æ‰æœ‰å¯èƒ½ h != tï¼Ÿ\nh != tprivate Node addWaiter(Node mode) &#123;    Node node = new Node(Thread.currentThread(), mode);    // Try the fast path of enq; backup to full enq on failure    Node pred = tail;    if (pred != null) &#123;        node.prev = pred;//è¿™é‡Œåªæ˜¯æ‰§è¡Œä¸€ä¸ªå¿«é€Ÿæ“ä½œï¼Œå®ƒå’Œenqé‡Œçš„elseåˆ†æ”¯çš„é€»è¾‘ä¸€æ ·        if (compareAndSetTail(pred, node)) &#123;            pred.next = node;            return node;        &#125;    &#125;    enq(node);//å¦‚æœä¸Šé¢å¿«é€Ÿæ“ä½œæ²¡æœ‰æˆåŠŸï¼Œå†æ‰§è¡Œenq    return node;&#125;private Node enq(final Node node) &#123;    for (;;) &#123;//ä½¿ç”¨forå¾ªç¯ï¼Œä¿è¯å…¥é˜ŸæˆåŠŸ        Node t = tail;        if (t == null) &#123; // ç¬¬ä¸€æ¬¡å…¥é˜Ÿï¼Œæ²¡æœ‰dummy nodeçš„å­˜åœ¨ï¼Œéœ€å…ˆåˆ›å»ºå®ƒ            if (compareAndSetHead(new Node()))                tail = head;        &#125; else &#123; // è‡³å°‘æœ‰ä¸€ä¸ªnodeï¼Œå°è¯•å…¥é˜Ÿ            node.prev = t;            if (compareAndSetTail(t, node)) &#123;                t.next = node;                return t;            &#125;        &#125;    &#125;&#125;\n\nåœ¨æ·»åŠ æ–°çš„èŠ‚ç‚¹æ—¶ï¼Œå¦‚æœ tail == nullä¼šæ‰§è¡Œ enqæ–¹æ³•ï¼Œé€šè¿‡æ­»å¾ªç¯ä¿è¯å…¥åˆ—çš„æˆåŠŸã€‚\ntail == null è¡¨ç¤ºèŠ‚ç‚¹è¿˜æ²¡æœ‰åˆå§‹åŒ–éœ€è¦åˆ›å»ºã€‚\nå…ˆé€šè¿‡ CASæ–¹å¼å°† Headè®¾ç½®ä¸º new Node()ï¼Œè®¾ç½®æˆåŠŸå†è®¾ç½®å°¾æŒ‡é’ˆã€‚\nè¿™ä¸ªæ“ä½œè‚¯å®šä¸æ˜¯åŸå­æ€§çš„ï¼Œæ— æ³•ä¿è¯ä¸è¢«æ‰“æ–­ã€‚æ‰€ä»¥ h != tçš„æƒ…å†µå°±æ˜¯å‘ç”Ÿåœ¨ compareAndSetHead(new Node())å’Œ tail = headçš„é—´éš™ä¸­ã€‚\n","categories":["Java"],"tags":["å¤šçº¿ç¨‹ä¸é«˜å¹¶å‘ç³»åˆ—","AQS","é”"]},{"title":"AQSåŸºç¡€ç†è§£","url":"/2022/01/06/AQS%E5%9F%BA%E7%A1%80%E7%90%86%E8%A7%A3/","content":"å‰è¨€Javaä¸­çš„å¤§éƒ¨åˆ†åŒæ­¥ç±»ï¼ˆLockã€Semaphoreã€ReentrantLockç­‰ï¼‰éƒ½æ˜¯åŸºäº AbstractQueuedSynchronizer ï¼ˆç®€ç§°ä¸ºAQSï¼‰å®ç°çš„ï¼Œä¸­æ–‡åï¼šæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨ã€‚\nAQSæ˜¯ä¸€ç§æä¾›äº†åŸå­å¼ç®¡ç†åŒæ­¥çŠ¶æ€ã€é˜»å¡å’Œå”¤é†’çº¿ç¨‹åŠŸèƒ½ä»¥åŠé˜Ÿåˆ—æ¨¡å‹çš„ç®€å•æ¡†æ¶ã€‚\næ ¸å¿ƒæ€æƒ³\nå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œé‚£ä¹ˆå°±å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ï¼›\nå¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œå°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…ã€‚\nè¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚\n\n\nCLHï¼šCraigã€Landin and Hagerstené˜Ÿåˆ—ï¼Œæ˜¯å•å‘é“¾è¡¨ï¼ŒAQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰ï¼ŒAQSæ˜¯é€šè¿‡å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹æ¥å®ç°é”çš„åˆ†é…ã€‚\nAQSä½¿ç”¨ä¸€ä¸ª Volatile çš„ int ç±»å‹çš„æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çš„æ’é˜Ÿå·¥ä½œï¼Œé€šè¿‡CASå®Œæˆå¯¹Stateå€¼çš„ä¿®æ”¹ã€‚\n\n\nå½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥æŸ¥è¯¢ state çš„çŠ¶æ€ï¼Œå¦‚æœ  state = 0  åˆ™è·å–é”ï¼Œå¦‚æœ å¤§äº 0 åˆ™è¡¨ç¤ºå·²ç»è¢«è·å–ï¼Œéœ€è¦è¿›å…¥CLHé˜Ÿåˆ—ç­‰å¾…ã€‚\n\næ‰€ä»¥AQSçš„æœ¬è´¨æ˜¯\nä¸€ä¸ªVolatile ä¿®é¥° int ç±»å‹çš„ State\nCAS\nåŒå‘é“¾è¡¨\n\nå…³äºæ€§èƒ½AQSé€šè¿‡CASæ“ä½œä»£æ›¿äº† synchronized çš„é‡é‡çº§é”ï¼Œæ€§èƒ½å¾—åˆ°äº†æå‡ï¼Œä½†æ˜¯åœ¨JDk1.5ä¹‹å synchronizedå¸¦æ¥äº†é”å‡çº§çš„æœºåˆ¶ï¼ŒäºŒè€…æ€§èƒ½ä¸Šå·®è·å·²ç»ä¸å¤§ï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯è¿›è¡Œä¸åŒçš„é€‰å‹\n","categories":["Java"],"tags":["å¤šçº¿ç¨‹ä¸é«˜å¹¶å‘ç³»åˆ—","AQS","é”"]},{"title":"First Test Post","url":"/2022/01/06/First-Test-Post/","content":"Testè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çš„æ–‡ç« ä¸€ä¸ªå›¾ç‰‡çš„æµ‹è¯•http\nhttps\n"},{"title":"JVM å†…å­˜ç»“æ„","url":"/2022/01/08/JVM-%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/","content":"å‰è¨€æ ¹æ®ä¸Šå›¾æˆ‘ä»¬å‘ç° Java å†…å­˜ç»“æ„ç”±å †ã€è™šæ‹Ÿæœºæ ˆã€æ–¹æ³•åŒºã€ç¨‹åºè®¡ç®—å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆã€‚å¦‚æœåˆ†ä¸ºä¸¤ç§ç±»å‹åˆ™æ˜¯ï¼šçº¿ç¨‹å…±äº«çš„ å’Œ çº¿ç¨‹ç§æœ‰çš„ã€‚\nçº¿ç¨‹ç§æœ‰ç¨‹åºè®¡æ•°å™¨ï¼ˆPC Registerï¼‰åœ¨å›¾ä¸­çœ‹åˆ°äº†å¾ˆå¤§ä¸€å—ç¨‹åºè®¡æ•°å™¨å…¶å®åœ¨ç°å®ä¸­åªæ˜¯å¼€è¾Ÿäº†å¾ˆå°å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œä»–çš„æ ¸å¿ƒä½œç”¨æ˜¯ç”¨äºï¼šè®°å½•çº¿ç¨‹æ‰§è¡Œåˆ°çš„ä½ç½®ã€‚\n\nç”±äºJavaè™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢å¹¶åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨ï¼ˆå¯¹äºå¤šæ ¸å¤„ç†å™¨æ¥è¯´æ˜¯ä¸€ä¸ªå†…æ ¸ï¼‰åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ã€‚å› æ­¤ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„æ¡çº¿ç¨‹ä¹‹é—´çš„è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ã€‚\n\n\nç¨‹åºè®¡æ•°å™¨ä¸­åªå­˜å‚¨å½“å‰çº¿ç¨‹æ‰§è¡Œç¨‹åºçš„è¡Œå·ï¼Œä¸€ä¸ªç±»æŒ‡é’ˆçš„æ•°æ®ç»“æ„ã€‚JVMçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ–¹æ³•æœ‰2ç§ç±»å‹ï¼šæ™®é€šJavaæ–¹æ³•å’Œç”±å…¶ä»–è¯­è¨€å®ç°çš„nativeæ–¹æ³•ã€‚å¦‚æœå½“å‰æ‰§è¡Œçš„æ˜¯æ™®é€šJavaæ–¹æ³•ï¼Œåˆ™ç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ˜¯è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚å¦‚æœå½“å‰æ‰§è¡Œçš„æ˜¯nativeæ–¹æ³•ï¼Œåˆ™è®¡æ•°å™¨çš„å€¼ä¸ºç©ºï¼ˆUndefinedï¼‰ã€‚\n\nè™šæ‹Ÿæœºæ ˆï¼ˆVM Stackï¼‰\nå’Œç¨‹åºè®¡æ•°å™¨ä¸€æ ·ï¼Œè™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå³ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç›¸åŒã€‚\nJavaè™šæ‹Ÿæœºæ ˆå’Œçº¿ç¨‹åŒæ—¶åˆ›å»ºï¼Œç”¨äºå­˜å‚¨æ ˆå¸§ã€‚æ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§(Stack Frame)ï¼Œç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªæ–¹æ³•ä»è°ƒç”¨ç›´åˆ°æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹å°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ ˆå¸§ï¼šä¸€ä¸ªæ ˆå¸§éšç€ä¸€ä¸ªæ–¹æ³•çš„è°ƒç”¨å¼€å§‹è€Œåˆ›å»ºï¼Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨å®Œæˆè€Œé”€æ¯ã€‚æ ˆå¸§å†…å­˜æ”¾è€…æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ï¼Œæ“ä½œæ•°æ ˆç­‰æ•°æ®ã€‚æ ˆå¸§ä¹Ÿå«è¿‡ç¨‹æ´»åŠ¨è®°å½•ï¼Œæ˜¯ç¼–è¯‘å™¨ç”¨æ¥å®ç°è¿‡ç¨‹/å‡½æ•°è°ƒç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚\n\n\n\næ ˆå¸§ç»“æ„\n\nå±€éƒ¨å˜é‡è¡¨å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variable Tableï¼‰æ˜¯ä¸€ç»„å˜é‡å€¼å­˜å‚¨ç©ºé—´ï¼Œç”¨äºå­˜æ”¾æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚å¹¶ä¸”åœ¨Javaç¼–è¯‘ä¸ºClassæ–‡ä»¶æ—¶ï¼Œå°±å·²ç»ç¡®å®šäº†è¯¥æ–¹æ³•æ‰€éœ€è¦åˆ†é…çš„å±€éƒ¨å˜é‡è¡¨çš„æœ€å¤§å®¹é‡ã€‚\n\nåŠ¨æ€è¿æ¥æ¯ä¸ªæ ˆå¸§éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ï¼ŒæŒæœ‰è¿™ä¸ªå¼•ç”¨æ˜¯ä¸ºäº†æ”¯ä»˜æ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­çš„åŠ¨æ€è¿æ¥Dynamic Linkingï¼‰ã€‚\n\næ“ä½œæ•°æ®æ ˆæ“ä½œæ•°æ ˆå’Œå±€éƒ¨å˜é‡è¡¨ä¸€æ ·ï¼Œåœ¨ç¼–è¯‘æ—¶æœŸå°±å·²ç»ç¡®å®šäº†è¯¥æ–¹æ³•æ‰€éœ€è¦åˆ†é…çš„å±€éƒ¨å˜é‡è¡¨çš„æœ€å¤§å®¹é‡ã€‚\n\nè¿”å›æ–¹æ³•å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œåªæœ‰2ç§æ–¹å¼å¯ä»¥é€€å‡ºè¿™ä¸ªæ–¹æ³• ï¼š\n\næ–¹æ³•è¿”å›æŒ‡ä»¤ æ‰§è¡Œå¼•æ“é‡åˆ°ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™æ—¶å€™æœ‰å¯èƒ½ä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œè¿™ç§é€€å‡ºæ–¹å¼ç§°ä¸ºæ­£å¸¸å®Œæˆå‡ºå£ã€‚\nå¼‚å¸¸é€€å‡º ï¼š åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼Œå¹¶ä¸”æ²¡æœ‰å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºã€‚\n\n\n\n\n\næœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªjavaè°ƒç”¨éjavaä»£ç çš„æ¥å£ï¼Œä¸€èˆ¬æ˜¯Cæˆ–C++ä»£ç ã€‚è‡³äºä¸ºä»€ä¹ˆä½¿ç”¨å…¶ä»–è¯­è¨€ä¸»è¦æ˜¯ä½¿ç”¨æ›´åº•å±‚çš„è¯­è¨€æ•ˆç‡æ›´é«˜ã€‚\nçº¿ç¨‹å…±äº«å †ï¼ˆHeapï¼‰\nJAVAå †å†…å­˜ç®¡ç†æ˜¯å½±å“æ€§èƒ½ä¸»è¦å› ç´ ä¹‹ä¸€ä¹Ÿæ˜¯è™šæ‹Ÿæœºç®¡ç†ä¸­å¿ƒå†…å­˜æœ€å¤§çš„ä¸€å—ï¼Œåœ¨è™šæ‹Ÿæœºå¯æ—¶åˆ›å»ºã€‚æ­¤å†…å­˜åŒºåŸŸå”¯ä¸€çš„ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼ŒJavaä¸­å‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚\n\n\nä¸‹é¢é€šè¿‡ä¸€ä¸ªå›¾ç‰‡çœ‹ä¸€ä¸‹ç»„æˆéƒ¨åˆ†ï¼š\næ–°ç”Ÿä»£\n\n\næ–°ç”Ÿæˆçš„å¯¹è±¡é¦–å…ˆæ”¾åˆ°å¹´è½»ä»£EdenåŒºï¼Œå½“Edenç©ºé—´æ»¡äº†ï¼Œè§¦å‘Minor GCï¼Œå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡ç§»åŠ¨åˆ°Survivor0åŒºï¼ŒSurvivor0åŒºæ»¡åè§¦å‘æ‰§è¡ŒMinor GCï¼ŒSurvivor0åŒºå­˜æ´»å¯¹è±¡ç§»åŠ¨åˆ°Suvivor1åŒºï¼Œè¿™æ ·ä¿è¯äº†ä¸€æ®µæ—¶é—´å†…æ€»æœ‰ä¸€ä¸ªsurvivoråŒºä¸ºç©ºã€‚ç»è¿‡å¤šæ¬¡Minor GCä»ç„¶å­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚\n\nç»“æ„ç»„æˆï¼š\n\nä¼Šç”¸å›­åŒº\nå¹¸å­˜è€…ä¸€åŒº\nå¹¸å­˜è€…äºŒåŒº\n\n\nğŸ’¡ æ–°ç”Ÿä»£ç‰¹ç‚¹ï¼šæ¯æ¬¡åƒåœ¾å›æ”¶æ—¶éƒ½æœ‰å¤§é‡çš„å¯¹è±¡éœ€è¦è¢«å›æ”¶ã€‚åƒåœ¾å›æ”¶å™¨åœ¨æ–°ç”Ÿä»£é‡‡ç”¨çš„æ”¶é›†ç®—æ³•æ˜¯Copying(å¤åˆ¶)æ–¹æ³•ï¼šå®ƒå°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—é¢å¯¹å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ï¼Œç„¶åå†æŠŠå·²ä½¿ç”¨çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚ç”±äºæ–°ç”Ÿä»£æœ‰æ¯æ¬¡åƒåœ¾å›æ”¶æ—¶éƒ½æœ‰å¤§é‡çš„å¯¹è±¡éœ€è¦è¢«å›æ”¶çš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥é‡‡ç”¨Copyingç®—æ³•ï¼Œå¤åˆ¶çš„å­˜æ´»å¯¹è±¡è¾ƒå°‘ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ã€‚ä½†æ˜¯Copyingç®—æ³•è¿˜æ˜¯æœ‰ç¼ºé™·çš„ï¼Œé‚£å°±æ˜¯å†…å­˜çš„ä½¿ç”¨ç‡åªæœ‰ä¸€åŠã€‚\n\n\nå†…å­˜åˆ†é…\nå †çš„å¤§å°å¯ä»¥é€šè¿‡å‚æ•° â€“Xmsã€-Xmxæ¥æŒ‡å®šã€‚\næ–°ç”Ÿä»£ ( Young ) ä¸è€å¹´ä»£ ( Old ) çš„é»˜è®¤æ¯”ä¾‹çš„å€¼ä¸º 1:2 ( è¯¥å€¼å¯ä»¥é€šè¿‡å‚æ•° â€“XX:NewRatio æ¥æŒ‡å®š )\nä¼Šç”¸åŒº : å¹¸å­˜ä¸€åŒº : å¹¸å­˜äºŒåŒº = 8 : 1 : 1 ( å¯ä»¥é€šè¿‡å‚æ•° â€“XX:SurvivorRatio æ¥è®¾å®š )ï¼Œ\nè€å¹´ä»£\n\n\nè€å¹´ä»£å­˜å‚¨é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œå æ»¡æ—¶ä¼šè§¦å‘Major GC=Full GCï¼ŒGCæœŸé—´ä¼šåœæ­¢æ‰€æœ‰çº¿ç¨‹ç­‰å¾…GCå®Œæˆï¼Œæ‰€ä»¥å¯¹å“åº”è¦æ±‚é«˜çš„åº”ç”¨å°½é‡å‡å°‘å‘ç”ŸMajor GCï¼Œé¿å…å“åº”è¶…æ—¶ã€‚\n\n\n\næ°¸ä¹…ä»£æ°¸ä¹…ä»£å­˜æ”¾ç±»çš„å¸¸é‡ã€é™æ€å˜é‡ç­‰ä¿¡æ¯ï¼Œæ˜¯æ–¹æ³•åŒºçš„å®ç°ã€‚å¯¹æ°¸ä¹…ä»£çš„å›æ”¶ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹ï¼šåºŸå¼ƒå¸¸é‡å’Œæ— ç”¨çš„ç±»ã€‚\n\n\nğŸ’¡ æ³¨æ„ï¼šJDK1.8 ä¹‹åï¼Œä¸å­˜åœ¨æ°¸ä¹…å¸¦ï¼Œå³æ²¡æœ‰java.lang.OutOfMemoryError: PermGen space è¿™ç§é”™è¯¯ã€‚å–è€Œä»£ä¹‹çš„æ˜¯Meta spaceï¼ˆå…ƒç©ºé—´ï¼‰ã€‚ä¹‹å‰å­˜å‚¨åœ¨æ°¸ä¹…å¸¦çš„å­—ç¬¦ä¸²å¸¸é‡ï¼Œé™æ€å˜é‡ç§»åˆ°äº†å †ä¸­å»äº†ï¼Œå…ƒç©ºé—´ä¸å­˜å‚¨åœ¨å †ä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨æœ¬åœ°å†…å­˜ä¸­ã€‚\n\næ–¹æ³•åŒºï¼ˆMethod Areaï¼‰æ–¹æ³•åŒºæ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œæ‰€æœ‰å­—æ®µå’Œå­—èŠ‚ç ï¼Œä»¥åŠä¸€äº›ç‰¹æ®Šæ–¹æ³•å¦‚æ„é€ å™¨ï¼Œæ¥å£ä»£ç ä¹Ÿåœ¨æ­¤å®šä¹‰ã€‚ç®€å•è¯´ï¼Œæ‰€æœ‰å®šä¹‰çš„æ–¹æ³•çš„ä¿¡æ¯éƒ½ä¿å­˜åœ¨è¯¥åŒºåŸŸï¼Œæ­¤åŒºåŸŸå±äºå…±äº«åŒºé—´ã€‚é™æ€å˜é‡ + å¸¸é‡ + ç±»ä¿¡æ¯ + è¿è¡Œæ—¶å¸¸é‡æ± å­˜åœ¨æ–¹æ³•åŒºä¸­ï¼Œå®ä¾‹å¯¹è±¡å­˜åœ¨å †å†…å­˜ä¸­ã€‚\n","categories":["Java"],"tags":["JVM","é€ ç«ç®­"]},{"title":"Java new ä¸€ä¸ªå¯¹è±¡éƒ½ç»å†äº†ä»€ä¹ˆ","url":"/2022/01/08/Java-new-%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88/","content":"å‰è¨€\nJavaåœ¨newä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šå…ˆæŸ¥çœ‹å¯¹è±¡æ‰€å±çš„ç±»æœ‰æ²¡æœ‰è¢«åŠ è½½åˆ°å†…å­˜ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°±ä¼šå…ˆé€šè¿‡ç±»çš„å…¨é™å®šåæ¥åŠ è½½ã€‚åŠ è½½å¹¶åˆå§‹åŒ–ç±»å®Œæˆåï¼Œå†è¿›è¡Œå¯¹è±¡çš„åˆ›å»ºå·¥ä½œã€‚ç”±æ­¤å¾—å‡ºä¸€ä¸ªnewä¸€ä¸ªjavaå¯¹è±¡åŒ…æ‹¬ä¸¤ä¸ªè¿‡ç¨‹ï¼šåŠ è½½å’Œåˆ›å»º\n\nåŠ è½½ç±»\njavaæ˜¯ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ¥è¿›è¡Œç±»çš„åŠ è½½çš„ï¼Œå…·ä½“æŸ¥çœ‹åŒäº²å§”æ´¾çš„ç¬”è®°ã€‚\n\n1.åŠ è½½ç”±ç±»åŠ è½½å™¨è´Ÿè´£æ ¹æ®ä¸€ä¸ªç±»çš„å…¨é™å®šç±»åæ¥è¯»å–æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµåˆ°JVMå†…éƒ¨ï¼Œå¹¶å­˜å‚¨åœ¨è¿è¡Œæ—¶å†…å­˜åŒºçš„æ–¹æ³•åŒºï¼Œç„¶åå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªä¸ç›®æ ‡ç±»å‹å¯¹åº”çš„java.lang.Classå¯¹è±¡å®ä¾‹â€‹\n2.éªŒè¯\næ ¼å¼éªŒè¯ï¼šéªŒè¯æ˜¯å¦ç¬¦åˆclassæ–‡ä»¶è§„èŒƒ\næ˜¯å¦ä»¥0xCAFEBABEå¼€å¤´\nä¸»ã€æ¬¡ç‰ˆæœ¬å·æ˜¯å¦åœ¨å½“å‰è™šæ‹Ÿæœºçš„å¤„ç†èŒƒå›´ä¹‹å†…\n\n\n\n3.å‡†å¤‡åœ¨æ–¹æ³•åŒºå†…ä¸ºç±»é™æ€å˜é‡åˆ†é…å†…å­˜å¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ã€‚è¢« finalÂ ä¿®é¥°çš„ staticÂ å˜é‡ï¼ˆå¸¸é‡ï¼‰ï¼Œä¼šç›´æ¥èµ‹å€¼ã€‚\n4.è§£æè§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚\n\nç¬¦å·å¼•ç”¨ï¼šå­—ç¬¦ä¸²ç±»å‹çš„å¼•ç”¨ï¼Œèƒ½æ ¹æ®è¿™ä¸ªå­—ç¬¦ä¸²å®šä½åˆ°æŒ‡å®šçš„å¯¹è±¡ï¼Œå¦‚ï¼šjava/lang/StringBuilder\n\nç›´æ¥å¼•ç”¨ï¼šå†…å­˜åœ°å€\n5.åˆå§‹åŒ–\nåˆå§‹åŒ–æ˜¯æŒ‡ä¸ºç±»é™æ€å˜é‡èµ‹äºˆæ­£ç¡®çš„åˆå§‹å€¼ï¼ŒJVMè´Ÿè´£å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦å¯¹ç±»å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨Javaä¸­å¯¹ç±»å˜é‡è¿›è¡Œåˆå§‹å€¼è®¾å®šæœ‰ä¸¤ç§æ–¹å¼ï¼š\n\nå£°æ˜ç±»å˜é‡æ—¶æŒ‡å®šåˆå§‹å€¼ï¼›\nä½¿ç”¨é™æ€ä»£ç å—ä¸ºç±»å˜é‡æŒ‡å®šåˆå§‹å€¼ã€‚\n\n\næ‰§è¡Œstaticä»£ç å—\n\nstaticÂ ä»£ç å—åªæœ‰jvmèƒ½å¤Ÿè°ƒç”¨;å¦‚æœ staticÂ ä»£ç å—æœ‰å¤šä¸ªï¼ŒJVMå°†æŒ‰ç…§å®ƒä»¬åœ¨ç±»ä¸­å‡ºç°çš„å…ˆåé¡ºåºä¾æ¬¡æ‰§è¡Œå®ƒä»¬ï¼Œæ¯ä¸ªä»£ç å—åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚**\n\n\n\nåˆ›å»ºå¯¹è±¡1.åœ¨å †åŒºåˆ†é…å¯¹è±¡éœ€è¦çš„å†…å­˜åˆ†é…çš„å†…å­˜åŒ…æ‹¬æœ¬ç±»å’Œçˆ¶ç±»çš„æ‰€æœ‰å®ä¾‹å˜é‡ï¼Œä½†ä¸åŒ…æ‹¬ä»»ä½•é™æ€å˜é‡\n2.å¯¹æ‰€æœ‰å®ä¾‹å˜é‡èµ‹é»˜è®¤å€¼å°†æ–¹æ³•åŒºå†…å¯¹å®ä¾‹å˜é‡çš„å®šä¹‰æ‹·è´ä¸€ä»½åˆ°å †åŒºï¼Œç„¶åèµ‹é»˜è®¤å€¼\n3.æ‰§è¡Œå®ä¾‹åˆå§‹åŒ–ä»£ç åˆå§‹åŒ–é¡ºåºæ˜¯å…ˆåˆå§‹åŒ–çˆ¶ç±»å†åˆå§‹åŒ–å­ç±»ï¼Œåˆå§‹åŒ–æ—¶å…ˆæ‰§è¡Œå®ä¾‹ä»£ç å—ç„¶åæ˜¯æ„é€ æ–¹æ³•\n4.å®šä¹‰æ ˆå˜é‡å¦‚æœnewçš„å¯¹è±¡ä¼šèµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œåˆ™ä¼šåœ¨æ ˆåŒºå†…å®šä¹‰ä¸€ä¸ªè¯¥ç±»å‹çš„å¼•ç”¨å˜é‡ï¼Œç„¶åå°†å †åŒºçš„å¯¹è±¡åœ°å€èµ‹äºˆå®ƒã€‚\n","categories":["Java"],"tags":["JVM"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(ã€‡) äº”å¤§æ•°æ®ç±»å‹","url":"/2022/01/18/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E3%80%87-%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/","content":"å‰è¨€æœ¬æ–‡ä¸ä»‹ç»å…·ä½“ä½¿ç”¨ï¼Œå·²åº•å±‚å®ç°ä¸ºä¸»ã€‚å…ˆå®è§‚ä»‹ç»ä¸‹å®ç°æ–¹å¼å…·ä½“å®ç°åç»­æ–‡ç« ä»‹ç»ã€‚\næ•°æ®ç±»å‹\nå­—ç¬¦ä¸² String\nåˆ—è¡¨ List\né›†åˆ Set\næœ‰åºé›†åˆ ZSet\nå“ˆå¸Œ Hash\n\næ•°æ®ç¼–ç #define OBJ_ENCODING_RAW 0     /* Raw representation */#define OBJ_ENCODING_INT 1     /* Encoded as integer */#define OBJ_ENCODING_HT 2      /* Encoded as hash table */#define OBJ_ENCODING_ZIPMAP 3  /* Encoded as zipmap */#define OBJ_ENCODING_LINKEDLIST 4 /* No longer used: old list encoding. */#define OBJ_ENCODING_ZIPLIST 5 /* Encoded as ziplist */#define OBJ_ENCODING_INTSET 6  /* Encoded as intset */#define OBJ_ENCODING_SKIPLIST 7  /* Encoded as skiplist */#define OBJ_ENCODING_EMBSTR 8  /* Embedded sds string encoding */#define OBJ_ENCODING_QUICKLIST 9 /* Encoded as linked list of ziplists */#define OBJ_ENCODING_STREAM 10 /* Encoded as a radix tree of listpacks */\n\nåº•å±‚å®ç°\nä¸€ ã€å­—ç¬¦ä¸²ä½¿ç”¨äº†ä¸‰ç§ä½œä¸ºåº•å±‚çš„å®ç°ï¼š\n\nembstrï¼ˆOBJ_ENCODING_EMBSTRï¼‰\né•¿åº¦å°äº44å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œè¯¥ç¼–ç ä¸­ RedisObjectã€SDSæ”¾ç½®åœ¨è¿ç»­çš„å†…å­˜ä¸­ã€‚\n\nrowï¼ˆOBJ_ENCODING_RAWï¼‰\né•¿åº¦å¤§äº44å­—èŠ‚,é™¤æ­¤ä¹‹å¤–ä¸ OBJ_ENCODING_EMBSTRåŒºåˆ«ä»…åœ¨äºæ˜¯å¦ä¸ºè¿ç»­å†…å­˜\n\nintï¼ˆOBJ_ENCODING_INTï¼‰\næœ‰æ—¶å€™æˆ‘ä»¬ä¼šåœ¨Stringå¯¸INTç±»å‹çš„è‡ªç„¶æ•°ï¼Œä¾‹å¦‚ä¸€ä¸ªæ‰‹æœºå·å¦‚æœä¸ºå­—ç¬¦ä¸²åˆ™éœ€è¦11å­—èŠ‚ï¼Œå¦‚æœä½¿ç”¨long long åªéœ€è¦8å­—èŠ‚ã€‚\n\n\n3ä¸­çš„ Intæ²¡ä»€ä¹ˆå¥½è¯´çš„å±äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œ1å’Œ2éƒ½æ¶‰åŠåˆ°SDSï¼Œè¿™ä¹Ÿæ˜¯Redisä¸­å¾ˆåŸºç¡€çš„ä¸€ä¸ªå¯¹è±¡ã€‚\näºŒ ã€åˆ—è¡¨ä½¿ç”¨äº†ä¸‰ç§ä½œä¸ºåº•å±‚çš„å®ç°ï¼š\n\nåŒå‘é“¾è¡¨ï¼ˆOBJ_ENCODING_LINKEDLISTï¼‰\né“¾è¡¨èŠ‚ç‚¹æŒ‡é’ˆæ¯”è¾ƒå¤šï¼Œå†…å­˜æµªè´¹ã€‚\né“¾è¡¨ä¼šé€ æˆå†…å­˜ç¢ç‰‡\n\n\nå‹ç¼©åˆ—è¡¨ï¼ˆOBJ_ENCODING_ZIPLISTï¼‰\nåº•å±‚ä¸ºæ•°ç»„å®ç°ï¼Œè§£å†³äº†å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œä¸éœ€è¦æŒ‡é’ˆ\nå½“å…ƒç´ å¾ˆå¤šæ—¶ï¼Œå¯ç”¨å†…å­˜æ˜æ˜è¶³å¤Ÿï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜è€Œå‡ºé—®é¢˜\næ•°ç»„çš„æ–°å¢ã€åˆ é™¤ç‰µä¸€å‘åŠ¨å…¨èº«ï¼Œéœ€è¦æ•´ä¸ªåˆ—è¡¨è¿›è¡Œæ•°æ®æ“ä½œ\n\n\nå¿«é€Ÿåˆ—è¡¨ï¼ˆOBJ_ENCODING_ZIPLISTï¼‰\nåŸºäºå‹ç¼©åˆ—è¡¨å’Œé“¾è¡¨å®ç°ï¼Œè§£å†³äº†å‹ç¼©åˆ—è¡¨å­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œé€šè¿‡åˆ†æ²»æ€æƒ³æŠŠå¾ˆå¤§çš„åˆ—è¡¨æ‹†åˆ†ä¸ºå¤šä¸ª\n\n\n\n3.2ç‰ˆæœ¬ä¹‹åå¼ƒç”¨äº†åŒå‘é“¾è¡¨æ”¹ä¸ºå¿«é€Ÿåˆ—è¡¨ã€‚\né‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨å¿«é€Ÿåˆ—è¡¨ï¼Ÿ\n\næ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚å¹¶ä¸”ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº512ä¸ªçš„åˆ—è¡¨ä½¿ç”¨å‹ç¼©åˆ—è¡¨\nå­˜åœ¨å­—ç¬¦ä¸²å…ƒç´ é•¿åº¦å¤§äº64æˆ–å…ƒç´ ä¸ªæ•°å¤§äº512ä¸ªä½¿ç”¨å¿«é€Ÿåˆ—è¡¨\n\nä¸‰ã€Hashä½¿ç”¨äº†ä¸¤ç§ä½œä¸ºåº•å±‚çš„å®ç°ï¼š\n\nå­—å…¸ï¼ˆå“ˆå¸Œè¡¨ï¼‰(OBJ_ENCODING_HT)\nå‹ç¼©åˆ—è¡¨ï¼ˆOBJ_ENCODING_ZIPLISTï¼‰\n\nå…³äºä¸¤è€…çš„é€‰æ‹©å…¶å®æ¯”è¾ƒç®€å•ï¼š\n\nå› ä¸ºå‹ç¼©åˆ—è¡¨æ¯”å­—å…¸æ›´èŠ‚çœå†…å­˜ï¼Œ æ‰€ä»¥ç¨‹åºåœ¨åˆ›å»ºæ–° Hash é”®æ—¶ï¼Œ é»˜è®¤ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ å½“æœ‰éœ€è¦æ—¶ï¼Œ ç¨‹åºæ‰ä¼šå°†åº•å±‚å®ç°ä»å‹ç¼©åˆ—è¡¨è½¬æ¢åˆ°å­—å…¸ã€‚\n\n\næ€»é•¿åº¦è¶…è¿‡512å­—èŠ‚æˆ–è€…å•ä¸ªå…ƒç´ é•¿åº¦å¤§äº64ä½¿ç”¨å­—å…¸\næ€»é•¿åº¦å°äº512å­—èŠ‚æˆ–è€…å•ä¸ªå…ƒç´ é•¿åº¦å°äº64ä½¿ç”¨å‹ç¼©åˆ—è¡¨\n\nå››ã€Setä½¿ç”¨äº†ä¸¤ç§ä½œä¸ºåº•å±‚çš„å®ç°ï¼š\n\næ•´æ•°é›†åˆ (OBJ_ENCODING_INTSET)\nå­—å…¸ï¼ˆå“ˆå¸Œè¡¨ï¼‰(OBJ_ENCODING_HT)\n\nå…³äºä¸¤è€…çš„é€‰æ‹©ï¼š\n\nRedisæ²¡æœ‰è§„å®šSetå¯å­˜æ”¾çš„æ•°æ®ç±»å‹ä¸ºä»€ä¹ˆï¼Œå¯èƒ½é‡åˆ°ä¸StringåŒæ ·çš„é—®é¢˜ã€‚å­˜å‚¨ä¸€ä¸ªæ‰‹æœºå·ï¼Œä½¿ç”¨å­—ç¬¦ä¸²å’Œlongç±»å‹å†…å­˜çš„å ç”¨æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚\nçœŸçš„æ˜¯èƒ½çœå°±çœ\n\n\né›†åˆå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼ä¸”å…ƒç´ æ•°é‡ä¸è¶…è¿‡ 512 ä¸ªä½¿ç”¨æ•´æ•°é›†åˆ\næ€»é•¿åº¦è¶…è¿‡512å­—èŠ‚æˆ–è€…å•ä¸ªå…ƒç´ é•¿åº¦å¤§äº64çš„ä½¿ç”¨å­—å…¸\né‡åˆ°å¦‚ä¸‹æƒ…å†µä¼šç«‹åˆ»å‘ç”Ÿè½¬æ¢\nå¾€é›†åˆä¸­æ·»åŠ äº†éæ•´å‹å˜é‡ä¼šè½¬æ¢ä¸ºå­—å…¸\n\n\n\näº”ã€ZSetä½¿ç”¨äº†ä¸¤ç§ä½œä¸ºåº•å±‚çš„å®ç°ï¼š\n\nè·³è·ƒè¡¨ï¼ˆOBJ_ENCODING_SKIPLISTï¼‰\nå‹ç¼©åˆ—è¡¨ï¼ˆOBJ_ENCODING_ZIPLISTï¼‰\n\nä¸¤è€…çš„é€‰æ‹©ä¹Ÿåœ¨äºå†…å­˜çš„ä½¿ç”¨ä¸Šï¼š\n\nåœ¨å¤§é‡å…ƒç´ çš„é›†åˆä¸­ä½¿ç”¨è·³è·ƒè¡¨å¯ä»¥æ›´å¿«çš„æŸ¥è¯¢ï¼Œä½†æ˜¯å¦‚æœæ•°é‡ä¸å¤šè¿˜è¦å­˜å‚¨å¤§é‡çš„å¤šå±‚ç´¢å¼•ä¼šé€ æˆå†…å­˜çš„æµªè´¹ã€‚\n\n\nzsetä¼šæ ¹æ® zaddå‘½ä»¤æ·»åŠ çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å¤§å°æ¥é€‰æ‹©ç¼–ç æ–¹å¼ï¼šæ»¡è¶³ zset_max_ziplist_entriesçš„å€¼ä¸ä¸º0ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å°äº server.zset_max_ziplist_valueï¼Œä½¿ç”¨å‹ç¼©åˆ—è¡¨ï¼Œå¦åˆ™å°±æ˜¯è·³è·ƒè¡¨ã€‚\nå¾…æ–°åŠ çš„æ–°çš„å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡ zset_max_ziplist_valueï¼ˆé»˜è®¤å€¼64ï¼‰æ—¶æˆ–è€… ziplistä¿å­˜çš„èŠ‚ç‚¹æ•°é‡è¶…è¿‡ server.zset_max_ziplist_entriesï¼ˆé»˜è®¤å€¼128ï¼‰æ—¶ä½¿ç”¨skiplistã€‚\n\næ€»ç»“\n\n\næ•°æ®ç±»å‹\nString\nList\nHash\nSet\nZSet\n\n\n\nSDS\nâˆš\n\n\n\n\n\n\nå¿«é€Ÿåˆ—è¡¨\n\nâˆš\n\n\n\n\n\nåŒå‘é“¾è¡¨\n\nâˆš\n\n\n\n\n\nå‹ç¼©åˆ—è¡¨\n\nâˆš\nâˆš\n\nâˆš\n\n\nè·³è·ƒè¡¨\n\n\n\n\nâˆš\n\n\nå­—å…¸ï¼ˆå“ˆå¸Œè¡¨ï¼‰\n\n\nâˆš\nâˆš\n\n\n\næ•´æ•°é›†åˆ\n\n\n\nâˆš\n\n\n\nè‡´è°¢\nRedisæºç è§£æ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ\nRedis è®¾è®¡ä¸å®ç°\n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(ä¸€) SDS","url":"/2022/01/18/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80-SDS/","content":"Cè¯­è¨€å­˜å‚¨å­—ç¬¦ä¸²çš„é—®é¢˜Cè¯­è¨€ä¸­æ²¡æœ‰ç±»ä¼¼Javaä¸­çš„Stringé«˜çº§å¯¹è±¡åœ¨Javaä¸­ Stringç”¨çš„ä¸äº¦ä¹ä¹ï¼Œå…¶è‡ªå¸¦çš„ equalsã€splitã€charAtç­‰æ–¹æ³•çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯Cæ˜¯æ²¡æœ‰è¿™ç§é«˜çº§å¯¹è±¡çš„ã€‚\nå¦‚æœåœ¨Cè¯­è¨€ä¸­ä½¿ç”¨å­—ç¬¦ä¸²æœ‰ä¸¤ç§æ–¹å¼ï¼š\n\nä½¿ç”¨å­—ç¬¦ä¸²æŒ‡é’ˆ const char *str = &quot;hello&quot;;\nä½¿ç”¨æ•°ç»„ const char str[] = &quot;hello&quot;;\n\næ–¹æ³•ä¸€æœ€å¤§çš„ç¼ºé™·åœ¨äºå­—ç¬¦ä¸²å®šä¹‰åå³ä¸èƒ½ä¿®æ”¹ï¼Œæ‰€ä»¥æ›´å¤šæƒ…å†µä¸‹è¿˜æ˜¯ä½¿ç”¨æ•°ç»„ã€‚\näºŒè¿›åˆ¶å®‰å…¨Cè¯­è¨€ä¸­è¡¨ç¤ºå­—ç¬¦ä¸²ç»“å°¾çš„ç¬¦å·æ˜¯ \\0 ï¼Œå¦‚æœå­—ç¬¦ä¸²æœ¬èº«å°±å…·æœ‰ \\0 å­—ç¬¦ï¼Œå°±ä¼šè¢«æˆªæ–­ï¼Œå³éäºŒè¿›åˆ¶å®‰å…¨ã€‚\nè®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦æ€§èƒ½ä½Cè¯­è¨€ä¸­æœ‰ä¸€ä¸ªè®¡ç®—å­—ç¬¦ä¸²é•¿åº¦çš„å‡½æ•° strlenï¼Œä½†è¿™ä¸ªå‡½æ•°ä¸Javaçš„ä¸ä¸€æ ·ï¼Œéœ€è¦éå†æ•´ä¸ªå­—ç¬¦ä¸²æ¥è®¡ç®—é•¿åº¦ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯Oï¼ˆnï¼‰ï¼Œå¦‚æœéœ€è¦åœ¨å¾ªç¯ä¸­è®¡ç®—ï¼Œæ€§èƒ½å°†ååˆ†ä½ä¸‹ã€‚\nå­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½ä½å› ä¸ºCè¯­è¨€å­—ç¬¦ä¸²ä¸è®°å½•é•¿åº¦ï¼Œå¯¹äºä¸€ä¸ªé•¿åº¦nçš„å­—ç¬¦ä¸²æ¥è¯´ï¼Œåº•å±‚æ˜¯n+1çš„å­—ç¬¦æ•°ç»„ï¼ˆnæ˜¯æˆ‘ä»¬è¦å­˜çš„å­—ç¬¦ï¼Œ1æ˜¯æœ€åçš„ç»“æŸç¬¦ \\0ï¼‰ã€‚\n\nåº•å±‚è™½ç„¶ä½¿ç”¨äº†n+1çš„å­—ç¬¦æ•°ç»„ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ strlenæ–¹æ³•çš„æ—¶å€™ä¸ä¼šè®¡ç®— \\0\n\nSimple Dynamic String ç®€å•çš„åŠ¨æ€å­—ç¬¦ä¸²åœ¨ redis3.2ä¹‹å‰ï¼Œsdsåªæœ‰ä¸€ä¸ªç±»å‹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\nstruct sdshdr &#123;    unsigned int len; // å½“å‰çš„é•¿åº¦    unsigned int free; // å‰©ä½™å¯ç”¨é•¿åº¦    char buf[]; // å®é™…å­˜æ”¾çš„åœ°æ–¹&#125;;\n\nåœ¨åç»­ç‰ˆæœ¬ä¸­æ”¹ä¸ºäº†\nstruct __attribute__ ((__packed__)) sdshdr5 &#123;    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */    char buf[];&#125;;struct __attribute__ ((__packed__)) sdshdr8 &#123;    uint8_t len; // sdsçš„å½“å‰é•¿åº¦(å•ä½æ˜¯å­—èŠ‚)    uint8_t alloc; // sdsåˆ†é…çš„å†…å­˜å¤§å°(å•ä½æ˜¯å­—èŠ‚)    unsigned char flags; // sdshdrçš„ç±»å‹    char buf[]; // å®é™…å­˜æ”¾çš„åœ°æ–¹&#125;;struct __attribute__ ((__packed__)) sdshdr16 &#123;    uint16_t len;     uint16_t alloc;     unsigned char flags;     char buf[];&#125;;....\n\nsdshdr5ã€sdshdr8ã€sdshdr16ã€sdshdr32ã€sdshdr64 ä¸€å…±äº”ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­å®˜æ–¹æ³¨è§£æœ‰äº›åˆ° sdshdr5è¿˜æ²¡æœ‰è¢«ä½¿ç”¨è¿‡ã€‚\nç±»å‹æœºåˆ¶ä¸Šé¢ä»‹ç»äº†ä¸€å…±æœ‰äº”ä¸ª sdshdrXæ–¹æ³•ï¼Œçœ‹ç€éƒ½å·®ä¸å¤šåªæ˜¯ lenå’Œ alloc ç±»å‹ä¸åŒï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ\nå…¶å®ä¹Ÿå¾ˆç®€å•å°±æ˜¯çœå†…å­˜ï¼Œè€Œä¸”çœŸçš„æ˜¯æŠŠèƒ½çœå°±çœå‘æŒ¥åˆ°äº†æœºåˆ¶ï¼Œåœ¨åšä¸šåŠ¡å¼€å‘çš„æ—¶å€™å¾ˆå°‘ä¼šä¸ºäº†è¿™ç‚¹å†…å­˜å†å»åšä¸€å¥—ç‰¹æ®Šçš„å¤„ç†â€¦\nèŠ‚çœå†…å­˜æˆ‘ä»¬å·²çŸ¥çš„æ˜¯ lenå’Œ allocæœåŠ¡äºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ†åˆ«è®°å½•å­—ç¬¦ä¸²é•¿åº¦å’Œ\n\nuint8: å­—ç¬¦ä¸²çš„é•¿åº¦æœ€å¤§(2^8)-1  = 255\nuint16: å­—ç¬¦ä¸²çš„é•¿åº¦æœ€å¤§(2^16)-1 = 35535\nuint32: å­—ç¬¦ä¸²çš„é•¿åº¦æœ€å¤§(2^32)-1 = 4294967295\nuint64: å­—ç¬¦ä¸²çš„é•¿åº¦æœ€å¤§(2^64)-1 = 1.8446744e+19\n\nç»å¤§å¤šæ•°æƒ…å†µä¸‹å­—ç¬¦ä¸²çš„é•¿åº¦éƒ½ä¸ä¼šè¶…è¿‡35536ï¼Œå¦‚æœä½¿ç”¨ uint64å­˜å‚¨å‡ åä¸ªå‡ ç™¾å°±å¤ªæµªè´¹äº†ã€‚\næœ€å¤§é•¿åº¦é—®é¢˜è™½ç„¶ç±»å‹é™åˆ¶äº†æœ€å¤§é•¿åº¦ä¸º(2^64)-1 ï¼Œä½†æ˜¯çœŸæ­£é™åˆ¶çš„å¹¶ä¸æ˜¯å®ƒã€‚\ngetBitOffsetFromArgument æ˜¯ä¸€ä¸ªè®¡ç®—åç§»é‡é˜²æ­¢ä¸ºè´Ÿæˆ–è€…æº¢å‡ºçš„æ–¹æ³•ã€‚åœ¨å…¶æ–¹æ³•å†…æœ‰è¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­ï¼š\n/* Limit offset to server.proto_max_bulk_len (512MB in bytes by default) */if ((loffset &lt; 0) || (loffset &gt;&gt; 3) &gt;= server.proto_max_bulk_len)&#123;    addReplyError(c,err);    return C_ERR;&#125;\n\næ ¹æ®æºç æ³¨é‡Šå¯ä»¥çœ‹åˆ°ï¼Œä»–æ˜¯è®¾ç½®äº†512MBçš„ä¸€ä¸ªé•¿åº¦é™åˆ¶ï¼Œè¶…å‡ºä¼šè¿”å›å¼‚å¸¸ã€‚\nåœ¨ config.c æ–‡ä»¶ä¸­ä¼šå¯¹é…ç½®å¯¹è±¡ç»Ÿä¸€çš„å®šä¹‰ã€‚\ncreateLongLongConfig(&quot;proto-max-bulk-len&quot;, NULL, MODIFIABLE_CONFIG, 1024*1024, LONG_MAX, server.proto_max_bulk_len, 512ll*1024*1024, MEMORY_CONFIG, NULL, NULL), /* Bulk request max size */\n\nå­—ç¬¦ä¸²çš„è¿½åŠ ä¸æ‰©å®¹redis&gt; SET msg &quot;hello world&quot;OKredis&gt; APPEND msg &quot; again!&quot;(integer) 18redis&gt; GET msg&quot;hello world again!&quot;\n\nå¦‚ä¸Šæ‰§è¡Œäº†ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²è¿½åŠ å·¥ä½œã€‚æ¥ä¸‹æ¥ä»¥ä¼ªä»£ç çš„å½¢å¼ä»‹ç»æ•´ä¸ªè¿‡ç¨‹ç»å†äº†ä»€ä¹ˆã€‚\nSET å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªSDSå¯¹è±¡struct sdshdr &#123;    len = 11;    free = 0;    buf = &quot;hello world\\0&quot;;&#125;\n\næ‰§è¡Œ APPEND å‘½ä»¤æ­¤æ—¶ç›¸åº”çš„ sdshdr è¢«æ›´æ–°ï¼Œå­—ç¬¦ä¸² &quot; again!&quot; ä¼šè¢«è¿½åŠ åˆ°åŸæ¥çš„ &quot;hello world&quot; ä¹‹åï¼š\nstruct sdshdr &#123;    len = 18;    free = 18;    buf = &quot;hello world again!\\0                  &quot;;     // ç©ºç™½çš„åœ°æ–¹ä¸ºé¢„åˆ†é…ç©ºé—´ï¼Œå…± 18 + 18 + 1 ä¸ªå­—èŠ‚&#125;\n\nä¸éš¾å‘ç°ï¼Œfreeä»0-&gt;18ï¼Œlenä»11-&gt;18ï¼Œè¿™æ¬¡æ‰©å®¹æ•´ä½“ä»11-&gt;22ï¼ˆ18-11+18ï¼‰ã€‚\nå…·ä½“ä»£ç \nsds sdscatlen(sds s, const void *t, size_t len) &#123;    size_t curlen = sdslen(s);      // è·å–å½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦    s = sdsMakeRoomFor(s,len);      // æ‰©å®¹    if (s == NULL) return NULL;    memcpy(s+curlen, t, len);       // å†…å­˜æ‹·è´    sdssetlen(s, curlen+len);       // æ›´æ–°lenå±æ€§    s[curlen+len] = &#x27;\\0&#x27;;           // æœ«å°¾è¿½åŠ ä¸€ä¸ª\\0    return s;&#125;\n\nsds sdsMakeRoomFor(sds s, size_t addlen) &#123;    void *sh, *newsh;  //å®šä¹‰ä¸¤ä¸ª sdshdr ç»“æ„ä½“æŒ‡é’ˆ    size_t avail = sdsavail(s); // è·å– s ç›®å‰ç©ºé—²ç©ºé—´é•¿åº¦    size_t len, newlen, reqlen; // lenä¸ºæ‰©å±•å‰é•¿åº¦,newlenä¸ºæ‰©å±•åé•¿åº¦    char type, oldtype = s[-1] &amp; SDS_TYPE_MASK; // ç”¨ä½œsdsTypeçš„åˆ¤æ–­    int hdrlen;    size_t usable;    /* Return ASAP if there is enough space left. */     if (avail &gt;= addlen) return s; // å¦‚æœå¯ç”¨ç©ºé—´å¤§äºæ·»åŠ çš„é•¿åº¦ï¼Œç›´æ¥è¿”å›    len = sdslen(s);// è·å– s ç›®å‰å·²å ç”¨ç©ºé—´çš„é•¿åº¦    sh = (char*)s-sdsHdrSize(oldtype);  //ç»“æ„ä½“æŒ‡é’ˆèµ‹å€¼    reqlen = newlen = (len+addlen); // å¤åˆ¶æ‰©å±•åé•¿åº¦,åŸé•¿åº¦+æ‰©å±•çš„é•¿åº¦æ•°    assert(newlen &gt; len);   /* Catch size_t overflow */    // å¼€å§‹è®¾å®šæ‰©å±•åé•¿åº¦    if (newlen &lt; SDS_MAX_PREALLOC)        // å¦‚æœæ–°é•¿åº¦å°äºSDS_MAX_PREALLOC(1M),æ–°é•¿åº¦ç›´æ¥ç¿»å€        // è¿™ä¹Ÿå°±æ˜¯ä¸Šé¢ä¸ºä»€ä¹ˆä»11-&gt;22        newlen *= 2;    else        // å¦åˆ™æ¯æ¬¡æ–°å¢ä¸€ä¸ªSDS_MAX_PREALLOCå•ä½ä¹Ÿå°±æ˜¯1M        newlen += SDS_MAX_PREALLOC;    // æ­¤æ—¶æœ‰äº†æ–°é•¿åº¦éœ€è¦é‡æ–°è·å–ä¸€ä¸‹sdsçš„ç±»å‹,ä¹Ÿå°±æ˜¯sdshdr5,sdshdr8...    type = sdsReqType(newlen);    /* Don&#x27;t use type 5: the user is appending to the string and type 5 is     * not able to remember empty space, so sdsMakeRoomFor() must be called     * at every appending operation. */    // ä½œè€…ç¤ºæ„ä¸è¦ä½¿ç”¨sdshdr5,ä¼šå˜è½¬æ¢ä¸ºsdshdr8    if (type == SDS_TYPE_5) type = SDS_TYPE_8;    hdrlen = sdsHdrSize(type);    assert(hdrlen + newlen + 1 &gt; reqlen);  /* Catch size_t overflow */    // å¯¹æ¯”æ‰©å®¹å‰åç±»å‹æ˜¯å¦æ”¹å˜ï¼Œåšå¯¹åº”çš„å¤„ç†ï¼Œä¸é‡è¦    if (oldtype==type) &#123;        // æ²¡æœ‰æ”¹å˜,åœ¨åŸç©ºé—´åˆ†é…        newsh = s_realloc_usable(sh, hdrlen+newlen+1, &amp;usable);        if (newsh == NULL) return NULL;        s = (char*)newsh+hdrlen;    &#125; else &#123;        /* Since the header size changes, need to move the string forward,         * and can&#x27;t use realloc */        // é‡æ–°åˆ†é…ç©ºé—´        // å¹¶åˆ é™¤åŸç©ºé—´        newsh = s_malloc_usable(hdrlen+newlen+1, &amp;usable);        if (newsh == NULL) return NULL;        memcpy((char*)newsh+hdrlen, s, len+1);        s_free(sh);        s = (char*)newsh+hdrlen;        s[-1] = type;        sdssetlen(s, len);    &#125;    usable = usable-hdrlen-1;    if (usable &gt; sdsTypeMaxSize(type))        usable = sdsTypeMaxSize(type);    sdssetalloc(s, usable);    return s;&#125;\n\nç¼–ç æ ¼å¼åœ¨Redisä¸­ä¸ºäº†è¿›ä¸€æ­¥çš„èŠ‚çœå†…å­˜è¿˜ä¸ºSDSè®¾ç½®äº†ä¸‰ç§ç¼–ç æ ¼å¼ï¼š\n\nOBJ_ENCODING_EMBSTRï¼šé•¿åº¦å°äº44å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œè¯¥ç¼–ç ä¸­ RedisObjectã€SDSæ”¾ç½®åœ¨è¿ç»­çš„å†…å­˜ä¸­ã€‚\nOBJ_ENCODING_RAWï¼šé•¿åº¦å¤§äº44å­—èŠ‚,é™¤æ­¤ä¹‹å¤–ä¸ OBJ_ENCODING_EMBSTRåŒºåˆ«ä»…åœ¨äºæ˜¯å¦ä¸ºè¿ç»­å†…å­˜\nOBJ_ENCODING_INT: æœ‰æ—¶å€™æˆ‘ä»¬ä¼šåœ¨Stringå¯¸INTç±»å‹çš„è‡ªç„¶æ•°ï¼Œä¾‹å¦‚ä¸€ä¸ªæ‰‹æœºå·å¦‚æœä¸ºå­—ç¬¦ä¸²åˆ™éœ€è¦11å­—èŠ‚ï¼Œå¦‚æœä½¿ç”¨long long åªéœ€è¦8å­—èŠ‚ã€‚\n\næ€»ç»“\nRedis çš„å­—ç¬¦ä¸²è¡¨ç¤ºä¸º sds ï¼Œè€Œä¸æ˜¯ C å­—ç¬¦ä¸²ï¼ˆä»¥ \\0 ç»“å°¾çš„ char*ï¼‰ï¼Œç›¸æ¯”è¾ƒæœ‰å¦‚ä¸‹ç‰¹æ€§\nåœ¨è®¡ç®—å­—ç¬¦é•¿åº¦æ—¶æ›´é«˜æ•ˆï¼Œç›´æ¥è¯»å– lenç†Ÿæ‚‰ä¸ºO(1)å¤æ‚åº¦ï¼Œä¼ ç»ŸCè¯­è¨€éœ€è¦é€ä¸ªéå†ä¸ºO(n)\næä¾›æ›´é«˜æ•ˆçš„æ‰©å®¹æœºåˆ¶ï¼Œç‰ºç‰²ä¸€éƒ¨åˆ†å†…å­˜çš„æƒ…å†µä¸‹æ¢å–æ›´å¿«çš„è¿½åŠ é€Ÿåº¦\näºŒè¿›åˆ¶å®‰å…¨ï¼Œä¸å¼ºåˆ¶é€šè¿‡ \\0ä½œä¸ºç»“å°¾ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨SDSä¸­å¯ä»¥å­˜å‚¨ä»»ä½•å€¼\n\n\n\nè‡´è°¢\nRedisæºç è§£æ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ\nRedis è®¾è®¡ä¸å®ç°\nRedisåŠ¨æ€å­—ç¬¦ä¸²SDSæºç å­¦ä¹ \n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(ä¸ƒ) æ•´æ•°é›†åˆ","url":"/2022/01/20/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%83-%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88/","content":"æ¦‚å¿µæ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯ä¸€ä¸ªæœ‰åºçš„ã€å­˜å‚¨æ•´å‹æ•°æ®çš„ç»“æ„ã€‚\nå…³é”®å­—ï¼šæœ‰åºçš„ã€æ•´å‹çš„\n\n\ncondingå†³å®šäº†çš„elementçš„é•¿åº¦ï¼Œå¯¹åº”å…³ç³»å¦‚ä¸‹\n\n\nåŸºæœ¬ç»“æ„intsettypedef struct intset &#123;      //ç¼–ç     uint32_t encoding;    //å…ƒç´ ä¸ªæ•°    uint32_t length;    // æŸ”æ€§æ•°ç»„ï¼Œæ ¹æ®encoding å†³å®šå‡ ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæ•°ç»„    int8_t contents[];&#125; intset;\n\nå¯ä»¥çœ‹åˆ°åº•å±‚æ˜¯é€šè¿‡æ•°ç»„å®ç°\nåŸºæœ¬æ“ä½œæŸ¥è¯¢uint8_t intsetFind(intset *is, int64_t value) &#123;  ã€€ã€€uint8_t valenc = _intsetValueEncoding(value); //åˆ¤æ–­ç¼–ç æ–¹å¼ã€€ã€€//ç¼–ç æ–¹å¼å¦‚æœå¤§äºå½“å‰intsetçš„ç¼–ç æ–¹å¼ï¼Œç›´æ¥è¿”å›0ã€‚å¦åˆ™è°ƒç”¨intsetSearchå‡½æ•°è¿›è¡ŒæŸ¥æ‰¾ã€€ã€€return valenc &lt;= intrev32ifbe(is-&gt;encoding) &amp;&amp; intsetSearch(is,value,NULL);&#125;static uint8_t intsetSearch(intset *is, int64_t value, uint32_t *pos) &#123;      int min = 0, max = intrev32ifbe(is-&gt;length)-1, mid = -1;      int64_t cur = -1;      /*å¦‚æœintsetä¸­æ²¡æœ‰å…ƒç´ ï¼Œç›´æ¥è¿”å›0 */    if (intrev32ifbe(is-&gt;length) == 0) &#123;        if (pos) *pos = 0;      return 0;    &#125; else &#123;    /* å¦‚æœå…ƒç´ å¤§äºæœ€å¤§å€¼æˆ–è€…å°äºæœ€å°å€¼ï¼Œç›´æ¥è¿”å›0 */    if (value &gt; _intsetGet(is,max)) &#123;        if (pos) *pos = intrev32ifbe(is-&gt;length);        return 0;    &#125; else if (value &lt; _intsetGet(is,0)) &#123;      if (pos) *pos = 0;      return 0;        &#125;    &#125;    while(max &gt;= min) &#123; //äºŒåˆ†æŸ¥æ‰¾è¯¥å…ƒç´         mid = ((unsigned int)min + (unsigned int)max) &gt;&gt; 1;      cur = _intsetGet(is,mid);    if (value &gt; cur) &#123;        min = mid+1;    &#125; else if (value &lt; cur) &#123;      max = mid-1;    &#125; else &#123;      break;        &#125;    &#125;    if (value == cur) &#123; //æŸ¥æ‰¾åˆ°è¿”å›1ï¼ŒæœªæŸ¥æ‰¾åˆ°è¿”å›0        if (pos) *pos = mid;      return 1;    &#125; else &#123;      if (pos) *pos = min;      return 0;     &#125;  &#125;&#125;\n\n\nå…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å…ˆåšäº†ä¸€äº›åŸºç¡€çš„ç»“æ„åˆ¤æ–­ï¼Œå› ä¸ºæ˜¯æœ‰åºçš„å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å¿«é€ŸæŸ¥è¯¢ã€‚\n\næ€»ç»“è¿™åº”è¯¥æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªç±»å‹äº†ï¼Œå°±æ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„çš„æœ‰åºé›†åˆï¼Œå¢åˆ æ”¹æŸ¥éƒ½ä½¿ç”¨åˆ°äº†äºŒåˆ†æŸ¥æ‰¾ã€‚\nè‡´è°¢\nRedisæºç è§£æ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ\n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(ä¸‰) è·³è·ƒè¡¨","url":"/2022/01/19/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%89-%E8%B7%B3%E8%B7%83%E8%A1%A8/","content":"æ¦‚å¿µè·³è·ƒè¡¨ç±»ä¼¼ä¸€ä¸ªå¤šå±‚çš„é“¾è¡¨ï¼Œé¦–å…ˆä»æœ€é«˜å±‚å¼€å§‹æŸ¥æ‰¾ï¼Œå¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å€¼å¤§äºè¦æŸ¥æ‰¾çš„å€¼æˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnull,åˆ™å¾€ä¸‹ä¸€å±‚æŸ¥æ‰¾ã€‚é€šè¿‡ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œå°†æ—¶é—´å¤æ‚åº¦æ§åˆ¶åœ¨O(logn)ã€‚\nå›¾ä¾‹\nä¾‹å¦‚æŸ¥æ‰¾51è¿™ä¸ªæ•°\né¦–å…ˆä»ç¬¬ä¸€å±‚å¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œå‘ç°åé¢ä¸ºnullã€‚\nä»ç¬¬äºŒå±‚æŸ¥æ‰¾ æŸ¥æ‰¾åˆ°ç¬¬å››ä¸ªèŠ‚ç‚¹ï¼Œå‘ç°åé¢çš„èŠ‚ç‚¹ä¸º61ï¼Œå¤§äºå½“å‰çš„æ•°ã€‚\nä»ç¬¬ä¸‰å±‚æŸ¥æ‰¾ æŸ¥æ‰¾åˆ°ç¬¬å…­ä¸ªèŠ‚ç‚¹ ç»“æŸ ä¸€å…±æŸ¥æ‰¾å››æ¬¡ï¼Œæ¯”éå†ä¸€æ¬¡å°‘äº†ä¸¤æ¬¡ã€‚æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ€§èƒ½ä¼šæå‡çš„å¾ˆæ˜æ˜¾ã€‚\næ ¸å¿ƒæ¦‚å¿µ\nè¡¨å¤´ï¼šè´Ÿè´£ç»´æŠ¤è·³è·ƒè¡¨çš„èŠ‚ç‚¹æŒ‡é’ˆã€‚\nè·³è·ƒè¡¨èŠ‚ç‚¹ï¼šä¿å­˜ç€å…ƒç´ å€¼ï¼Œä»¥åŠå¤šä¸ªå±‚ã€‚\nå±‚ï¼šä¿å­˜ç€æŒ‡å‘å…¶ä»–å…ƒç´ çš„æŒ‡é’ˆã€‚é«˜å±‚çš„æŒ‡é’ˆè¶Šè¿‡çš„å…ƒç´ æ•°é‡å¤§äºç­‰äºä½å±‚çš„æŒ‡é’ˆï¼Œä¸ºäº†æé«˜æŸ¥æ‰¾çš„æ•ˆç‡ï¼Œç¨‹åºæ€»æ˜¯ä»é«˜å±‚å…ˆå¼€å§‹è®¿é—®ï¼Œç„¶åéšç€å…ƒç´ å€¼èŒƒå›´çš„ç¼©å°ï¼Œæ…¢æ…¢é™ä½å±‚æ¬¡ã€‚\nè¡¨å°¾ï¼šå…¨éƒ¨ç”± NULL ç»„æˆï¼Œè¡¨ç¤ºè·³è·ƒè¡¨çš„æœ«å°¾ã€‚\n\nåŸºæœ¬ç»“æ„zskiplistNodetypedef struct zskiplistNode &#123;    // å†…å®¹    sds ele;    // åˆ†å€¼    double score;    // åé€€æŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹åº•å±‚ å‰ä¸€ä¸ªèŠ‚ç‚¹    struct zskiplistNode *backward;    struct zskiplistLevel &#123;        struct zskiplistNode *forward; // æŒ‡å‘å½“å‰å±‚çš„å‰ä¸€ä¸ªèŠ‚ç‚¹        unsigned long span;\t\t// forward æŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸å½“å‰èŠ‚ç‚¹çš„é—´è·    &#125; level[]; // levelæ˜¯ä¸€ä¸ªæ•°ç»„&#125; zskiplistNode;\n\nzskiplisttypedef struct zskiplist &#123;      struct zskiplistNode *header, *tail; // åˆ†åˆ«æŒ‡å‘å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹    unsigned long length; // è·³è·ƒè¡¨æ€»é•¿åº¦    int level; // è·³è·ƒè¡¨æ€»é«˜åº¦&#125; zskiplist;\n\n\nå…¶ä¸­ï¼Œå¤´èŠ‚ç‚¹æ˜¯è·³è·ƒè¡¨çš„ä¸€ä¸ªç‰¹æ®ŠèŠ‚ç‚¹ï¼Œå®ƒçš„levelæ•°ç»„å…ƒç´ ä¸ªæ•°ä¸º64ã€‚å¤´èŠ‚ç‚¹åœ¨æœ‰åºé›†åˆä¸­ä¸å­˜å‚¨ä»»ä½•memberå’Œscoreå€¼ï¼Œeleå€¼ä¸ºNULL, scoreå€¼ä¸º0ï¼›ä¹Ÿä¸è®¡å…¥è·³è·ƒè¡¨çš„æ€»é•¿åº¦ã€‚å¤´èŠ‚ç‚¹åœ¨åˆå§‹åŒ–æ—¶ï¼Œ64ä¸ªå…ƒç´ çš„forwardéƒ½æŒ‡å‘NULL, spanå€¼éƒ½ä¸º0ã€‚\n\nåˆ›å»ºè·³è·ƒè¡¨zslCreatezskiplist *zslCreate(void) &#123;    int j;    zskiplist *zsl;    zsl = zmalloc(sizeof(*zsl)); // ç”³è¯·å†…å­˜    zsl-&gt;level = 1; // åˆåˆ›å»º çº§æ•°ä¸º1    zsl-&gt;length = 0; // åˆåˆ›å»º é•¿åº¦ä¸º1    zsl-&gt;header = zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL); // åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„å¤´ç»“ç‚¹    // æ­¤å¤„å¾ªç¯äº†32æ¬¡    for (j = 0; j &lt; ZSKIPLIST_MAXLEVEL; j++) &#123;        zsl-&gt;header-&gt;level[j].forward = NULL;        zsl-&gt;header-&gt;level[j].span = 0;    &#125;    zsl-&gt;header-&gt;backward = NULL;    zsl-&gt;tail = NULL;    return zsl;&#125;\n\n\nZSKIPLIST_MAXLEVEL è·³è·ƒè¡¨æœ€å¤§ç­‰çº§(é»˜è®¤å€¼ä¸º32)ï¼Œå¯ä»¥å®¹çº³2^64ä¸ªå…ƒç´ \nä¸ºè·³è·ƒè¡¨åˆ›å»ºäº†ä¸€ä¸ªåˆå§‹çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶è®¾ç½®äº†ä¸€ä¸ª32å±‚é«˜çš„ç´¢å¼•\n\nåˆ›å»ºè¡¨èŠ‚ç‚¹zslCreateNode/* Create a skiplist node with the specified number of levels. * The SDS string &#x27;ele&#x27; is referenced by the node after the call. */zskiplistNode *zslCreateNode(int level, double score, sds ele) &#123;    zskiplistNode *zn =        zmalloc(sizeof(*zn)+level*sizeof(struct zskiplistLevel));    zn-&gt;score = score;    zn-&gt;ele = ele;    return zn;&#125;\n\n\nåˆæ˜¯å…ˆåˆ›å»ºèŠ‚ç‚¹å†èµ‹å€¼\n\néšæœºå±‚é«˜zslRandomLevelint zslRandomLevel(void) &#123;    int level = 1;    while ((random()&amp;0xFFFF) &lt; (ZSKIPLIST_P * 0xFFFF))        level += 1;    return (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;&#125;\n\nåœ¨é¦–èŠ‚ç‚¹ç›´æ¥æ‹‰æ»¡è®¾ç½®äº†ä¸€ä¸ªå±‚é«˜çš„æœ€å¤§å€¼32ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸€ä¸ªå…ƒç´ çš„å±‚é«˜éƒ½æ˜¯32è·³è·ƒè¡¨ä¹Ÿå°±æ²¡æ„ä¹‰äº†ã€‚è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç¡®å®šèŠ‚ç‚¹çš„å±‚é«˜ï¼Œè¿”å›ä¸€ä¸ª1 ~ ZSKIPLIST_MAXLEVEL çš„æ•°ã€‚\næ’å…¥èŠ‚ç‚¹æ’å…¥èŠ‚ç‚¹æ€»çš„æ¥è¯´ä¸€å…±å››æ­¥\n\næŸ¥æ‰¾æ’å…¥ä½ç½®\nè°ƒæ•´é«˜åº¦\næ’å…¥èŠ‚ç‚¹\nè°ƒæ•´ backward\n\nzslInsertzskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) &#123;      zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;    unsigned int rank[ZSKIPLIST_MAXLEVEL];    int i, level;    serverAssert(!isnan(score));    // æŸ¥æ‰¾èŠ‚ç‚¹    x = zsl-&gt;header;    for (i = zsl-&gt;level-1; i &gt;= 0; i--) &#123;        /* store rank that is crossed to reach the insert position */        rank[i] = i == (zsl-&gt;level-1) ? 0 : rank[i+1];        while (x-&gt;level[i].forward &amp;&amp;                (x-&gt;level[i].forward-&gt;score &lt; score ||                    (x-&gt;level[i].forward-&gt;score == score &amp;&amp;                    sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; 0)))        &#123;            rank[i] += x-&gt;level[i].span;            x = x-&gt;level[i].forward;        &#125;        update[i] = x;    &#125;      // éšæœºä¸€ä¸ªå±‚æ•°    level = zslRandomLevel();    if (level &gt; zsl-&gt;level) &#123;        for (i = zsl-&gt;level; i &lt; level; i++) &#123;            rank[i] = 0;            update[i] = zsl-&gt;header;            update[i]-&gt;level[i].span = zsl-&gt;length;        &#125;        zsl-&gt;level = level;    &#125;    x = zslCreateNode(level,score,ele);    //æ’å…¥èŠ‚ç‚¹    for (i = 0; i &lt; level; i++) &#123;        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;        update[i]-&gt;level[i].forward = x;        /* update span covered by update[i] as x is inserted here */        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[0] - rank[i]);        update[i]-&gt;level[i].span = (rank[0] - rank[i]) + 1;    &#125;    /* increment span for untouched levels */    for (i = level; i &lt; zsl-&gt;level; i++) &#123;        update[i]-&gt;level[i].span++;    &#125;    x-&gt;backward = (update[0] == zsl-&gt;header) ? NULL : update[0];    if (x-&gt;level[0].forward)        x-&gt;level[0].forward-&gt;backward = x;    else        zsl-&gt;tail = x;    zsl-&gt;length++;    return x;&#125;\n\nåˆ é™¤èŠ‚ç‚¹\nåˆ é™¤ç›¸æ¯”è¾ƒä¼šç®€å•ä¸€äº›ï¼Œå¦‚æœæ’å…¥æˆ–è€…æŸ¥è¯¢æ—¶éœ€è¦å…ˆæŸ¥åˆ°åˆ é™¤èŠ‚ç‚¹çš„ä½ç½®ã€‚\nåˆ é™¤èŠ‚ç‚¹ï¼ˆå…¶å®å°±æ˜¯ä¸€ä¸ªé“¾è¡¨åˆ é™¤å…ƒç´ ï¼‰\næ˜¯å¦ä¸ºå”¯ä¸€çš„é«˜èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ–° level,ä¸æ˜¯åˆ™æ— éœ€é¢å¤–å¤„ç†\n\nå…¶ä»–ä¸ºä»€ä¹ˆä¸ä½¿ç”¨çº¢é»‘æ ‘å¼•ç”¨ä¸€ä¸‹åŸä½œè€…çš„è¯\n\nThere are a few reasons: They are not very memory intensive. Itâ€™s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.About the Append Only durability &amp; speed, I donâ€™t think it is a good idea to optimize Redis at cost of more code and more complexity for a use case that IMHO should be rare for the Redis target (fsync() at every command). Almost no one is using this feature even with ACID SQL databases, as the performance hint is big anyway.About threads: our experience shows that Redis is mostly I/O bound. Iâ€™m using threads to serve things from Virtual Memory. The long term solution to exploit all the cores, assuming your link is so fast that you can saturate a single core, is running multiple instances of Redis (no locks, almost fully scalable linearly with number of cores), and using the â€œRedis Clusterâ€ solution that I plan to develop in the future.\n\n\nç®€å•æ€»ç»“ä¸€ä¸‹ï¼š\nè¿™å¹¶ä¸ä¼šæµªè´¹å¤ªå¤šçš„ç©ºé—´ï¼Œå¹¶ä¸”æ ‘çš„é«˜åº¦å¯ä»¥åŠ¨æ€è°ƒæ•´çš„ã€‚\nZRANGE å’Œ ZREVRANGEå‘½ä»¤ï¼Œè·³è¡¨æ€§èƒ½æ¯”çº¢é»‘æ ‘å¥½\nçº¢é»‘æ ‘æ¯”è¾ƒå¤æ‚â€¦ä½œè€…æ‡’å¾—å®ç°\n\n\n\næ€»ç»“\nRedisä½¿ç”¨è·³è·ƒè¡¨ç»“æ„å­˜å‚¨æœ‰åºé›†åˆæ•°æ®,é€šè¿‡æ¦‚ç‡å¹³è¡¡å®ç°è¿‘ä¼¼å¹³è¡¡på‰ä¹¦çš„å­˜å–æ•ˆç‡ã€‚\n\nè‡´è°¢\nRedisæºç è§£æ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ\nRedis è®¾è®¡ä¸å®ç°\n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(äºŒ) å­—å…¸","url":"/2022/01/19/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%BA%8C-%E5%AD%97%E5%85%B8/","content":"å¯¹æ¯”HashMapå­—å…¸çš„ä½¿ç”¨å’Œåº•å±‚ä¸Javaä¸­çš„HashMapè¿˜æ˜¯å¾ˆåƒçš„ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„å°±æ˜¯æ‰©å®¹æ–¹å¼ã€‚\nåŸºæœ¬ç»“æ„\ndicttypedef struct dict &#123;    // æ“ä½œç±»å‹    dictType *type;      // ä¾èµ–çš„æ•°æ®    void *privdata;\t     // Hashè¡¨,æ˜¯ä¸ªæ•°ç»„ä¸¤ä¸ªå…ƒç´     dictht ht[2];    // -1ä»£è¡¨æ²¡æœ‰è¿›è¡Œrehashå€¼ï¼Œå¦åˆ™ä»£è¡¨hashæ“ä½œè¿›è¡Œåˆ°äº†å“ªä¸ªç´¢å¼•    long rehashidx; /* rehashing not in progress if rehashidx == -1 */    // å½“å‰è¿è¡Œçš„è¿­ä»£å™¨æ•°    int16_t pauserehash; /* If &gt;0 rehashing is paused (&lt;0 indicates coding error) */&#125; dict;\n\ndicthttypedef struct dictht &#123;      // äºŒç»´æ•°ç»„    dictEntry **table;    // tableæ€»å¤§å°    unsigned long size;    // æ©ç =size-1    unsigned long sizemask;    // å·²ç»ä¿å­˜çš„é”®å€¼å¯¹    unsigned long used;&#125; dictht;\n\ndictEntrytypedef struct dictEntry &#123;      //é”®    void *key;    //å€¼    union &#123;        void *val; //å€¼        uint64_t u64;        int64_t s64; //è¿‡æœŸæ—¶é—´        double d;    &#125; v;    // hashå†²çªçš„nextæŒ‡é’ˆ    struct dictEntry *next;&#125; dictEntry;\n\nå¦‚ä½•åº”å¯¹Hashå†²çªæ—¢ç„¶ä½¿ç”¨äº†Hashè¡¨ï¼Œå°±é€ƒä¸æ‰Hashå†²çªçš„é—®é¢˜ã€‚\nJavaä¸­çš„è§£å†³æ–¹å¼\nHashMap ä½¿ç”¨äº†æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„åº•å±‚ç»“æ„ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡éƒ½ä¼šæœ‰ nextå±æ€§ï¼Œä»è€Œå½¢æˆä¸€ä¸ªé“¾è¡¨ç»“æ„ã€‚å½“é“¾è¡¨é•¿åº¦å¤§äº8æ—¶ä¼šå‡çº§ä¸ºçº¢é»‘æ ‘ã€‚\n\nstatic class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; &#123;    final int hash;    final K key;    V value;    Node&lt;K,V&gt; next;    Node(int hash, K key, V value, Node&lt;K,V&gt; next) &#123;        this.hash = hash;        this.key = key;        this.value = value;        this.next = next;    &#125;\n\nå…¶å®è¿™å«æ‹‰é“¾æ³•æˆ–è€…å«é“¾åœ°å€æ³•\næ‹‰é“¾æ³•\næŠŠå…·æœ‰ç›¸åŒæ•£åˆ—åœ°å€çš„å…³é”®å­—(åŒä¹‰è¯)å€¼æ”¾åœ¨åŒä¸€ä¸ªå•é“¾è¡¨ä¸­ï¼Œç§°ä¸ºåŒä¹‰è¯é“¾è¡¨ã€‚\n\næ·»åŠ å…ƒç´ dictAdd/* Add an element to the target hash table */int dictAdd(dict *d, void *key, void *val)&#123;    // æ–°å¢å…ƒç´ ,ä½†æ˜¯æ²¡æœ‰è®¾ç½®å…·ä½“çš„å€¼    dictEntry *entry = dictAddRaw(d,key,NULL);\t// æ–°å¢å¤±è´¥åˆ™è¿”å›å¼‚å¸¸    if (!entry) return DICT_ERR;    // è®¾ç½®çœŸå®å€¼    dictSetVal(d, entry, val);    return DICT_OK;&#125;\n\ndictAddRawdictEntry *dictAddRaw(dict *d, void *key, dictEntry **existing)&#123;    long index;    dictEntry *entry;    dictht *ht;    // è¯¥å­—å…¸æ˜¯å¦åœ¨è¿›è¡Œ rehash æ“ä½œï¼Œæ˜¯åˆ™æ‰§è¡Œä¸€æ¬¡ rehash    if (dictIsRehashing(d)) _dictRehashStep(d);    // æŸ¥è¯¢æŸä¸ªKeyçš„ç´¢å¼•ä¸‹æ ‡,å…¶å®å°±æ˜¯æŸ¥è¯¢è¯¥keyæ˜¯å¦å­˜åœ¨    // å·²å­˜åœ¨è¿”å›-1    if ((index = _dictKeyIndex(d, key, dictHashKey(d,key), existing)) == -1)        return NULL; \t// æ˜¯å¦åœ¨è¿›è¡Œ rehash æ“ä½œä¸­ï¼Œæ˜¯åˆ™æ’å…¥è‡³æ•£åˆ—è¡¨ ht[1] ä¸­ï¼Œå¦åˆ™æ’å…¥æ•£åˆ—è¡¨ ht[0]     ht = dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0];    entry = zmalloc(sizeof(*entry)); // ç”³è¯·æ–°èŠ‚ç‚¹å†…å­˜    entry-&gt;next = ht-&gt;table[index]; // å°†è¯¥èŠ‚ç‚¹çš„ next æŒ‡é’ˆæŒ‡å‘ ht-&gt;table[index] æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®    ht-&gt;table[index] = entry; // å°† ht-&gt;table[index] æŒ‡é’ˆæŒ‡å‘è¯¥èŠ‚ç‚¹    ht-&gt;used++;    /* Set the hash entry fields. */    dictSetKey(d, entry, key);    return entry;&#125;\n\nå…¶ä¸­çš„ rehash ä¼šåœ¨æ‰©å®¹ä¸­è®²è¿°ã€‚\næœ€å…³é”®çš„ä¸€ä¸ªç‚¹ï¼šht = dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0];ã€‚åœ¨è¿›è¡Œ rehashæ”¾å…¥ ht[1]åä¹‹åˆ™ ht[0]\næŸ¥è¯¢æ“ä½œdictFetchValuevoid *dictFetchValue(dict *d, const void *key) &#123;    dictEntry *he;    // å…³é”®åœ¨è¿™ä¸€æ­¥,æŸ¥è¯¢å¯¹åº”keyæ‰€åœ¨çš„èŠ‚ç‚¹    he = dictFind(d,key);    // æ ¹æ®èŠ‚ç‚¹æŸ¥è¯¢é‡Œé¢çš„value,å¦åˆ™è¿”å›NULL    return he ? dictGetVal(he) : NULL;&#125;\n\ndictFinddictEntry *dictFind(dict *d, const void *key)&#123;    dictEntry *he;    uint64_t h, idx, table;    // ä¸ºç©º    if (dictSize(d) == 0) return NULL; /* dict is empty */    // è¯¥å­—å…¸æ˜¯å¦åœ¨è¿›è¡Œ rehash æ“ä½œï¼Œæ˜¯åˆ™æ‰§è¡Œä¸€æ¬¡ rehash    if (dictIsRehashing(d)) _dictRehashStep(d);    // æ ¹æ®å­—å…¸çš„hashå‡½æ•°å¾—åˆ°keyçš„hashå€¼    h = dictHashKey(d, key);    // å¾ªç¯ä¸¤æ¬¡,åˆ†åˆ«åœ¨ht[0]å’Œht[1]ä¸­æŸ¥æ‰¾    for (table = 0; table &lt;= 1; table++) &#123;        // æ ¹æ®hashå€¼ä¸æ©ç å–tableä¸­çš„ä¸‹æ ‡        idx = h &amp; d-&gt;ht[table].sizemask;        // è·å–åˆ°å¯¹åº”Entity        he = d-&gt;ht[table].table[idx];        // å¦‚æœå‡ºç°äº†hashå†²çªä¼šé€ä¸ªéå†é“¾è¡¨        while(he) &#123;            // åˆ¤æ–­keyå€¼æ˜¯ä¸æ˜¯è¦æŸ¥è¯¢çš„ç›®æ ‡å€¼            if (key==he-&gt;key || dictCompareKeys(d, key, he-&gt;key))                return he;            // éå†ä¸‹ä¸€ä¸ªå…ƒç´             he = he-&gt;next;        &#125;        if (!dictIsRehashing(d)) return NULL;    &#125;    return NULL;&#125;\n\nå‡ ä¸ªå…³é”®ç‚¹ï¼š\n\nidx = h &amp; d-&gt;ht[table].sizemask; ï¼šåœ¨æ—¥å¸¸å¼€å‘ä¸­è¿™ç§åœºæ™¯æˆ‘ä»¬æ›´å–œæ¬¢ä½¿ç”¨å–ä½™ï¼ˆ%ï¼‰ï¼Œå› ä¸ºå¿«ã€æ–¹ä¾¿ï¼›åœ¨HashMapä¸­ä½¿ç”¨çš„å°±æ˜¯å–ä½™ï¼Œä½†æ˜¯é™åˆ¶äº†æ•°ç»„é•¿åº¦ä¸º2çš„å¹‚+ä½è¿ç®—å¿«é€Ÿå–ä½™ï¼›åœ¨Redisä¸­åˆ™æ˜¯ä½¿ç”¨äº†æ©ç è¿›è¡Œ &amp;è¿ç®—\n\ndictGetVal#define dictGetVal(he) ((he)-&gt;v.val)\n\næ‰©å®¹æ“ä½œå…¶å®åœ¨å‰é¢çš„æ“ä½œä¸­å·²ç»çœ‹åˆ°äº†ä¸€äº›å…³äºæ‰©å®¹çš„å½±å­ï¼Œä¾‹å¦‚ä»€ä¹ˆæ˜¯ rehashï¼Ÿä¸ºä»€ä¹ˆè¦æœ‰ ht[1]å’Œ ht[2]\nå…¶å®è¿™äº›éƒ½æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªæœºåˆ¶â€”â€”æ¸è¿›å¼æ‰©å®¹ã€‚\nä»€ä¹ˆæ˜¯æ¸è¿›å¼æ‰©å®¹å°±å¥½åƒä¸€å£åƒä¸æˆèƒ–å­ï¼Œä¸€å£æ°”åƒå¤ªå¤šåƒå¤ªå¿«å¯¹èƒƒä¸å¥½ï¼Œè¦æ…¢æ…¢åƒæ…¢æ…¢é•¿èƒ–\n\nRedisä¸­Hashç±»å‹ä½¿ç”¨äº†æ¸è¿›å¼çš„æ‰©å®¹æœºåˆ¶ï¼Œå› ä¸ºé‡åˆ°å¤§Keyæ—¶ä¼šå¯¹æ€§èƒ½é€ æˆå·¨å¤§çš„å½±å“ã€‚æ‰€ä»¥åœ¨dictå¯¹è±¡ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå±æ€§ï¼šdictht ht[2] ï¼Œå­˜æ”¾äº†ä¸€ä¸ªé•¿åº¦ä¸º2çš„æ•°ç»„ã€‚\nht[0]ï¼Œæ˜¯å­˜æ”¾æ•°æ®çš„ tableï¼Œä½œä¸ºéæ‰©å®¹æ—¶å®¹å™¨ï¼›\nht[1]ï¼Œåªæœ‰æ­£åœ¨è¿›è¡Œæ‰©å®¹æ—¶æ‰ä¼šä½¿ç”¨ï¼Œå®ƒä¹Ÿæ˜¯å­˜æ”¾æ•°æ®çš„tableï¼Œé•¿åº¦ä¸º ht[0]çš„ä¸¤å€ã€‚\næ‰©å®¹æ—¶ï¼Œå•çº¿ç¨‹Aè´Ÿè´£æŠŠæ•°æ®ä» ht[0] å¤åˆ¶åˆ° ht[1] ä¸­ã€‚å¦‚æœè¿™æ—¶æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œè¯»æ“ä½œï¼šä¼šå…ˆå» ht[0]ä¸­æ‰¾ï¼Œæ‰¾ä¸åˆ°å†å» ht[1]ä¸­æ‰¾ã€‚è¿›è¡Œå†™æ“ä½œï¼šç›´æ¥å†™åœ¨ ht[1]ä¸­ã€‚è¿›è¡Œåˆ é™¤æ“ä½œï¼šä¸è¯»ç±»ä¼¼ã€‚\n\næ‰©å®¹æµç¨‹\nint _dictExpand(dict *d, unsigned long size, int* malloc_failed)&#123;    if (malloc_failed) *malloc_failed = 0;    //  å¦‚æœæ­¤æ—¶æ­£åœ¨æ‰©å®¹ï¼Œæˆ–è€…æ˜¯æ‰©å®¹å¤§å°å°äº ht[0] çš„è¡¨å¤§å°ï¼Œåˆ™æŠ›é”™    if (dictIsRehashing(d) || d-&gt;ht[0].used &gt; size)        return DICT_ERR;    dictht n;  // newäº†ä¸€ä¸ªæ–°çš„hashè¡¨    unsigned long realsize = _dictNextPower(size);    // æ˜¯å¦å­˜åœ¨æº¢å‡ºå¯èƒ½    if (realsize &lt; size || realsize * sizeof(dictEntry*) &lt; realsize)        return DICT_ERR;    // é‡æ–°è®¡ç®—çš„å€¼å¦‚æœå’ŒåŸæ¥çš„ size ç›¸ç­‰ï¼Œåˆ™æ— æ•ˆ    if (realsize == d-&gt;ht[0].size) return DICT_ERR;    // åˆ†é…æ–° Hash è¡¨ï¼Œå¹¶åˆå§‹åŒ–æ‰€æœ‰æŒ‡é’ˆä¸º NULL    n.size = realsize;    n.sizemask = realsize-1;    if (malloc_failed) &#123;        n.table = ztrycalloc(realsize*sizeof(dictEntry*));        *malloc_failed = n.table == NULL;        if (*malloc_failed)            return DICT_ERR;    &#125; else        n.table = zcalloc(realsize*sizeof(dictEntry*));    n.used = 0;    // åˆå§‹åŒ–çš„æƒ…å†µï¼Œè€Œä¸æ˜¯è¿›è¡Œ rehash æ“ä½œï¼Œå°±ç”¨ ht[0] æ¥æ¥æ”¶å€¼    if (d-&gt;ht[0].table == NULL) &#123;        // å¦‚æœæ˜¯åˆå§‹åŒ–é˜¶æ®µ,èµ‹å€¼åç›´æ¥å°±ç»“æŸäº†        d-&gt;ht[0] = n;        return DICT_OK;    &#125;    /* å‡†å¤‡ç¬¬äºŒä¸ª Hash è¡¨ï¼Œä»¥ä¾¿æ‰§è¡Œæ¸è¿›å¼å“ˆå¸Œæ“ä½œ */    d-&gt;ht[1] = n;    d-&gt;rehashidx = 0;    return DICT_OK;&#125;\n\n\nredisä¸­çš„keyå¯èƒ½æœ‰æˆåƒä¸Šä¸‡ï¼Œå¦‚æœä¸€æ¬¡æ€§æ‰©å®¹ï¼Œä¼šå¯¹æ€§èƒ½é€ æˆå·¨å¤§çš„å½±å“ï¼Œæ‰€ä»¥redisä½¿ç”¨æ¸è¿›å¼æ‰©å®¹ï¼Œæ¯æ¬¡æ‰§è¡Œæ’å…¥ï¼Œåˆ é™¤ï¼ŒæŸ¥æ‰¾ï¼Œä¿®æ”¹ç­‰æ“ä½œå‰ï¼Œéƒ½å…ˆåˆ¤æ–­å½“å‰å­—å…¸çš„rehashæ“ä½œæ˜¯å¦åœ¨è¿›è¡Œï¼Œå¦‚æœæ˜¯åœ¨è¿›è¡Œä¸­ï¼Œå°±å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œrehashæ“ä½œï¼Œåªæ‰§è¡Œä¸€æ¬¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå½“æœåŠ¡å™¨ç©ºé—²æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨incrementallyRehashå‡½æ•°è¿›è¡Œæ‰¹é‡æ“ä½œï¼Œæ¯æ¬¡100ä¸ªèŠ‚ç‚¹ï¼Œå¤§æ¦‚ä¸€æ¯«ç§’ã€‚å°†rehashæ“ä½œè¿›è¡Œåˆ†è€Œæ²»ä¹‹ã€‚\n\næ¸è¿›å¼rehashæµç¨‹rehashçš„å‡†å¤‡å·¥ä½œ\nè®¾ç½®å­—å…¸çš„ rehashidx ä¸º 0 ï¼Œæ ‡è¯†ç€ rehash çš„å¼€å§‹ï¼›\nä¸º ht[1]-&gt;table åˆ†é…ç©ºé—´ï¼Œå¤§å°è‡³å°‘ä¸º ht[0]-&gt;used çš„ä¸¤å€ï¼›\n\ndictRehashint dictRehash(dict *d, int n) &#123;    // ä¸€æ¬¡æœ€å¤šrehash n*10ä¸ªç©ºæ¡¶ nçš„å¤§å°æ ¹æ®è§¦å‘åœºæ™¯è€Œå®š    // åœ¨æ·»åŠ æ–°çš„å…ƒç´ æ—¶ä¹Ÿä¼šè§¦å‘Rehashæ“ä½œ _dictRehashStep n=1,ä¸€æ¬¡æœ€å¤šrehash10ä¸ªç©ºæ¡¶    // dictRehashMilliseconds åœ¨ç»™å®šæ¯«ç§’å†…ï¼Œå¯¹å­—å…¸è¿›è¡Œrehashçš„ä¸€ä¸ªæ–¹æ³•,n=100,ä¸€æ¬¡æœ€å¤š1000ä¸ªç©ºæ¡¶    int empty_visits = n*10;     // å¦‚æœä¸åœ¨Rehashåˆ™è¿”å›0    if (!dictIsRehashing(d)) return 0;\t// å¼€å§‹å¾ªç¯ï¼Œæ‰§è¡Œ    while(n-- &amp;&amp; d-&gt;ht[0].used != 0) &#123;        dictEntry *de, *nextde;        // ä¸ºé˜²æ­¢ rehashidx è¶Šç•Œï¼Œå½“ rehashidx å¤§äº ht[0] çš„æ•°ç»„å¤§å°æ—¶ï¼Œä¸ç»§ç»­æ‰§è¡Œ         assert(d-&gt;ht[0].size &gt; (unsigned long)d-&gt;rehashidx);        // d-&gt;rehashidx æ˜¯è®°å½•ç€ä¸Šä¸€æ¬¡rehashè¿›è¡Œåˆ°äº†å“ªä¸€ä¸ªç´¢å¼•        // ä¸€ç›´å¾€ä¸‹éå†,ç›´åˆ°é‡åˆ°ä¸æ˜¯ç©ºæ¡¶çš„å°±ç»“æŸ(å‰ææ˜¯æ²¡æœ‰å› ä¸ºç©ºæ¡¶æ•°è€Œç»ˆæ­¢)        while(d-&gt;ht[0].table[d-&gt;rehashidx] == NULL) &#123;            // å¦‚æœä¸ºç©ºè¡¨ç¤ºå½“å‰ç´¢å¼•rehashæˆåŠŸ +1            // å¹¶ä¸”ç©ºæ¡¶æ•°+1            d-&gt;rehashidx++;            if (--empty_visits == 0) return 1;        &#125;        // è¿™ä¸ªæ¡¶ä¸€å®šæ˜¯æœ‰æ•°æ®çš„        de = d-&gt;ht[0].table[d-&gt;rehashidx];        // éå†æ¡¶ä¸­å…ƒç´ ï¼Œç§»åŠ¨å…ƒç´ è‡³æ–°è¡¨        while(de) &#123;            uint64_t h;            nextde = de-&gt;next;            // è·å–åœ¨æ–°æ¡¶æ—¶çš„ä¸‹æ ‡            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[1].sizemask;            // æ­¤å¤„ä½¿ç”¨äº†å¤´æ’æ³•            de-&gt;next = d-&gt;ht[1].table[h];             d-&gt;ht[1].table[h] = de;             d-&gt;ht[0].used--;            d-&gt;ht[1].used++;            de = nextde;        &#125;        // å¤„ç†å®Œæˆ è®¾ç½®ä¸ºç©º        d-&gt;ht[0].table[d-&gt;rehashidx] = NULL;        d-&gt;rehashidx++;    &#125;    // æ£€æŸ¥æ˜¯å¦å·²ç» rehash å®Œæˆ    if (d-&gt;ht[0].used == 0) &#123;        zfree(d-&gt;ht[0].table);        d-&gt;ht[0] = d-&gt;ht[1];        _dictReset(&amp;d-&gt;ht[1]);        d-&gt;rehashidx = -1;        return 0;    &#125;    /* More to rehash... */    return 1;&#125;\n\n\né¦–å…ˆæ¢³ç† dictRehashæ–¹æ³•ï¼ŒNå’ŒN*10çš„å…³ç³»ã€‚\n\nä¸€æ¬¡ dictRehashæ–¹æ³•æœ€å¤šè¿ç§»Nä¸ªæ¡¶ã€‚\nä½†æ˜¯æ¯æ¬¡ dictRehashä¸ä¸€å®šéƒ½æ˜¯éœ€è¦è¿ç§»çš„ï¼Œå¯èƒ½æœ‰äº›æ¡¶çš„æ•°æ®ä¸ºNULLï¼Œé‡åˆ°N*10æ¬¡ç©ºæ¡¶åˆ™ç»“æŸï¼ˆä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿä¸èƒ½æ— ä¼‘æ­¢çš„è®©ä»–éå†ä¸‹å»ï¼Œé˜²æ­¢è¿‡ä¹…çš„é˜»å¡ï¼‰\n\n\nå…³äºå¤´æ’æ³•\n\nde-&gt;next = d-&gt;ht[1].table[h]; é¦–å…ˆå°† ht1ä¸­çš„deå¯¹è±¡çš„å°¾èŠ‚ç‚¹\nå†å°†deå¯¹è±¡è®¾ç½®åˆ° d-&gt;ht[1].table[h]\n\n\n\næ€»ç»“\nRedis ä¸­çš„æ•°æ®åº“å’Œå“ˆå¸Œé”®éƒ½åŸºäºå­—å…¸æ¥å®ç°ã€‚\n\nå­—å…¸æ˜¯ç”±é”®å€¼å¯¹æ„æˆçš„æŠ½è±¡æ•°æ®ç»“æ„ã€‚\n\nRedisè‡ªå·±å®ç°äº†ä¸€å¥—å“ˆå¸Œè¡¨çš„é€»è¾‘ï¼Œä¸Javaä¸­çš„HashMapç›¸ä¼¼ä½†æ˜¯ä¸å®Œå…¨ä¸€æ ·ï¼Œæ‹¿ä¸¤è€…æ¯”è¾ƒçš„æ€»ç»“ä¸€ä¸‹ã€‚\n\nä¸¤è€…éƒ½é€šè¿‡æ‹‰é“¾æ³•è§£å†³äº†Hashå†²çªé—®é¢˜ï¼Œåªä¸è¿‡HashMapæœ‰å‡çº§çº¢é»‘æ ‘çš„æœºåˆ¶ï¼ŒRedisæ²¡æœ‰\nRediså®ç°äº†é€æ¸å¼æ‰©å®¹ï¼Œä¸ä¼šä¸€ä¸‹å­æŠŠæ‰€æœ‰Keyè¿›è¡Œè¿ç§»ï¼ˆé‡åˆ°å¤§Keyå¯èƒ½å‡ºç°å¼‚å¸¸ï¼‰ï¼›HashMapå°±æ˜¯æ™®é€šçš„è¿ç§»ã€‚\né€æ¸å¼æ‰©å®¹ä½¿Redisåº•å±‚éœ€è¦ä½¿ç”¨åˆ°ä¸¤ä¸ªHashè¡¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªä½¿ç”¨ 0 å·å“ˆå¸Œè¡¨ï¼Œåªæœ‰åœ¨ rehash è¿›è¡Œæ—¶ï¼Œæ‰ä¼šåŒæ—¶ä½¿ç”¨ 0 å·å’Œ 1 å·å“ˆå¸Œè¡¨ã€‚\n\n\nHashMapé€šè¿‡æŒ‡å®šè§„åˆ™ï¼šæ•°ç»„é•¿åº¦ä¸º2çš„å¹‚+ä½è¿ç®—è¿›è¡Œå–æ•°ç»„ä¸‹æ ‡ï¼›Redisä½¿ç”¨æ©ç çš„æ–¹å¼ã€‚\nHashMapåœ¨1.8ä¹‹å‰ä¸ºå¤´æ’æ³•ï¼Œä¹‹åä¸ºå°¾æ’æ³•ï¼›Redisä¸­ä¸€ç›´ä¸ºå¤´æ’æ³•ã€‚\n\n\n\nè‡´è°¢\nRedisæºç è§£æ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ\nRedis è®¾è®¡ä¸å®ç°\n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(äº”) åŒå‘é“¾è¡¨","url":"/2022/01/19/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%BA%94-%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8/","content":"å‰è¨€åœ¨Redis3.2ç‰ˆæœ¬ä¹‹å‰ï¼ŒList ç±»å‹çš„å®ç°æ˜¯ç”±ï¼šå‹ç¼©åˆ—è¡¨+åŒå‘é“¾è¡¨å®ç°çš„ï¼Œåœ¨3.2ç‰ˆæœ¬ä¹‹åå–ç¼”äº†åŒå‘é“¾è¡¨ã€‚\nå–ç¼”çš„åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨å‹ç¼©åˆ—è¡¨ä¸­æœ‰è®²åˆ°ã€‚\nåŸºæœ¬ç»“æ„å…¶å®åŒå‘é“¾è¡¨è¿˜æ˜¯å¾ˆå¸¸è§çš„ï¼Œä¹Ÿæ²¡ä»€ä¹ˆä¸åŒå°±æ˜¯é¦–å°¾ç›¸æ¥çš„ä¸€ä¸ªä¸ªèŠ‚ç‚¹ã€‚\nlistNodetypedef struct listNode &#123;    // å‰é©±èŠ‚ç‚¹    struct listNode *prev;    // åç»§èŠ‚ç‚¹    struct listNode *next;    // å€¼    void *value;&#125; listNode;\n\nlisttypedef struct list &#123;    // è¡¨å¤´æŒ‡é’ˆ    listNode *head;    // è¡¨å°¾æŒ‡é’ˆ    listNode *tail;    // èŠ‚ç‚¹æ•°é‡    unsigned long len;    // å¤åˆ¶å‡½æ•°    void *(*dup)(void *ptr);    // é‡Šæ”¾å‡½æ•°    void (*free)(void *ptr);    // æ¯”å¯¹å‡½æ•°    int (*match)(void *ptr, void *key);&#125; list;\n\nä¼˜åŠ£åˆ†æ\nåŒå‘é“¾è¡¨linkedlistä¾¿äºåœ¨è¡¨çš„ä¸¤ç«¯è¿›è¡Œpushå’Œpopæ“ä½œï¼Œåœ¨æ’å…¥èŠ‚ç‚¹ä¸Šå¤æ‚åº¦å¾ˆä½ï¼Œä½†æ˜¯å®ƒçš„å†…å­˜å¼€é”€æ¯”è¾ƒå¤§ã€‚\nå®ƒåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé™¤äº†è¦ä¿å­˜æ•°æ®ä¹‹å¤–ï¼Œè¿˜è¦é¢å¤–ä¿å­˜ä¸¤ä¸ªæŒ‡é’ˆï¼›\nåŒå‘é“¾è¡¨çš„å„ä¸ªèŠ‚ç‚¹æ˜¯å•ç‹¬çš„å†…å­˜å—ï¼Œåœ°å€ä¸è¿ç»­ï¼ŒèŠ‚ç‚¹å¤šäº†å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚\n\næ€»ç»“\nRedis å®ç°äº†è‡ªå·±çš„åŒç«¯é“¾è¡¨ç»“æ„ã€‚\nåŒç«¯é“¾è¡¨ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š\nä½œä¸º Redis åˆ—è¡¨ç±»å‹çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼ˆ3.2åå¼ƒç”¨ï¼‰\nä½œä¸ºé€šç”¨æ•°æ®ç»“æ„ï¼Œè¢«å…¶ä»–åŠŸèƒ½æ¨¡å—æ‰€ä½¿ç”¨ï¼›\n\n\nåŒç«¯é“¾è¡¨åŠå…¶èŠ‚ç‚¹çš„æ€§èƒ½ç‰¹æ€§å¦‚ä¸‹ï¼š\nèŠ‚ç‚¹å¸¦æœ‰å‰é©±å’Œåç»§æŒ‡é’ˆï¼Œè®¿é—®å‰é©±èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹çš„å¤æ‚åº¦ä¸º O(1) ï¼Œå¹¶ä¸”å¯¹é“¾è¡¨çš„è¿­ä»£å¯ä»¥åœ¨ä»è¡¨å¤´åˆ°è¡¨å°¾å’Œä»è¡¨å°¾åˆ°è¡¨å¤´ä¸¤ä¸ªæ–¹å‘è¿›è¡Œï¼›\né“¾è¡¨å¸¦æœ‰æŒ‡å‘è¡¨å¤´å’Œè¡¨å°¾çš„æŒ‡é’ˆï¼Œå› æ­¤å¯¹è¡¨å¤´å’Œè¡¨å°¾è¿›è¡Œå¤„ç†çš„å¤æ‚åº¦ä¸º O(1)ï¼›\né“¾è¡¨å¸¦æœ‰è®°å½•èŠ‚ç‚¹æ•°é‡çš„å±æ€§ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ O(1)å¤æ‚åº¦å†…è¿”å›é“¾è¡¨çš„èŠ‚ç‚¹æ•°é‡ï¼ˆé•¿åº¦ï¼‰ï¼›\n\n\n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(å…­) å¿«é€Ÿåˆ—è¡¨","url":"/2022/01/20/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E5%85%AD-%E5%BF%AB%E9%80%9F%E5%88%97%E8%A1%A8/","content":"å‰è¨€åœ¨å‰é¢åˆ†åˆ«ä»‹ç»äº†ï¼šåŒå‘é“¾è¡¨å’Œå‹ç¼©åˆ—è¡¨ï¼Œä¸¤è€…ä½œä¸ºè€ç‰ˆæœ¬ä¸­Listç±»å‹çš„åº•å±‚å®ç°ï¼Œä½†æ˜¯åœ¨3.2ç‰ˆæœ¬åè¢«æœ¬æ–‡ä¸»è§’å–ä»£ã€‚\nåŸºäºä¸¤è€…çš„ä¼˜åŠ£ï¼Œè¡ç”Ÿäº†æœ¬æ–‡çš„ä¸»è§’â€”â€”å¿«é€Ÿåˆ—è¡¨\næ¦‚å¿µquickList å®é™…ä¸Šæ˜¯ zipList å’Œ linkedList çš„æ··åˆä½“ï¼Œå®ƒå°† linkedList æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ zipList æ¥ç´§å‡‘å­˜å‚¨ï¼Œå¤šä¸ª zipList ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥ã€‚\nç®€å•æ¥è¯´ï¼šå°†å¤šä¸ªå‹ç¼©åˆ—è¡¨ç»„æˆä¸€ä¸ªé“¾è¡¨å°±æ˜¯å¿«é€Ÿåˆ—è¡¨äº†ã€‚\nä¸ºä»€ä¹ˆè¿™ä¹ˆåšzipList å®ç°æ˜¯åŸºäºæ•°ç»„ï¼Œç›¸æ¯”è¾ƒåŒå‘é“¾è¡¨æœ€å¤§çš„æå‡å°±æ˜¯å‡å°‘äº†å†…å­˜çš„ç¢ç‰‡ï¼Œè¿™ç‚¹å¯¹äºä¸€ä¸ªåŸºäºå†…å­˜çš„é«˜æ€§èƒ½å­˜å‚¨æ—¶å¾ˆé‡è¦çš„ï¼Œä½†æ˜¯å®ƒå¸¦æ¥çš„é—®é¢˜ä¹Ÿå¾ˆä¸¥å³»ï¼Œåˆ—è¡¨å…ƒç´ å½“è¾¾åˆ°ä¸€å®šçš„é‡çº§å°±å¯èƒ½å‡ºç°é—®é¢˜ï¼š\n\nå¾ˆéš¾æ‰¾åˆ°é‚£ä¹ˆå¤§çš„è¿ç»­å†…å­˜ç©ºé—´ï¼šå¦‚æœä¸€ä¸ªå‹ç¼©åˆ—è¡¨æ— é™å¤§ï¼Œè™½ç„¶æœåŠ¡å™¨å¯ç”¨å†…å­˜å¥½å‹ä½†æ˜¯å› ä¸ºæ²¡æœ‰è¶³å¤Ÿçš„è¿ç»­å†…å­˜ä¹Ÿä¼šå‡ºç°é—®é¢˜ã€‚\nå½“åˆ—è¡¨è¶³å¤Ÿå¤§æ—¶ï¼Œæ¯ä¸€æ¬¡çš„æ’å…¥å’Œåˆ é™¤æ“ä½œéœ€è¦é¢‘ç¹çš„ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼Œäº§ç”Ÿå¤§é‡çš„æ•°æ®æ‹·è´ã€‚\n\næ‰€ä»¥éµå¾ªç€åˆ†æ²»åŸåˆ™ï¼Œå°†ä¸€ä¸ªå¤§çš„åˆ—è¡¨æ‹†åˆ†æˆNä¸ªå°çš„åˆ—è¡¨é€šè¿‡æŒ‡é’ˆé¦–å°¾ç›¸æ¥å°±æœ‰äº†â€”â€” QuickList å¿«é€Ÿåˆ—è¡¨ã€‚\nåŸºæœ¬ç»“æ„quicklisttypedef struct quicklist &#123;    // å¤´ç»“ç‚¹    quicklistNode *head;    // å°¾ç»“ç‚¹    quicklistNode *tail;    // å‹ç¼©åˆ—è¡¨çš„ä¸ªæ•°    unsigned long count;        /* total count of all entries in all ziplists */    // å¿«é€Ÿåˆ—è¡¨çš„ä¸ªæ•°    unsigned long len;          /* number of quicklistNodes */    // å•ä¸ªèŠ‚ç‚¹çš„å¡«å……å› å­    int fill : QL_FILL_BITS;              /* fill factor for individual nodes */    unsigned int compress : QL_COMP_BITS; /* depth of end nodes not to compress;0=off */    unsigned int bookmark_count: QL_BM_BITS;    quicklistBookmark bookmarks[];&#125; quicklist;\n\nquicklistNodetypedef struct quicklistNode &#123;    // å‰ç½®èŠ‚ç‚¹    struct quicklistNode *prev;    // åç½®èŠ‚ç‚¹    struct quicklistNode *next;    // ä¸»ä½“ ä¹Ÿå°±æ˜¯ ziplist å‹ç¼©åˆ—è¡¨    unsigned char *zl;    /* ä¸‹é¢æ˜¯ä¸€äº›èŠ‚ç‚¹çš„ç»Ÿè®¡å±æ€§ */    unsigned int sz;             /* ziplist size in bytes */    unsigned int count : 16;     /* count of items in ziplist */    unsigned int encoding : 2;   /* RAW==1 or LZF==2 */    unsigned int container : 2;  /* NONE==1 or ZIPLIST==2 */    unsigned int recompress : 1; /* was this node previous compressed? */    unsigned int attempted_compress : 1; /* node can&#x27;t compress; too small */    unsigned int extra : 10; /* more bits to steal for future usage */&#125; quicklistNode;\n\n\n\nprev: æŒ‡å‘é“¾è¡¨å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚\nnext: æŒ‡å‘é“¾è¡¨åä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚\nzl: æ•°æ®æŒ‡é’ˆã€‚å¦‚æœå½“å‰èŠ‚ç‚¹çš„æ•°æ®æ²¡æœ‰å‹ç¼©ï¼Œé‚£ä¹ˆå®ƒæŒ‡å‘ä¸€ä¸ªziplistç»“æ„ï¼›å¦åˆ™ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªquicklistLZFç»“æ„ã€‚\nsz: è¡¨ç¤ºzlæŒ‡å‘çš„ziplistçš„æ€»å¤§å°ï¼ˆåŒ…æ‹¬ zlbytes, zltail, zllen, zlendå’Œå„ä¸ªæ•°æ®é¡¹ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœziplistè¢«å‹ç¼©äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªszçš„å€¼ä»ç„¶æ˜¯å‹ç¼©å‰çš„ziplistå¤§å°ã€‚\ncount: è¡¨ç¤ºziplisté‡Œé¢åŒ…å«çš„æ•°æ®é¡¹ä¸ªæ•°ã€‚è¿™ä¸ªå­—æ®µåªæœ‰16bitã€‚ç¨åæˆ‘ä»¬ä¼šä¸€èµ·è®¡ç®—ä¸€ä¸‹è¿™16bitæ˜¯å¦å¤Ÿç”¨ã€‚\nencoding: è¡¨ç¤ºziplistæ˜¯å¦å‹ç¼©äº†ï¼ˆä»¥åŠç”¨äº†å“ªä¸ªå‹ç¼©ç®—æ³•ï¼‰ã€‚ç›®å‰åªæœ‰ä¸¤ç§å–å€¼ï¼š2è¡¨ç¤ºè¢«å‹ç¼©äº†ï¼ˆè€Œä¸”ç”¨çš„æ˜¯LZFå‹ç¼©ç®—æ³•ï¼‰ï¼Œ1è¡¨ç¤ºæ²¡æœ‰å‹ç¼©ã€‚\ncontainer: æ˜¯ä¸€ä¸ªé¢„ç•™å­—æ®µã€‚æœ¬æ¥è®¾è®¡æ˜¯ç”¨æ¥è¡¨æ˜ä¸€ä¸ªquicklistèŠ‚ç‚¹ä¸‹é¢æ˜¯ç›´æ¥å­˜æ•°æ®ï¼Œè¿˜æ˜¯ä½¿ç”¨ziplistå­˜æ•°æ®ï¼Œæˆ–è€…ç”¨å…¶å®ƒçš„ç»“æ„æ¥å­˜æ•°æ®ï¼ˆç”¨ä½œä¸€ä¸ªæ•°æ®å®¹å™¨ï¼Œæ‰€ä»¥å«containerï¼‰ã€‚ä½†æ˜¯ï¼Œåœ¨ç›®å‰çš„å®ç°ä¸­ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼2ï¼Œè¡¨ç¤ºä½¿ç”¨ziplistä½œä¸ºæ•°æ®å®¹å™¨ã€‚\nrecompress: å½“æˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼lindexè¿™æ ·çš„å‘½ä»¤æŸ¥çœ‹äº†æŸä¸€é¡¹æœ¬æ¥å‹ç¼©çš„æ•°æ®æ—¶ï¼Œéœ€è¦æŠŠæ•°æ®æš‚æ—¶è§£å‹ï¼Œè¿™æ—¶å°±è®¾ç½®recompress=1åšä¸€ä¸ªæ ‡è®°ï¼Œç­‰æœ‰æœºä¼šå†æŠŠæ•°æ®é‡æ–°å‹ç¼©ã€‚\nattempted_compress: è¿™ä¸ªå€¼åªå¯¹Redisçš„è‡ªåŠ¨åŒ–æµ‹è¯•ç¨‹åºæœ‰ç”¨ã€‚æˆ‘ä»¬ä¸ç”¨ç®¡å®ƒã€‚\nextra: å…¶å®ƒæ‰©å±•å­—æ®µã€‚ç›®å‰Redisçš„å®ç°é‡Œä¹Ÿæ²¡ç”¨ä¸Šã€‚\n\n\nåŸºæœ¬æ“ä½œæ’å…¥quicklistå¯ä»¥é€‰æ‹©åœ¨å¤´éƒ¨æˆ–è€…å°¾éƒ¨è¿›è¡Œæ’å…¥(quicklistPushHeadå’Œ quicklistPushTail)ï¼Œè€Œä¸ç®¡æ˜¯åœ¨å¤´éƒ¨è¿˜æ˜¯å°¾éƒ¨æ’å…¥æ•°æ®ï¼Œéƒ½åŒ…å«ä¸¤ç§æƒ…å†µï¼š\n\nå¦‚æœå¤´èŠ‚ç‚¹ï¼ˆæˆ–å°¾èŠ‚ç‚¹ï¼‰ä¸Šziplistå¤§å°æ²¡æœ‰è¶…è¿‡é™åˆ¶ï¼ˆå³ _quicklistNodeAllowInsertè¿”å›1ï¼‰ï¼Œé‚£ä¹ˆæ–°æ•°æ®è¢«ç›´æ¥æ’å…¥åˆ°ziplistä¸­ï¼ˆè°ƒç”¨ ziplistPushï¼‰ã€‚\nå¦‚æœå¤´èŠ‚ç‚¹ï¼ˆæˆ–å°¾èŠ‚ç‚¹ï¼‰ä¸Š ziplistå¤ªå¤§äº†ï¼Œé‚£ä¹ˆæ–°åˆ›å»ºä¸€ä¸ªquicklistNodeèŠ‚ç‚¹ï¼ˆå¯¹åº”åœ°ä¹Ÿä¼šæ–°åˆ›å»ºä¸€ä¸ªziplistï¼‰ï¼Œç„¶åæŠŠè¿™ä¸ªæ–°åˆ›å»ºçš„èŠ‚ç‚¹æ’å…¥åˆ°quickliståŒå‘é“¾è¡¨ä¸­ã€‚\n\n\næ€»ç»“\nä¸€ä¸ªåŸºäºå‹ç¼©åˆ—è¡¨å’Œé“¾è¡¨å®ç°çš„æ•°æ®ç»“æ„ï¼Œæœ¬è´¨ç”¨äºè§£å†³å•çº¯çš„é“¾è¡¨å’Œå‹ç¼©åˆ—è¡¨æ‰€é‡åˆ°çš„ä¸€äº›å†…å­˜ä¸Šé—®é¢˜ã€‚\n\nè‡´è°¢\nRedisæ•°æ®ç»“æ„â€”â€”å¿«é€Ÿåˆ—è¡¨(quicklist) \n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"Redisæ•°æ®ç»“æ„æºç è§£æ(å››) å‹ç¼©åˆ—è¡¨","url":"/2022/01/19/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E5%9B%9B-%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8/","content":"ç»“åˆJavaå¯¹æ¯”Redisçš„å‹ç¼©åˆ—è¡¨è¯´åˆ°Javaä¸­çš„åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¿«æƒ³åˆ° ArrayListå’Œ LinkedListï¼Œä»–ä»¬ä¿©çš„åŒºåˆ«åœ¨äºä¸€ä¸ªæ˜¯æ•°ç»„å®ç°ä¸€ä¸ªæ˜¯é“¾è¡¨å®ç°ã€‚å¯¹äºæ•°ç»„å’Œé“¾è¡¨éƒ½æœ‰å„è‡ªçš„ä¼˜åŠ£ã€‚\nå›åˆ°Redisçš„åˆ—è¡¨åŒæ ·ä¹Ÿå¯ä»¥ä½¿ç”¨æ•°ç»„å’Œåˆ—è¡¨å»å®ç°ï¼ŒRedisä¸­æœ‰å®ç° listNode å’Œ list ç»“æ„ï¼Œä½¿ç”¨äº†é“¾è¡¨ç»“æœä½†æ˜¯è¿™åªæ˜¯ç”¨äºæœåŠ¡ç«¯å­˜æ”¾è¿è¡Œæ•°æ®ï¼Œä¸å­˜æ”¾å¼€å‘è€…å­˜å‚¨çš„æ•°æ®ã€‚\nåŸå› å¾ˆç®€å•ï¼š\n\né“¾è¡¨åœ¨å…ƒç´ è¿‡å¤šçš„æ—¶å€™ç¡®å®å¯ä»¥æé«˜æ’å…¥çš„æ•ˆç‡çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯ä»–å¯¹å†…å­˜çš„ç®¡ç†ä¸å¤Ÿä¼˜ç§€ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„å†…å­˜ç¢ç‰‡ã€‚å†…å­˜ç¢ç‰‡åœ¨å¤§é‡æ‰§è¡Œå†…å­˜æ“ä½œçš„Redisä¸­æ˜¾ç„¶æ˜¯ä¸å‹å¥½çš„ã€‚\né“¾è¡¨çš„ Node ç»“æ„ä¸­å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹æŒ‡é’ˆå±æ€§å¤ªå¤šï¼Œé€ æˆå†…å­˜çš„æµªè´¹ï¼ï¼ˆçœŸçš„æ˜¯æŠŠå‹¤ä¿­æŒå®¶å‘æŒ¥åˆ°äº†æè‡´ï¼Œä»æ¥æ²¡è€ƒè™‘è¿‡è¿™ä¸ªä¸œè¥¿å¯èƒ½ä¼šæµªè´¹å¤šå°‘å†…å­˜ï¼‰\n\nå°±å¦‚ä¸Šä¸¤ä¸ªé—®é¢˜åœ¨Redisä¸­ä½¿ç”¨äº†æ•°ç»„ä½œä¸ºå‹ç¼©åˆ—è¡¨çš„åº•å±‚å®ç°ã€‚Redisè‡ªå·±å®šä¹‰äº†ä¸€ä¸ªè§„èŒƒ(æˆ–è€…å«æ ¼å¼?)ï¼Œå°†æ•°æ®æ•´é½çš„å®‰æ’å¥½ï¼Œæœ‰ç»Ÿä¸€çš„æ’å…¥ä¸æŸ¥è¯¢æ–¹æ³•ï¼Œä¿è¯å³ä½¿åˆ—è¡¨è¢«å‹ç¼©åœ¨äº†æ•°ç»„ä¸­ä¹Ÿèƒ½å®Œæ•´çš„è¯»å–ã€‚\næŠ½è±¡ç»“æ„å…ˆæŠ½è±¡çš„çœ‹ä¸€ä¸‹ï¼Œæˆ‘å‰é¢æ‰€è¯´çš„è§„èŒƒã€æ ¼å¼å¤§è‡´æ˜¯ä¸ªä»€ä¹ˆæ ·å­\nliståœ¨æ•°ç»„ä¸­åŸºæœ¬ä»¥å¦‚ä¸‹æ ¼å¼è¿›è¡Œå­˜å‚¨\n\n&lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry&gt; &lt;entry&gt; ... &lt;entry&gt; &lt;zlend&gt;\n\n\nzlbytes :è®°å½•æ•´ä¸ªåˆ—è¡¨çš„å ç”¨å­—èŠ‚æ•°ï¼Œä¹ŸåŒ…æ‹¬äº†è‡ªèº«çš„4ä¸ªå­—èŠ‚\nzltailï¼šè®°å½•ä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„åç§»é‡ï¼Œç”¨äºåå‘çš„éå†\nzllenï¼šèŠ‚ç‚¹ä¸ªæ•°ï¼Œå¦‚æœè¶…è¿‡2^16 -1 æ—¶å°±æ— æ³•è®°å½•èŠ‚ç‚¹ä¸ªæ•°äº†ï¼Œæ­¤æ—¶ç»Ÿè®¡éœ€è¦O(N)éå†\nentryï¼šå°±æ˜¯å­˜å‚¨å®¢æˆ·ç«¯æ•°æ®çš„èŠ‚ç‚¹\nzlendï¼šä¸€ä¸ªæ ‡è®°ä½ï¼Œç±»ä¼¼äºå­—ç¬¦ä¸²ä¸­è¯´åˆ°çš„ \\0ï¼Œä»…ä»…æ˜¯ç”¨äºè®°å½•ç»“æŸç‚¹\n\nentity&lt;prevlen&gt; &lt;encoding&gt; &lt;entry-data&gt;\nprevlenï¼šå‰é©±èŠ‚ç‚¹çš„é•¿åº¦\nencodingï¼šå½“å‰èŠ‚ç‚¹çš„ç¼–ç æ ¼å¼\nentry-dataï¼šçœŸæ­£çš„æ•°æ®\nåŸºæœ¬ç»“æ„zlentrytypedef struct zlentry &#123;    // å‰ç½®èŠ‚ç‚¹é•¿åº¦    unsigned int prevrawlensize; /* Bytes used to encode the previous entry len*/    // å‰ç½®    unsigned int prevrawlen;     /* Previous entry len. */    // encoding é•¿åº¦    unsigned int lensize;        /* Bytes used to encode this entry type/len.                                    For example strings have a 1, 2 or 5 bytes                                    header. Integers always use a single byte.*/    // å†…å®¹çš„é•¿åº¦    unsigned int len;            /* Bytes used to represent the actual entry.                                    For strings this is just the string length                                    while for integers it is 1, 2, 3, 4, 8 or                                    0 (for 4 bit immediate) depending on the                                    number range. */    // é¦–éƒ¨é•¿åº¦    unsigned int headersize;     /* prevrawlensize + lensize. */    // ç¼–ç     unsigned char encoding;      /* Set to ZIP_STR_* or ZIP_INT_* depending on                                    the entry encoding. However for 4 bits                                    immediate integers this can assume a range                                    of values and must be range-checked. */    // å½“å‰å…ƒç´ çš„é¦–åœ°å€    unsigned char *p;            /* Pointer to the very start of the entry, that                                    is, this points to prev-entry-len field. */&#125; zlentry;\n\nTODO\næš‚æ—¶å…ˆæŠ½è±¡äº†è§£ï¼Œåç»­è¡¥ä¸Š\n\nä¼˜åŠ£åˆ†æziplist å­˜å‚¨åœ¨ä¸€æ®µè¿ç»­çš„å†…å­˜ä¸Šï¼Œæ‰€ä»¥å­˜å‚¨æ•ˆç‡å¾ˆé«˜ã€‚ä½†æ˜¯ï¼Œå®ƒä¸åˆ©äºä¿®æ”¹æ“ä½œï¼Œæ’å…¥å’Œåˆ é™¤æ“ä½œéœ€è¦é¢‘ç¹çš„ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ã€‚ç‰¹åˆ«æ˜¯å½“ziplisté•¿åº¦å¾ˆé•¿çš„æ—¶å€™ï¼Œä¸€æ¬¡ reallocå¯èƒ½ä¼šå¯¼è‡´å¤§æ‰¹é‡çš„æ•°æ®æ‹·è´ã€‚\næ€»ç»“\nå…³äºåˆ—è¡¨çš„åº•å±‚å®ç°ï¼ŒJavaåœˆé‡Œè²Œä¼¼æ›´å¤šè¿˜æ˜¯å–œæ¬¢ç”¨é“¾è¡¨ï¼Œä½†æ˜¯Redisä½¿ç”¨äº†æ•°ç»„ï¼ŒåŸå› æ˜¯ï¼šé“¾è¡¨ä¼šé€ æˆå†…å­˜çš„ç¢ç‰‡å’Œè¿‡å¤šçš„èŠ‚ç‚¹æŒ‡é’ˆé€ æˆå†…å­˜çš„æµªè´¹ã€‚\n\nè‡´è°¢\nRedisæºç è§£æ - æœ‰èµæŠ€æœ¯å›¢é˜Ÿ\nRedis è®¾è®¡ä¸å®ç°\n\n","categories":["Redis"],"tags":["æºç ","Redisæ•°æ®ç»“æ„æºç è§£æç³»åˆ—"]},{"title":"ReentrantLock å…¬å¹³é”ä¸éå…¬å¹³é”","url":"/2022/01/06/ReentrantLock%20%E5%85%AC%E5%B9%B3%E9%94%81%E4%B8%8E%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81/","content":"å®ä¾‹åŒ–åœ¨å®ä¾‹åŒ– ReentrantLockÂ çš„æ—¶å€™å¯ä»¥åŠ ä¸€ä¸ªæ„é€ å‚æ•°ã€‚\n// ä¼ trueæ—¶ä¸ºå…¬å¹³é”ReentrantLock lock = new ReentrantLock(true);// éå…¬å¹³é”ReentrantLock lock = new ReentrantLock();\n\nå½“ç„¶ä»–ä»¬çš„æ„é€ æ–¹æ³•ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„\næ„é€ æ–¹æ³•// fairä¸ºtrueæ—¶ä¸ºå…¬å¹³é”public ReentrantLock(boolean fair) &#123;    sync = fair ? new FairSync() : new NonfairSync();&#125;// é»˜è®¤éå…¬å¹³é”public ReentrantLock() &#123;    sync = new NonfairSync();&#125;\n\næ­¤äº‹æˆ‘ä»¬å‘ç° ReentrantLockÂ ä¸ºäº†åº”å¯¹å…¬å¹³é”ä¸éå…¬å¹³é”å®ç°äº†ä¸¤ä¸ªç±»ï¼š FairSyncÂ å’Œ NonfairSyncÂ ã€‚ä»–ä»¬éƒ½æ˜¯ç»§æ‰¿äº SyncÂ ç±»ã€‚\nlockæˆ‘ä»¬æ‰¾åˆ° FairSync å’Œ NonfairSync  ç±»çš„ lockÂ æ–¹æ³•ï¼Œå‘ç°åŒºåˆ«è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ã€‚\nstatic final class FairSync extends Sync &#123;    final void lock() &#123;        acquire(1);    &#125;&#125;static final class NonfairSync extends Sync &#123;     final void lock() &#123;         // å‘ç°éå…¬å¹³é”æ¯”å…¬å¹³é”å¤šäº†ä¸€æ­¥         if (compareAndSetState(0, 1))             setExclusiveOwnerThread(Thread.currentThread());         else             acquire(1);     &#125;&#125;\n\nå…¬å¹³é”åœ¨æ‰§è¡Œ lockÂ æ–¹æ³•æ—¶ä¼šç›´æ¥æ‰§è¡Œ acquireÂ æ–¹æ³•ï¼Œè€Œéå…¬å¹³é”ä¼šå…ˆå°è¯•æ›¿æ¢ä¸€ä¸‹çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸåˆ™è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºæ‰€æœ‰è€…ã€‚\ntryAcquire// å…¬å¹³é”protected final boolean tryAcquire(int acquires) &#123;    final Thread current = Thread.currentThread();    int c = getState();    if (c == 0) &#123;        if (!hasQueuedPredecessors() &amp;&amp;            compareAndSetState(0, acquires)) &#123;            setExclusiveOwnerThread(current);            return true;        &#125;    &#125;    else if (current == getExclusiveOwnerThread()) &#123;        int nextc = c + acquires;        if (nextc &lt; 0)            throw new Error(&quot;Maximum lock count exceeded&quot;);        setState(nextc);        return true;    &#125;    return false;&#125;// éå…¬å¹³é”protected final boolean tryAcquire(int acquires) &#123;    return nonfairTryAcquire(acquires);&#125;final boolean nonfairTryAcquire(int acquires) &#123;    final Thread current = Thread.currentThread();    int c = getState();    if (c == 0) &#123;        if (compareAndSetState(0, acquires)) &#123;            setExclusiveOwnerThread(current);            return true;        &#125;    &#125;    else if (current == getExclusiveOwnerThread()) &#123;        int nextc = c + acquires;        if (nextc &lt; 0) // overflow            throw new Error(&quot;Maximum lock count exceeded&quot;);        setState(nextc);        return true;    &#125;    return false;&#125;\n\nè²Œä¼¼å¾ˆå¤šï¼Œæ˜¯å¦å…¬å¹³çš„å…³é”®åªæ˜¯ä¸€ä¸ªæ–¹æ³•ã€‚\n// éå…¬å¹³if (c == 0) &#123;    if (compareAndSetState(0, acquires)) &#123;        setExclusiveOwnerThread(current);        return true;    &#125;&#125;// å…¬å¹³if (c == 0) &#123;    // å¤šäº†ä¸€ä¸ªhasQueuedPredecessors    if (!hasQueuedPredecessors() &amp;&amp;        compareAndSetState(0, acquires)) &#123;        setExclusiveOwnerThread(current);        return true;    &#125;&#125;\n\nhasQueuedPredecessorsç¿»è¯‘è¿‡æ¥å°±æ˜¯é˜Ÿåˆ—æ˜¯å¦æœ‰å‰èŠ‚ç‚¹ã€‚\npublic final boolean hasQueuedPredecessors() &#123;    // The correctness of this depends on head being initialized    // before tail and on head.next being accurate if the current    // thread is first in queue.    Node t = tail; // Read fields in reverse initialization order    Node h = head;    Node s;    return h != t &amp;&amp;        ((s = h.next) == null || s.thread != Thread.currentThread());&#125;\n\nå¤´èŠ‚ç‚¹ä¸æ˜¯å°¾èŠ‚ç‚¹ ä¸” ï¼ˆ å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©º æˆ–è€… å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯å½“å‰èŠ‚ç‚¹ ï¼‰\n","categories":["Java"],"tags":["å¤šçº¿ç¨‹ä¸é«˜å¹¶å‘ç³»åˆ—","AQS","é”","ReentrantLock"]},{"title":"ReentrantLock å‰è¨€","url":"/2022/01/06/ReentrantLock%20%E5%89%8D%E8%A8%80/","content":"å‰è¨€ReentrantLock å’Œ synchronized éƒ½æ˜¯ Java è¯­è¨€ä¸­å¸¸è§çš„é”ï¼Œåœ¨è½¯ä»¶è¡Œä¸šæ²¡æœ‰æ°¸è¿œçš„é“¶å¼¹æ—¢ç„¶å­˜åœ¨è¡¨ç¤ºæœ‰å­˜åœ¨çš„æ„ä¹‰ã€‚\nè¿™å°±è¦ä»2004å¹´è¯´èµ·ï¼Œå½“æ—¶çš„ synchronized è¿˜æ²¡æœ‰ç»è¿‡ä¼˜åŒ–æ˜¯ä¸€ä¸ªé‡é‡çº§é”ï¼Œæ‰€ä»¥åŒå¹´å‘å¸ƒçš„ JDK1.5 å‘å¸ƒäº† ReentrantLock ï¼Œä»æ­¤å¼€å‘è€…é¢å¯¹é”åˆå¤šäº†ä¸€ä¸ªé€‰æ‹©ã€‚ä¸¤å¹´åçš„2006å¹´ JDK1.6 å‘å¸ƒï¼Œå‘å¸ƒäº†ä¼˜åŒ–åçš„ synchronized ï¼Œå¹¶ä¸”å¸¦æ¥äº†æ— é”ã€åå‘é”ã€é”å‡çº§ç­‰æ¦‚å¿µï¼Œä½¿å¾—å…¶æ•ˆç‡å¾—åˆ°æå‡ã€‚\nè™½ç„¶æ€§èƒ½å¾—åˆ°äº†æå‡ï¼Œä½†æœ‰ä¸€ç‚¹çš„ ReentrantLock è¿˜æ˜¯è¦æ›´ä¸ºé¢†å…ˆçš„ï¼Œé‚£å°±æ˜¯çµæ´»æ€§ã€‚syncæ˜¯Javaä¸­çš„å…³é”®å­—ï¼Œå°±å¦‚åŒå¸¸è§çš„ Interfaceã€finalç­‰ï¼Œè€Œ ReentrantLock æ˜¯ JUC åŒ…ä¸‹çš„ä¸€ä¸ªå¯¹è±¡ï¼Œçµæ´»æ€§è®©ä»–å¸¦æ¥äº† tryLock()ã€å…¬å¹³é”ã€æ­»é”æ£€æµ‹ã€é…åˆ try...finallyä½¿ç”¨ç­‰ç‰¹æ€§ã€‚\n","categories":["Java"],"tags":["å¤šçº¿ç¨‹ä¸é«˜å¹¶å‘ç³»åˆ—","AQS","é”","ReentrantLock"]},{"title":"ReentrantLock å¦‚ä½•ä¿è¯é‡å…¥","url":"/2022/01/06/ReentrantLock%20%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E9%87%8D%E5%85%A5/","content":"å…¬å¹³é”ï¼š// java.util.concurrent.locks.ReentrantLock.FairSync#tryAcquireif (c == 0) &#123;\tif (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(0, acquires)) &#123;\t\tsetExclusiveOwnerThread(current);\t\treturn true;\t&#125;&#125;else if (current == getExclusiveOwnerThread()) &#123;\tint nextc = c + acquires;\tif (nextc &lt; 0)\t\tthrow new Error(&quot;Maximum lock count exceeded&quot;);\tsetState(nextc);\treturn true;&#125;\n\néå…¬å¹³é”ï¼š// java.util.concurrent.locks.ReentrantLock.Sync#nonfairTryAcquireif (c == 0) &#123;\tif (compareAndSetState(0, acquires))&#123;\t\tsetExclusiveOwnerThread(current);\t\treturn true;\t&#125;&#125;else if (current == getExclusiveOwnerThread()) &#123;\tint nextc = c + acquires;\tif (nextc &lt; 0) // overflow\t\tthrow new Error(&quot;Maximum lock count exceeded&quot;);\tsetState(nextc);\treturn true;&#125;\n\nä»ä¸Šé¢è¿™ä¸¤æ®µéƒ½å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªåŒæ­¥çŠ¶æ€Stateæ¥æ§åˆ¶æ•´ä½“å¯é‡å…¥çš„æƒ…å†µã€‚Stateæ˜¯ Volatileä¿®é¥°çš„ï¼Œç”¨äºä¿è¯ä¸€å®šçš„å¯è§æ€§å’Œæœ‰åºæ€§ã€‚\n// java.util.concurrent.locks.AbstractQueuedSynchronizerprivate volatile int state;\n\næ¥ä¸‹æ¥çœ‹ Stateè¿™ä¸ªå­—æ®µä¸»è¦çš„è¿‡ç¨‹ï¼š\n\nStateåˆå§‹åŒ–çš„æ—¶å€™ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰ä»»ä½•çº¿ç¨‹æŒæœ‰é”ã€‚\nå½“æœ‰çº¿ç¨‹æŒæœ‰è¯¥é”æ—¶ï¼Œå€¼å°±ä¼šåœ¨åŸæ¥çš„åŸºç¡€ä¸Š+1ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å¾—é”æ˜¯ï¼Œå°±ä¼šå¤šæ¬¡+1ï¼Œè¿™é‡Œå°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚\nè§£é”ä¹Ÿæ˜¯å¯¹è¿™ä¸ªå­—æ®µ-1ï¼Œä¸€ç›´åˆ°0ï¼Œæ­¤çº¿ç¨‹å¯¹é”é‡Šæ”¾ã€‚\n\n","categories":["Java"],"tags":["å¤šçº¿ç¨‹ä¸é«˜å¹¶å‘ç³»åˆ—","AQS","é”","ReentrantLock"]},{"title":"ReentrantLock æºç åˆ†æ - åŠ é”","url":"/2022/01/06/ReentrantLock%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20-%20%E5%8A%A0%E9%94%81/","content":"å‰è¨€æœ¬ç³»åˆ—æ–‡ç« é€šè¿‡æ—¥å¸¸ä¸­æ¯”è¾ƒå¸¸è§ ReentrantLockÂ å¼€å§‹ï¼Œé€æ­¥æ­å¼€AQSçš„åº•å±‚ã€‚\nlock()ReentrantLock lock = new ReentrantLock();try&#123;    lock.lock();    // ä¸šåŠ¡...&#125;finally &#123;    lock.unlock();&#125;\n\næ—¥å¸¸æˆ‘ä»¬ä¼šè¿™æ ·ä½¿ç”¨ ReentrantLock\n// java.util.concurrent.locksfinal void lock() &#123;    // é¦–å…ˆåšäº†ä¸€ä¸ªåˆ¤æ–­    // æ¯”è¾ƒå¹¶æ›¿æ¢(CAS) å¦‚æœæœŸæœ›å€¼ä¸º0åˆ™æ›¿æ¢ä¸º1    if (compareAndSetState(0, 1))        // å¦‚æœæ›¿æ¢æˆåŠŸ        // è¡¨ç¤ºå·²ç»æ‹¿åˆ°äº†é”        setExclusiveOwnerThread(Thread.currentThread());    else        // å¦åˆ™å°†æ‰§è¡Œä¸€ä¸ªè·å–é”çš„æ“ä½œ        acquire(1);&#125;\n\nä¸Šé¢ä»£ç ä¸­ compareAndSetStateÂ  ã€ setExclusiveOwnerThreadÂ ã€ acquireÂ ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯AQSä¸‹çš„ã€‚\nacquire()public final void acquire(int arg) &#123;    if (!tryAcquire(arg) &amp;&amp;        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))        selfInterrupt();&#125;\n\naddWaiterprivate Node addWaiter(Node mode) &#123;    // æ–°å»ºäº†ä¸€ä¸ªNodeå¯¹è±¡    Node node = new Node(Thread.currentThread(), mode);    // æ‹¿åˆ°å°¾å·´èŠ‚ç‚¹    Node pred = tail;    if (pred != null) &#123;        node.prev = pred;        // å°†æ–°åˆ›å»ºçš„èŠ‚ç‚¹è¿½åŠ åˆ°é“¾è¡¨çš„å°¾å·´ä¸Š        // æ­¤å¤„åŒæ ·ç”¨åˆ°äº†æ¯”è¾ƒæ›¿æ¢        // è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å¯¹tailOffsetå’ŒExpectè¿›è¡Œæ¯”è¾ƒ        // å¦‚æœtailOffsetçš„Nodeå’ŒExpectçš„Nodeåœ°å€æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆè®¾ç½®Tailçš„å€¼ä¸ºUpdateçš„å€¼        if (compareAndSetTail(pred, node)) &#123;            pred.next = node;            // æœ€ç»ˆè¿”å›å½“å‰èŠ‚ç‚¹            return node;        &#125;    &#125;    // å†…éƒ¨æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç›´åˆ°è®¾ç½®nodeä¸ºå°¾èŠ‚ç‚¹ä¸ºæ­¢ã€‚    enq(node);    return node;&#125;\n\n\nå…³äº compareAndSetTailÂ æ–¹æ³•æ·±æŒ–å¯ä»¥å‘ç°ä»–æ˜¯ä¸€ä¸ª nativeÂ ä¿®é¥°çš„æ–¹æ³•ã€‚é«˜å¹¶å‘ä¸‹éš¾å…ä¼šå‡ºç°å¤šçº¿ç¨‹å¹¶å‘å»è¿½åŠ å°¾å·´èŠ‚ç‚¹ï¼Œé˜²æ­¢è¿½åŠ é”™ä¹±ã€‚ä½¿ç”¨äº†CASæ²¡æœ‰ä½¿ç”¨å…¶ä»–é”æ˜¯å› ä¸ºï¼ŒCASçš„é¢—ç²’æ¯”è¾ƒå°ï¼Œæ°¸è¿œåªéœ€è¦ç›¯ç€ predÂ ä½œæ¯”è¾ƒï¼Œæ— éœ€é”ä½æ•´ä¸ªé“¾è¡¨ã€‚\n\nacquireQueuedä¸Šæ–‡è§£é‡Šäº† addWaiterÂ æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯æŠŠå¯¹åº”çš„çº¿ç¨‹ä»¥Nodeçš„æ•°æ®ç»“æ„å½¢å¼åŠ å…¥åˆ°åŒç«¯é˜Ÿåˆ—é‡Œï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåŒ…å«è¯¥çº¿ç¨‹çš„Nodeã€‚è€Œè¿™ä¸ªNodeä¼šä½œä¸ºå‚æ•°ï¼Œè¿›å…¥åˆ° acquireQueuedÂ æ–¹æ³•ä¸­ã€‚ acquireQueuedÂ æ–¹æ³•å¯ä»¥å¯¹æ’é˜Ÿä¸­çš„çº¿ç¨‹è¿›è¡Œâ€œè·é”â€æ“ä½œã€‚æ€»çš„æ¥è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹è·å–é”å¤±è´¥äº†ï¼Œè¢«æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œ acquireQueuedÂ ä¼šæŠŠæ”¾å…¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ä¸æ–­å»è·å–é”ï¼Œç›´åˆ°è·å–æˆåŠŸæˆ–è€…ä¸å†éœ€è¦è·å–ï¼ˆä¸­æ–­ï¼‰ã€‚ä¸‹é¢æˆ‘ä»¬ä»â€œä½•æ—¶å‡ºé˜Ÿåˆ—ï¼Ÿâ€å’Œâ€œå¦‚ä½•å‡ºé˜Ÿåˆ—ï¼Ÿâ€ä¸¤ä¸ªæ–¹å‘æ¥åˆ†æä¸€ä¸‹acquireQueuedæºç ï¼š\n// java.util.concurrent.locks.AbstractQueuedSynchronizerfinal boolean acquireQueued(final Node node, int arg) &#123;\t// æ ‡è®°æ˜¯å¦æˆåŠŸæ‹¿åˆ°èµ„æº\tboolean failed = true;\ttry &#123;\t\t// æ ‡è®°ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦ä¸­æ–­è¿‡\t\tboolean interrupted = false;\t\t// å¼€å§‹æ­»å¾ªç¯(è½®è¯¢)        // ç›´è‡³æ‹¿åˆ°é”,æˆ–è€…ä¸­æ–­\t\tfor (;;) &#123;\t\t\t// è·å–å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹\t\t\tfinal Node p = node.predecessor();\t\t\t// å¦‚æœpæ˜¯å¤´ç»“ç‚¹ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹åœ¨çœŸå®æ•°æ®é˜Ÿåˆ—çš„é¦–éƒ¨ï¼Œå°±å°è¯•è·å–é”ï¼ˆåˆ«å¿˜äº†å¤´ç»“ç‚¹æ˜¯è™šèŠ‚ç‚¹ï¼‰\t\t\tif (p == head &amp;&amp; tryAcquire(arg)) &#123;\t\t\t\t// è·å–é”æˆåŠŸï¼Œè‡ªå·±ä½œä¸ºæ–°çš„å¤´ç»“ç‚¹\t\t\t\tsetHead(node);                // p.next å…¶å®å°±æ˜¯ æœ¬æ–¹æ³•ä¼ å‚ä¸­çš„ node                // è®¾ç½®ä¸ºnull æ²¡æœ‰äº†å¼•ç”¨ æœ‰åˆ©äºgc æ¸…ç†node\t\t\t\tp.next = null; // help GC \t\t\t\tfailed = false;\t\t\t\treturn interrupted;\t\t\t&#125;\t\t\t// è¯´æ˜pä¸ºå¤´èŠ‚ç‚¹ä¸”å½“å‰æ²¡æœ‰è·å–åˆ°é”ï¼ˆå¯èƒ½æ˜¯éå…¬å¹³é”è¢«æŠ¢å äº†ï¼‰æˆ–è€…æ˜¯pä¸ä¸ºå¤´ç»“ç‚¹            // è¿™ä¸ªæ—¶å€™å°±è¦åˆ¤æ–­å½“å‰nodeæ˜¯å¦è¦è¢«é˜»å¡ï¼ˆè¢«é˜»å¡æ¡ä»¶ï¼šå‰é©±èŠ‚ç‚¹çš„waitStatusä¸º-1ï¼‰ï¼Œé˜²æ­¢æ— é™å¾ªç¯æµªè´¹èµ„æº\t\t\tif (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())\t\t\t\tinterrupted = true;\t\t&#125;\t&#125; finally &#123;\t\tif (failed)\t\t\tcancelAcquire(node);\t&#125;&#125;\n\nshouldParkAfterFailedAcquire// java.util.concurrent.locks.AbstractQueuedSynchronizer// é å‰é©±èŠ‚ç‚¹åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123;\t// è·å–å¤´ç»“ç‚¹çš„èŠ‚ç‚¹çŠ¶æ€\tint ws = pred.waitStatus;\t// è¯´æ˜å¤´ç»“ç‚¹å¤„äºå”¤é†’çŠ¶æ€\tif (ws == Node.SIGNAL)\t\treturn true; \t// é€šè¿‡æšä¸¾å€¼æˆ‘ä»¬çŸ¥é“waitStatus&gt;0æ˜¯å–æ¶ˆçŠ¶æ€\tif (ws &gt; 0) &#123;\t\tdo &#123;\t\t\t// å¾ªç¯å‘å‰æŸ¥æ‰¾å–æ¶ˆèŠ‚ç‚¹ï¼ŒæŠŠå–æ¶ˆèŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­å‰”é™¤\t\t\tnode.prev = pred = pred.prev;\t\t&#125; while (pred.waitStatus &gt; 0);\t\tpred.next = node;\t&#125; else &#123;\t\t// è®¾ç½®å‰ä»»èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ä¸ºSIGNAL\t\tcompareAndSetWaitStatus(pred, ws, Node.SIGNAL);\t&#125;\treturn false;&#125;\n\nparkAndCheckInterruptprivate final boolean parkAndCheckInterrupt() &#123;    LockSupport.park(this);    return Thread.interrupted();&#125;\n\nparkAndCheckInterruptä¸»è¦ç”¨äºæŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œé˜»å¡è°ƒç”¨æ ˆï¼Œè¿”å›å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ã€‚\næ€»ç»“ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œè·³å‡ºå½“å‰å¾ªç¯çš„æ¡ä»¶æ˜¯å½“â€œå‰ç½®èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ï¼Œä¸”å½“å‰çº¿ç¨‹è·å–é”æˆåŠŸâ€ã€‚ä¸ºäº†é˜²æ­¢å› æ­»å¾ªç¯å¯¼è‡´CPUèµ„æºè¢«æµªè´¹ï¼Œæˆ‘ä»¬ä¼šåˆ¤æ–­å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€æ¥å†³å®šæ˜¯å¦è¦å°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œå…·ä½“æŒ‚èµ·æµç¨‹ç”¨æµç¨‹å›¾è¡¨ç¤ºå¦‚ä¸‹ï¼ˆshouldParkAfterFailedAcquireæµç¨‹ï¼‰ï¼š\n\nä»é˜Ÿåˆ—ä¸­é‡Šæ”¾èŠ‚ç‚¹çš„ç–‘è™‘æ‰“æ¶ˆäº†ï¼Œé‚£ä¹ˆåˆæœ‰æ–°é—®é¢˜äº†ï¼š\n\nshouldParkAfterFailedAcquireä¸­å–æ¶ˆèŠ‚ç‚¹æ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šæŠŠä¸€ä¸ªèŠ‚ç‚¹çš„waitStatusè®¾ç½®ä¸º-1ï¼Ÿ\næ˜¯åœ¨ä»€ä¹ˆæ—¶é—´é‡Šæ”¾èŠ‚ç‚¹é€šçŸ¥åˆ°è¢«æŒ‚èµ·çš„çº¿ç¨‹å‘¢ï¼Ÿ\n\ncancelAcquireé€šè¿‡cancelAcquireæ–¹æ³•ï¼Œå°†Nodeçš„çŠ¶æ€æ ‡è®°ä¸ºCANCELLEDã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€è¡Œæ¥åˆ†æè¿™ä¸ªæ–¹æ³•çš„åŸç†ï¼š\n// java.util.concurrent.locks.AbstractQueuedSynchronizerprivate void cancelAcquire(Node node) &#123;    // å°†æ— æ•ˆèŠ‚ç‚¹è¿‡æ»¤    if (node == null)        return;    // è®¾ç½®è¯¥èŠ‚ç‚¹ä¸å…³è”ä»»ä½•çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è™šèŠ‚ç‚¹    node.thread = null;    Node pred = node.prev;    // é€šè¿‡å‰é©±èŠ‚ç‚¹ï¼Œè·³è¿‡å–æ¶ˆçŠ¶æ€çš„node    while (pred.waitStatus &gt; 0)        node.prev = pred = pred.prev;    // è·å–è¿‡æ»¤åçš„å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹    Node predNext = pred.next;    // æŠŠå½“å‰nodeçš„çŠ¶æ€è®¾ç½®ä¸ºCANCELLED    node.waitStatus = Node.CANCELLED;    // å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹ï¼Œå°†ä»åå¾€å‰çš„ç¬¬ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹    // æ›´æ–°å¤±è´¥çš„è¯ï¼Œåˆ™è¿›å…¥elseï¼Œå¦‚æœæ›´æ–°æˆåŠŸï¼Œå°†tailçš„åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºnull    if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;        compareAndSetNext(pred, predNext, null);    &#125; else &#123;        int ws;        // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸æ˜¯headçš„åç»§èŠ‚ç‚¹ï¼Œ1:åˆ¤æ–­å½“å‰èŠ‚ç‚¹å‰é©±èŠ‚ç‚¹çš„æ˜¯å¦ä¸ºSIGNALï¼Œ2:å¦‚æœä¸æ˜¯ï¼Œåˆ™æŠŠå‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºSINGALçœ‹æ˜¯å¦æˆåŠŸ        // å¦‚æœ1å’Œ2ä¸­æœ‰ä¸€ä¸ªä¸ºtrueï¼Œå†åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å¦ä¸ºnull        // å¦‚æœä¸Šè¿°æ¡ä»¶éƒ½æ»¡è¶³ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹        if (pred != head &amp;&amp; ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp; pred.thread != null) &#123;            Node next = node.next;            if (next != null &amp;&amp; next.waitStatus &lt;= 0)                compareAndSetNext(pred, predNext, next);        &#125; else &#123;            // å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯headçš„åç»§èŠ‚ç‚¹ï¼Œæˆ–è€…ä¸Šè¿°æ¡ä»¶ä¸æ»¡è¶³ï¼Œé‚£å°±å”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹            unparkSuccessor(node);        &#125;        node.next = node; // help GC    &#125;&#125;\n","categories":["Java"],"tags":["å¤šçº¿ç¨‹ä¸é«˜å¹¶å‘ç³»åˆ—","AQS","é”","ReentrantLock"]},{"title":"ReentrantLock æºç åˆ†æ - è§£é”","url":"/2022/01/06/ReentrantLock%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20-%20%E8%A7%A3%E9%94%81/","content":"releasepublic final boolean release(int arg) &#123;    // å°è¯•é‡Šæ”¾    if (tryRelease(arg)) &#123;        Node h = head;        // å¤´ç»“ç‚¹ä¸ä¸ºç©º ä¸” å¤´ç»“ç‚¹çŠ¶æ€ä¸ä¸º0        if (h != null &amp;&amp; h.waitStatus != 0)            // å”¤é†’åèŠ‚ç‚¹            unparkSuccessor(h);        return true;    &#125;    return false;&#125;\n\ntryRelease@ReservedStackAccessprotected final boolean tryRelease(int releases) &#123;    // å…ˆåˆ¤æ–­é”è®¡æ•°å™¨    int c = getState() - releases;    // æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”    if (Thread.currentThread() != getExclusiveOwnerThread())        throw new IllegalMonitorStateException();    // é»˜è®¤è¿”å›çš„æ˜¯false    boolean free = false;    // å¦‚æœé”è®¡æ•°å™¨ä¸º0 è¡¨ç¤ºé‡å…¥é”å…¨éƒ¨è§£é”    if (c == 0) &#123;        // è®¾ç½®ä¸ºtrue        free = true;        // è®¾ç½®é”æ‰€æœ‰äººä¸ºç©º        setExclusiveOwnerThread(null);    &#125;    // è®¾ç½®é”çŠ¶æ€    setState(c);    return free;&#125;\n\nunparkSuccessorprivate void unparkSuccessor(Node node) &#123;   // å¦‚æœå½“å‰èŠ‚ç‚¹çŠ¶æ€ ä¸º-1 -2 -3 åˆ™é€šè¿‡æ¯”è¾ƒæ›¿æ¢ä¸º0    int ws = node.waitStatus;    if (ws &lt; 0)        compareAndSetWaitStatus(node, ws, 0);    Node s = node.next;    // å¦‚æœä¸‹ä¸ªèŠ‚ç‚¹æ˜¯nullæˆ–è€…ä¸‹ä¸ªèŠ‚ç‚¹è¢«cancelled    // å°±é“¾è¡¨ä¸€ç›´å¾€ä¸‹æ‰¾,ç›´è‡³æ‰¾åˆ°çŠ¶æ€å°äºç­‰åŒäº0    if (s == null || s.waitStatus &gt; 0) &#123;        s = null;        for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev)            if (t.waitStatus &lt;= 0)                s = t;    &#125;    // å¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œè€Œä¸”çŠ¶æ€&lt;=0ï¼Œå°±æŠŠå½“å‰èŠ‚ç‚¹unpark    if (s != null)        LockSupport.unpark(s.thread);&#125;\n","categories":["Java"],"tags":["å¤šçº¿ç¨‹ä¸é«˜å¹¶å‘ç³»åˆ—","AQS","é”","ReentrantLock"]},{"title":"Seata åˆ†å¸ƒå¼äº‹åŠ¡åŸç†æºç åˆ†æï¼ˆä¸€ï¼‰UndoLog","url":"/2022/06/30/Seata%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89UndoLog/","content":"Seata åˆ†å¸ƒå¼äº‹åŠ¡åŸç†æºç åˆ†æï¼ˆä¸€ï¼‰UndoLogä»€ä¹ˆæ˜¯UndoLogï¼ŸUndoLog æ˜¯ MySQL ä¸­æ¯”è¾ƒé‡è¦çš„äº‹åŠ¡æ—¥å¿—ä¹‹ä¸€ï¼Œé¡¾åæ€ä¹‰æ˜¯ä¸€ç§ç”¨äºæ’¤é”€å›é€€çš„æ—¥å¿—ï¼Œåœ¨äº‹åŠ¡æ²¡æäº¤ä¹‹å‰ï¼ŒMySQLä¼šå…ˆè®°å½•æ›´æ–°å‰çš„æ•°æ®åˆ° UndoLog æ—¥å¿—æ–‡ä»¶é‡Œé¢ï¼Œå½“äº‹åŠ¡å›æ»šæ—¶æˆ–è€…æ•°æ®åº“å´©æºƒæ—¶ï¼Œå¯ä»¥åˆ©ç”¨ UndoLog æ¥è¿›è¡Œå›é€€ã€‚\nä¸»è¦ä½œç”¨æœ‰ä¸¤ä¸ªï¼š\n\næä¾›å›æ»šæ“ä½œï¼Œä¿è¯åŸå­æ€§\n\nMySQLäº‹åŠ¡çš„è¿ä¸ªæ“ä½œï¼šcommit å’Œ rollbackï¼›rollback\n\n\næä¾›å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œä¿è¯éš”ç¦»å‹\n\nå¤šä¸ªäº‹åŠ¡åœ¨æ“ä½œæ—¶äº’ä¸å½±å“\n\n\n\nUndoLog å­˜åœ¨ MySQL çš„æœåŠ¡ç«¯ä¸­ï¼Œé¢å¯¹å¾®æœåŠ¡æ¶æ„åšä¸åˆ°å…±äº«ã€‚æ‰€ä»¥ Seata AT æ¨¡å¼é€šè¿‡ UndoLog è¡¨å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nCREATE TABLE `undo_log` (  `branch_id` bigint(20) NOT NULL COMMENT &#x27;branch transaction id&#x27;,  `xid` varchar(128) NOT NULL COMMENT &#x27;global transaction id&#x27;,  `context` varchar(128) NOT NULL COMMENT &#x27;undo_log context,such as serialization&#x27;,  `rollback_info` longblob NOT NULL COMMENT &#x27;rollback info&#x27;,  `log_status` int(11) NOT NULL COMMENT &#x27;0:normal status,1:defense status&#x27;,  `log_created` datetime(6) NOT NULL COMMENT &#x27;create datetime&#x27;,  `log_modified` datetime(6) NOT NULL COMMENT &#x27;modify datetime&#x27;,  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;AT transaction mode undo table&#x27;;\n\n\n\nUndoLogManagerUndoLog ç»Ÿä¸€ç”± UndoLogManager æ¥å£ç®¡ç†ï¼Œå®ç°ç±»æœ‰ï¼šMySQLUndoLogManager å’Œ OracleUndoLogManager ï¼Œå¯¹åº”äº†MySQL å’Œ Oracle ä¸¤å¤§æ•°æ®åº“ã€‚\nprivate static final String INSERT_UNDO_LOG_SQL = &quot;INSERT INTO &quot; + UNDO_LOG_TABLE_NAME +            &quot; (&quot; + ClientTableColumnsName.UNDO_LOG_BRANCH_XID + &quot;, &quot; + ClientTableColumnsName.UNDO_LOG_XID + &quot;, &quot;            + ClientTableColumnsName.UNDO_LOG_CONTEXT + &quot;, &quot; + ClientTableColumnsName.UNDO_LOG_ROLLBACK_INFO + &quot;, &quot;            + ClientTableColumnsName.UNDO_LOG_LOG_STATUS + &quot;, &quot; + ClientTableColumnsName.UNDO_LOG_LOG_CREATED + &quot;, &quot;            + ClientTableColumnsName.UNDO_LOG_LOG_MODIFIED + &quot;)&quot; +            &quot; VALUES (?, ?, ?, ?, ?, now(), now())&quot;;    private static final String DELETE_UNDO_LOG_BY_CREATE_SQL = &quot;DELETE FROM &quot; + UNDO_LOG_TABLE_NAME +            &quot; WHERE log_created &lt;= ? LIMIT ?&quot;;\n\nä»¥MySQLä¸ºä¾‹,å­˜å‚¨äº†ä¸¤æ¡SQLè¯­å¥ï¼Œä¸€æ¡æ˜¯æ’å…¥ä¸€æ¡æ˜¯åˆ é™¤ã€‚åˆ†åˆ«ç”¨äºå¼€å§‹å…¨å±€äº‹åŠ¡åæ•°æ®å‘ç”Ÿå˜åŠ¨æ’å…¥UndoLogï¼Œå’Œäº‹ç‰©æäº¤æˆ–å›æ»šååˆ é™¤å¯¹åº”çš„UndoLogã€‚\nä½•æ—¶æ’å…¥UndoLog@Overridepublic void flushUndoLogs(ConnectionProxy cp) throws SQLException &#123;  ConnectionContext connectionContext = cp.getContext();  String xid = connectionContext.getXid();  long branchID = connectionContext.getBranchId();  BranchUndoLog branchUndoLog = new BranchUndoLog();  branchUndoLog.setXid(xid);  branchUndoLog.setBranchId(branchID);  branchUndoLog.setSqlUndoLogs(connectionContext.getUndoItems());  UndoLogParser parser = UndoLogParserFactory.getInstance();  byte[] undoLogContent = parser.encode(branchUndoLog);  if (LOGGER.isDebugEnabled()) &#123;    LOGGER.debug(&quot;Flushing UNDO LOG: &#123;&#125;&quot;, new String(undoLogContent, Constants.DEFAULT_CHARSET));  &#125;  insertUndoLogWithNormal(xid, branchID, buildContext(parser.getName()), undoLogContent,                          cp.getTargetConnection());&#125;\n\nprivate void insertUndoLog(String xid, long branchID, String rollbackCtx,                           byte[] undoLogContent, State state, Connection conn) throws SQLException &#123;  PreparedStatement pst = null;  try &#123;    pst = conn.prepareStatement(INSERT_UNDO_LOG_SQL);    pst.setLong(1, branchID);    pst.setString(2, xid);    pst.setString(3, rollbackCtx);    pst.setBlob(4, BlobUtils.bytes2Blob(undoLogContent));    pst.setInt(5, state.getValue());    pst.executeUpdate();  &#125; catch (Exception e) &#123;    if (!(e instanceof SQLException)) &#123;      e = new SQLException(e);    &#125;    throw (SQLException) e;  &#125; finally &#123;    if (pst != null) &#123;      pst.close();    &#125;  &#125;&#125;\n\n\n\n\n\n\né‚£ä¹ˆæœ‰ä¸ªç–‘é—®ï¼ŒSeataæ˜¯å¦‚ä½•å®ç°åœ¨å¢åˆ æ”¹æ“ä½œæ—¶è‡ªåŠ¨æ’å…¥UndoLogæ•°æ®ã€‚\n\n","categories":["Java"],"tags":["åˆ†å¸ƒå¼","Seata"]},{"title":"Springæºç è§£æ(ä¸€) åˆ›å»ºBeanå·¥å‚","url":"/2022/01/20/Spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%80-%E5%88%9B%E5%BB%BABean%E5%B7%A5%E5%8E%82/","content":"å‰è¨€ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;application.xml&quot;);User userEntity = (User) context.getBean(&quot;userEntity&quot;);\n\né€šè¿‡ application.xml å®šä¹‰ä¸€äº›Beanå¯¹è±¡ï¼Œåœ¨é¡¹ç›®å¯åŠ¨åä¼šç”±Springçš„Beanå·¥å‚è¿›è¡Œç®¡ç†ã€‚\nè¿™ä¸€åˆ‡éƒ½è¦ä» refresh è¯´èµ·ã€‚\nConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\n\nobtainFreshBeanFactory() ä¸»è¦åšäº†ä¸¤ä»¶äº‹:\n\nåˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨å¯¹è±¡â€”â€”DefaultListableBeanFactory\n\nè§£æè‡ªå®šä¹‰çš„Beanå¯¹è±¡ï¼ˆXMLã€æ³¨è§£ç­‰ï¼‰ï¼Œè®¾ç½®åˆ° beanDefinitionä¸­\n\n\næŠ½è±¡æµç¨‹\nXMLçš„è§£æè¿‡ç¨‹ï¼š String -&gt; Resource[] -&gt; EncodedResource -&gt;Document-&gt;BeanDefinition\nåˆ›å»ºå®¹å™¨å¯¹è±¡/*** This implementation performs an actual refresh of this context&#x27;s underlying* bean factory, shutting down the previous bean factory (if any) and* initializing a fresh bean factory for the next phase of the context&#x27;s lifecycle.*/@Overrideprotected final void refreshBeanFactory() throws BeansException &#123;    // å¦‚æœå­˜åœ¨beanFactoryï¼Œåˆ™é”€æ¯beanFactory    if (hasBeanFactory()) &#123;        destroyBeans();        closeBeanFactory();    &#125;    try &#123;        // åˆ›å»ºDefaultListableBeanFactoryå¯¹è±¡        DefaultListableBeanFactory beanFactory = createBeanFactory();        // ä¸ºäº†åºåˆ—åŒ–æŒ‡å®šidï¼Œå¯ä»¥ä»idååºåˆ—åŒ–åˆ°beanFactoryå¯¹è±¡        beanFactory.setSerializationId(getId());        // å®šåˆ¶beanFactoryï¼Œè®¾ç½®ç›¸å…³å±æ€§ï¼ŒåŒ…æ‹¬æ˜¯å¦å…è®¸è¦†ç›–åŒåç§°çš„ä¸åŒå®šä¹‰çš„å¯¹è±¡ä»¥åŠå¾ªç¯ä¾èµ–        customizeBeanFactory(beanFactory);        // åˆå§‹åŒ–documentReader,å¹¶è¿›è¡ŒXMLæ–‡ä»¶è¯»å–åŠè§£æ,é»˜è®¤å‘½åç©ºé—´çš„è§£æï¼Œè‡ªå®šä¹‰æ ‡ç­¾çš„è§£æ        loadBeanDefinitions(beanFactory);        // å°†åˆ›å»ºçš„Beanå·¥å‚è®¾ç½®åˆ°å¯¹è±¡å±æ€§ä¸­        this.beanFactory = beanFactory;    &#125;    catch (IOException ex) &#123;        throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);    &#125;&#125;\n\nrefreshBeanFactoryé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªBeanFactoryå¯¹è±¡ï¼Œå¹¶åšä¸€äº›åŸºç¡€çš„é…ç½®ï¼Œæœ€ååŠ è½½BeanDefinition\nprotected DefaultListableBeanFactory createBeanFactory() &#123;    return new DefaultListableBeanFactory(getInternalParentBeanFactory());&#125;\n\nDefaultListableBeanFactoryå°±æ˜¯æœ€ç»ˆçš„BeanFactoryå¯¹è±¡ã€‚\nè§£æè‡ªå®šä¹‰Beanå¯¹è±¡refreshBeanFactory()ä¸­æœ‰ä¸€ä¸ªloadBeanDefinitions()ï¼Œåˆå§‹åŒ–documentReaderå¯¹XMLæ–‡ä»¶è¿›è¡Œè¯»å–ï¼Œæœ€ç»ˆå¾—åˆ°BeanDefinitionsã€‚\nBeanDefinitionsæ˜¯ä»€ä¹ˆï¼Ÿ\nè™½ç„¶é€šè¿‡Readerå¯¹è±¡è¯»å–è§£æå¾—åˆ°äº†BeanDefinitionsï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„Beanå¯¹è±¡ã€‚\nå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ª XML åˆ° Bean çš„ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œæ— è®ºä½ çš„Beané€šè¿‡ä»€ä¹ˆæ–¹å¼å®šä¹‰åªè¦ä½ èƒ½è§£æä¸ºBeanDefinitionsæˆ‘éƒ½å¯ä»¥æŠŠä»–åˆ›å»ºæˆä¸€ä¸ªSpring Beanã€‚\n\nloadBeanDefinitions@Overrideprotected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123;    // åˆ›å»ºä¸€ä¸ªxmlçš„beanDefinitionReaderï¼Œå¹¶é€šè¿‡å›è°ƒè®¾ç½®åˆ°beanFactoryä¸­    XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);\t    // ä¸€äº›é…ç½®æ“ä½œ,çœç•¥        // å¼€å§‹å®ŒæˆbeanDefinitionçš„åŠ è½½    loadBeanDefinitions(beanDefinitionReader);&#125;\n\nloadBeanDefinitionsæ–¹æ³•ä¸­åˆ›å»ºäº†XmlBeanDefinitionReaderåç»­ä¼šé€šè¿‡Readerå¯¹è±¡å¯¹XMLè¿›è¡Œä¸€ä¸ªè¯»å–å’Œè§£æã€‚\nå¹¶ä¸”loadBeanDefinitionsè¿ç”¨äº†é‡è½½ï¼Œè™½ç„¶è¿˜æ˜¯é‚£ä¸ªåå­—ä½†æ˜¯å‚æ•°å‘ç”Ÿäº†æ”¹å˜ã€‚å‚æ•°ä»Beanå·¥å‚å˜æˆäº†Reader\nprotected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException &#123;    // ä»¥Resourceçš„æ–¹å¼è·å¾—é…ç½®æ–‡ä»¶çš„èµ„æºä½ç½®    Resource[] configResources = getConfigResources();    if (configResources != null) &#123;        reader.loadBeanDefinitions(configResources);    &#125;    // ä»¥Stringçš„å½¢å¼è·å¾—é…ç½®æ–‡ä»¶çš„ä½ç½®    String[] configLocations = getConfigLocations();    if (configLocations != null) &#123;        reader.loadBeanDefinitions(configLocations);    &#125;&#125;\n\næ­¤å¤„å°±è¦çœ‹ä½ åœ¨new ClassPathXmlApplicationContext()çš„æ—¶å€™å‚æ•°ä¼ çš„æ˜¯ä»€ä¹ˆäº†ï¼Œåˆ†åˆ«æ‰§è¡Œä¸¤ä¸ªæ–¹æ³•ã€‚\nloadBeanDefinitions\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡Œçš„æ–¹æ³•è™½ç„¶è¿˜æ˜¯loadBeanDefinitions ä½†æ˜¯å·²ç»æ‰§è¡Œçš„ä¸æ˜¯åŸæ¥é‚£ä¸ªå¯¹è±¡çš„æ–¹æ³•äº†ï¼Œæ­¤æ—¶åˆ°äº†AbstractBeanDefinitionReaderå¯¹è±¡ã€‚\n\n@Overridepublic int loadBeanDefinitions(String... locations) throws BeanDefinitionStoreException &#123;    Assert.notNull(locations, &quot;Location array must not be null&quot;);    int count = 0;    for (String location : locations) &#123;        count += loadBeanDefinitions(location);    &#125;    return count;&#125;\n\nå› ä¸ºå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ•°ç»„ï¼Œæ­¤å¤„å¯¹æ•°ç»„è¿›è¡Œéå†ï¼Œå¯¹å­—ç¬¦ä¸²çš„èµ„æºåœ°å€å†æ¬¡æ‰§è¡ŒloadBeanDefinitionsæ–¹æ³•ã€‚\nè¿”å›ç»“æœæ˜¯ä¸€ä¸ªintï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„èµ„æºåœ°å€åŠ è½½æˆåŠŸçš„Beanæ•°é‡ã€‚\nloadBeanDefinitions\néšåç»å†æ•°æ¬¡loadBeanDefinitionsæ–¹æ³•ï¼Œç›´æ¥è·³è¿‡äº†â€¦\n\ndoLoadBeanDefinitions\nSpringæºç ä¸­å¾ˆå¤šåå­—å« doXXXX çš„å¯¹è±¡æ‰æ˜¯çœŸæ­£å¹²æ´»çš„å¯¹è±¡ã€‚\n\ntry &#123;    // æ­¤å¤„è·å–xmlæ–‡ä»¶çš„documentå¯¹è±¡ï¼Œè¿™ä¸ªè§£æè¿‡ç¨‹æ˜¯ç”±documentLoaderå®Œæˆçš„,    // ä»String[] -string-Resource[]- resource,æœ€ç»ˆå¼€å§‹å°†resourceè¯»å–æˆä¸€ä¸ªdocumentæ–‡æ¡£    // æ ¹æ®æ–‡æ¡£çš„èŠ‚ç‚¹ä¿¡æ¯å°è£…æˆä¸€ä¸ªä¸ªçš„BeanDefinitionå¯¹è±¡    Document doc = doLoadDocument(inputSource, resource);    int count = registerBeanDefinitions(doc, resource);    if (logger.isDebugEnabled()) &#123;        logger.debug(&quot;Loaded &quot; + count + &quot; bean definitions from &quot; + resource);    &#125;    return count;&#125;\n\n\n\ndoRegisterBeanDefinitionsprotected void doRegisterBeanDefinitions(Element root) &#123;    BeanDefinitionParserDelegate parent = this.delegate;    this.delegate = createDelegate(getReaderContext(), root, parent);    if (this.delegate.isDefaultNamespace(root)) &#123;        String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);        if (StringUtils.hasText(profileSpec)) &#123;            String[] specifiedProfiles = StringUtils.tokenizeToStringArray(                profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);                        if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;                if (logger.isDebugEnabled()) &#123;                    logger.debug(&quot;Skipped XML bean definition file due to specified profiles [&quot; + profileSpec +                                 &quot;] not matching: &quot; + getReaderContext().getResource());                &#125;                return;            &#125;        &#125;    &#125;        preProcessXml(root);    // è§£æBeanDefinitions    parseBeanDefinitions(root, this.delegate);    postProcessXml(root);    this.delegate = parent;&#125;\n\nparseBeanDefinitionsprotected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123;    if (delegate.isDefaultNamespace(root)) &#123;        NodeList nl = root.getChildNodes();        for (int i = 0; i &lt; nl.getLength(); i++) &#123;            Node node = nl.item(i);            if (node instanceof Element) &#123;                Element ele = (Element) node;                if (delegate.isDefaultNamespace(ele)) &#123;                    parseDefaultElement(ele, delegate);                &#125;                else &#123;                    delegate.parseCustomElement(ele);                &#125;            &#125;        &#125;    &#125;    else &#123;        delegate.parseCustomElement(root);    &#125;&#125;\n\nå¯¹æ•´ä¸ªXMLæ–‡ä»¶è¿›è¡Œé€è¡Œå˜é‡\nparseDefaultElementprivate void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) &#123;    if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;        importBeanDefinitionResource(ele);    &#125;    else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;        processAliasRegistration(ele);    &#125;    else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;        processBeanDefinition(ele, delegate);    &#125;    else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;        // recurse        doRegisterBeanDefinitions(ele);    &#125;&#125;\n\næ ¹æ®æ ‡ç­¾çš„ç±»å‹è¿›è¡Œè§£æï¼Œ&lt;bean&gt;&lt;/bean&gt;è‡ªç„¶ä¼šæ‰§è¡ŒprocessBeanDefinition\nprocessBeanDefinition/** * Process the given bean element, parsing the bean definition * and registering it with the registry. */protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123;    // beanDefinitionHolderæ˜¯beanDefinitionå¯¹è±¡çš„å°è£…ç±»ï¼Œå°è£…äº†BeanDefinitionï¼Œbeançš„åå­—å’Œåˆ«åï¼Œç”¨å®ƒæ¥å®Œæˆå‘IOCå®¹å™¨çš„æ³¨å†Œ    // å¾—åˆ°è¿™ä¸ªå¯¹è±¡å°±æ„å‘³ç€beandefinitionæ˜¯é€šè¿‡BeanDefinitionParserDelegate    // å¯¹xmlå…ƒç´ çš„ä¿¡æ¯æŒ‰ç…§springçš„beanè§„åˆ™è¿›è¡Œè§£æå¾—åˆ°çš„    BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);    if (bdHolder != null) &#123;        bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);        try &#123;            // Register the final decorated instance.            // å‘iocå®¹å™¨æ³¨å†Œè§£æå¾—åˆ°çš„beandefinitionçš„åœ°æ–¹            BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());        &#125;        catch (BeanDefinitionStoreException ex) &#123;            getReaderContext().error(&quot;Failed to register bean definition with name &#x27;&quot; +                                     bdHolder.getBeanName() + &quot;&#x27;&quot;, ele, ex);        &#125;        // Send registration event.        // åœ¨beandefinitionå‘iocå®¹å™¨æ³¨å†Œå®Œæˆä¹‹åï¼Œå‘é€æ¶ˆæ¯        getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder));    &#125;&#125;\n\nregisterBeanDefinitionpublic static void registerBeanDefinition(      BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)      throws BeanDefinitionStoreException &#123;   // è·å–BeanName   String beanName = definitionHolder.getBeanName();   // ä½¿ç”¨beanNameåšå”¯ä¸€æ ‡è¯†æ³¨å†Œ   registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());   // Register aliases for bean name, if any.   // æ³¨å†Œæ‰€æœ‰çš„åˆ«å   String[] aliases = definitionHolder.getAliases();   if (aliases != null) &#123;      for (String alias : aliases) &#123;         registry.registerAlias(beanName, alias);      &#125;   &#125;&#125;\n\n\n\nregisterBeanDefinition@Overridepublic void registerBeanDefinition(String beanName, BeanDefinition beanDefinition)    throws BeanDefinitionStoreException &#123;    // çœç•¥ ....    else &#123;        // Still in startup registration phase        // æ³¨å†ŒbeanDefinition        this.beanDefinitionMap.put(beanName, beanDefinition);        // è®°å½•beanName        this.beanDefinitionNames.add(beanName);        removeManualSingletonName(beanName);    &#125;    this.frozenBeanDefinitionNames = null;    // çœç•¥ ....&#125;\n\næ­¤æ—¶registerBeanDefinitionå·²ç»å›åˆ°äº†DefaultListableBeanFactoryæ–¹æ³•ï¼Œæ­£å¸¸æ‰§è¡Œæ¥è¯´ä¸»è¦ä¼šåšå¦‚ä¸‹æ“ä½œï¼š\n\nå°†è§£ææˆåŠŸçš„Beanå¯¹è±¡åç§°åŠ åˆ°beanDefinitionNamesçš„åˆ—è¡¨ä¸­\nå°†BeanNameå’ŒBeanDefinitionçš„é”®å€¼å¯¹å­˜æ”¾åœ¨beanDefinitionMapä¸­\n\nè‡³æ­¤ï¼Œå°±å°†äº”èŠ±å…«é—¨çš„è‡ªå®šä¹‰Beanè§£æä¸ºäº†BeanDefinitionï¼Œå¹¶å­˜æ”¾åœ¨äº†BeanFactoryä¸­ï¼Œåç»­éœ€è¦åŠ è½½æŸä¸ªBeanæ—¶åªéœ€è¦æ ¹æ®åç§°åˆ°mapä¸­æ‰¾åˆ°å¯¹åº”çš„BeanDefinitionå³å¯ï¼Œç„¶åæ‰§è¡ŒdoCreateBeanæ–¹æ³•ã€‚\n","categories":["Java"],"tags":["Spring","Springæºç è§£æç³»åˆ—"]},{"title":"Springæºç è§£æ(ä¸‰) æ³¨å†ŒBeanå¤„ç†å™¨å¯¹è±¡","url":"/2022/01/21/Spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%B8%89-%E6%B3%A8%E5%86%8CBean%E5%A4%84%E7%90%86%E5%99%A8/","content":"å‰è¨€å‰é¢è®²äº† BeanFactoryPostProcessoræœ¬æ–‡è®² BeanPostProcessorï¼Œä¸¤ç§æ€»ç»™äººä¸€ç§å¾ˆåƒçš„æ„Ÿè§‰ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆæ€»ç»“ä¸€ä¸‹ä¸¤è€…çš„åŒºåˆ«ï¼ˆå¯èƒ½ä¸å…¨ï¼Œé€æ­¥è¡¥å……ï¼‰ã€‚\n\n\n\n\nBeanFactoryPostProcessor\nBeanPostProcessor\n\n\n\nè§’è‰²\nSpring IOC æ‰€ç®¡ç†çš„ä¸€ä¸ªBean\nSpring IOC æ‰€ç®¡ç†çš„ä¸€ä¸ªBean\n\n\næ‰§è¡Œæ—¶é—´\nIOCå®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œå‡†ç¡®æ¥è¯´æ˜¯ refreshæ—¶\næ¯æ¬¡ getBeanæ—¶éƒ½ä¼šè°ƒç”¨\n\n\næ‰§è¡Œæ¬¡æ•°\næœ‰ä¸”åªæœ‰ä¸€æ¬¡\næ— æ•°æ¬¡\n\n\nå®ç°æ–¹å¼\nå®ç° BeanFactoryPostProcessoræ¥å£\nå®ç° BeanPostProcessoræ¥å£\n\n\næ’åº\nå¯æ’åº\nå¯æ’åº\n\n\nè·å–åˆ°çš„å‚æ•°\nConfigurableListableBeanFactory ä¹Ÿå°±æ˜¯Spring çš„æ ¸å¿ƒBeanFactory\nObject,æ‰§è¡Œ getBeançš„å¯¹è±¡\n\n\næ“ä½œæ€§\nBeanå·¥å‚çš„æ“ä½œä»–éƒ½èƒ½æ‰§è¡Œï¼Œä¾‹å¦‚ï¼šå¯ä»¥è·å– BeanDefinitionå¹¶ä¿®æ”¹ï¼›æå‰æ³¨å…¥Beanå¯¹è±¡ï¼ˆæ‰§è¡Œè¯¥æ­¥éª¤æ—¶ï¼Œè‡ªå®šä¹‰çš„Beanéƒ½æ²¡æœ‰æ³¨å…¥ï¼‰ï¼›ç­‰ç­‰ç­‰ç­‰\nä¿®æ”¹å½“å‰Beançš„ä¿¡æ¯\n\n\næœ¬æ–‡ä¸»è¦ä»‹ç»äº† refresh æ–¹æ³•ä¸­çš„ registerBeanPostProcessors(beanFactory); , ç”¨äºæ³¨å†ŒBeançš„å¤„ç†å™¨å¯¹è±¡ã€‚\nâš ï¸ åªæ˜¯æ³¨å†Œï¼Œä¸æ‰§è¡Œã€‚\næŠ½è±¡æµç¨‹å…¶å®å’Œ BeanFactoryPostProcessorçš„è°ƒç”¨æµç¨‹ç±»ä¼¼ã€‚\n\næ ¹æ®ç±»å‹æŸ¥è¯¢æ‰€æœ‰ BeanPostProcessorçš„å®ç°å¯¹è±¡ï¼Œå¾—åˆ°ä¸€ä¸ªæ•°ç»„\nè®°å½• BeanPostProcessorçš„æ•°é‡ï¼ˆä¼šæœ‰ä¸€ä¸ª+1çš„æ“ä½œï¼Œå› ä¸ºè¦ç®—ä¸Šä¸‹é¢æ‰‹åŠ¨æ³¨å†Œçš„ BeanPostProcessorCheckerï¼‰\næ‰‹åŠ¨æ³¨å†Œ BeanPostProcessorChecker\nå‡†å¤‡ä¸€äº›å®¹å™¨ï¼Œç”¨äºå­˜æ”¾æ”¶é›†æ¥çš„å„ç§å¤„ç†å™¨\néå† BeanPostProcessorçš„å®ç°å¯¹è±¡æ•°ç»„\nå¦‚æœ BeanPostProcessorå®ç°äº† PriorityOrderedæ¥å£ï¼Œè·å– Beanå¯¹è±¡å¹¶æ·»åŠ åˆ° priorityOrderedPostProcessorsåˆ—è¡¨ï¼ˆå’Œåé¢çš„æœ‰æ‰€ä¸åŒï¼Œè¿™é‡Œæ·»åŠ åˆ°åˆ—è¡¨çš„æ˜¯ BeanPostProcessorå…·ä½“ Beanå¯¹è±¡,å…¶ä»–éƒ½æ˜¯å­—ç¬¦ä¸²ï¼‰\nå¦‚æœè·å–åˆ°çš„ Beanå¯¹è±¡è¿˜å®ç°äº† MergedBeanDefinitionPostProcessoråˆ™æ·»åŠ åˆ° internalPostProcessorsåˆ—è¡¨\n\n\nå¦‚æœæ²¡æœ‰å®ç° PriorityOrderedæ¥å£ï¼Œä½†æ˜¯å®ç°äº† Orderæ¥å£ï¼Œæ·»åŠ åˆ° orderedPostProcessorNamesåˆ—è¡¨ä¸­\nå¦‚æœæ²¡æœ‰å®ç°æ’åºç›¸å…³çš„æ¥å£ï¼Œæ™®é€šå¯¹è±¡æ·»åŠ åˆ° nonOrderedPostProcessorNamesåˆ—è¡¨ä¸­\n\n\nå¯¹ priorityOrderedPostProcessors è¿›è¡Œæ’åºï¼Œå¹¶æ³¨å†Œ\néå† orderedPostProcessorNamesåˆ—è¡¨\næ ¹æ® ppNameæ‰¾åˆ°å¯¹åº”çš„ BeanPostProcessorå®ä¾‹å¯¹è±¡\næ·»åŠ åˆ° orderedPostProcessorsé›†åˆä¸­\nå¦‚æœå®ç°äº† MergedBeanDefinitionPostProcessoræ¥å£ï¼Œé‚£ä¹ˆåˆ™å°† ppNameå¯¹åº”çš„ beanå®ä¾‹æ·»åŠ åˆ° internalPostProcessorsä¸­\n\n\nå¯¹ orderedPostProcessorsè¿›è¡Œæ’åº\næ³¨å†Œå®ç°äº† Orderedæ¥å£çš„ BeanPostProcessorå®ä¾‹æ·»åŠ åˆ° BeanFactoryä¸­\néå† nonOrderedPostProcessorNames åˆ—è¡¨\næ ¹æ® ppNameæ‰¾åˆ°å¯¹åº”çš„ BeanPostProcessorå®ä¾‹å¯¹è±¡\næ·»åŠ åˆ° nonOrderedPostProcessorsåˆ—è¡¨\nå¦‚æœå®ç°äº† MergedBeanDefinitionPostProcessor åˆ™æ·»åŠ åˆ° internalPostProcessorsåˆ—è¡¨\néå† nonOrderedPostProcessorsåˆ—è¡¨è¿›è¡Œæ³¨å†Œ\nå¯¹ internalPostProcessors åˆ—è¡¨è¿›è¡Œæ’åºï¼Œå¹¶éå†æ³¨å†Œ\næœ€åæ³¨å†Œ ApplicationListenerDetectoråˆ° BeanFactoryä¸­\n\næ€»ç»“æ•´ä¸ªæµç¨‹ç±»ä¼¼äºè°ƒç”¨ BeanFactoryPostProcessorï¼Œé€šè¿‡ç±»å‹è·å–æ‰€æœ‰çš„Beanå¤„ç†å™¨å¯¹è±¡ã€‚ç„¶åæ ¹æ®é¡ºåºè¿›è¡Œæ³¨å†Œã€‚\né¡ºåºä¸ºï¼š\n\nå®ç°äº† PriorityOrderedæ¥å£çš„å¤„ç†å™¨å¯¹è±¡\nå®ç°äº† Orderedæ¥å£çš„å¤„ç†å™¨å¯¹è±¡\næ²¡æœ‰å®ç°æ’åºçš„å¤„ç†å™¨å¯¹è±¡\nå®ç°äº† MergedBeanDefinitionPostProcessoræ¥å£çš„å¤„ç†å™¨å¯¹è±¡\n\n","categories":["Java"],"tags":["Spring","Springæºç è§£æç³»åˆ—"]},{"title":"Springæºç è§£æ(äºŒ) è°ƒç”¨Beanå·¥å‚å¤„ç†å™¨å¯¹è±¡","url":"/2022/01/21/Spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%BA%8C-%E8%B0%83%E7%94%A8BeanFactory%E5%A4%84%E7%90%86%E5%99%A8/","content":"å‰è¨€BeanFactoryPostProcessor æ˜¯ Spring ä¸­å¾ˆé‡è¦çš„ä¸€ç§æœºåˆ¶ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»äº† BeanFactoryPostProcessor çš„æ³¨å†Œä¸æ‰§è¡Œã€‚\nè¯¥æ­¥éª¤ç›¸æ¯”è¾ƒåˆ›å»º BeanFactoryå¹¶æ³¨å†Œ BeanDefinitionè¦ç®€å•æ¸…æ™°çš„å¤šï¼Œæ²¡æœ‰è¿‡å¤šçš„è°ƒæ ¸å¿ƒæ–¹æ³• PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());åªæœ‰ä¸¤ç™¾å¤šè¡Œã€‚\nåŸºæœ¬æ¦‚å¿µ\nBeanFactoryPostProcessor\nBeanFactoryåœ¨åˆ›å»ºå®Œæˆåçš„åç½®å¤„ç†å™¨ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€äº›ä¸šåŠ¡ä»£ç ï¼Œå¯ç”¨äºï¼šä¿®æ”¹BeanDefinitionï¼Œæå‰CreateBeanã€‚å…¶å®å’Œ BeanPostProcessorç›¸ä¼¼ã€‚\n\nBeanDefinitionRegistryPostProcessor\nä»–æ˜¯ BeanFactoryPostProcessorçš„å­æ¥å£ï¼Œç›¸æ¯”è¾ƒä»–çš„çˆ¶æ¥å£å¤šäº†ä¸€ä¸ªæ‰§è¡Œæ–¹æ³• postProcessBeanDefinitionRegistry\nä¼˜å…ˆçº§è¦å¤§äº BeanFactoryPostProcessorã€‚\n\nPriorityOrdered å’Œ Ordered\nå…¶å®éƒ½æ˜¯ç”¨äºå®šä¹‰ä¼˜å…ˆçº§çš„ã€‚\n\n\n\nä¼˜å…ˆçº§ åœ¨æœ¬æ–¹æ³•ä¸­éå¸¸é‡è¦ï¼Œçœ‹ä¼¼ç®€å•çš„ä»£ç è¢«æ‹‰é•¿åˆ°äº†ä¸¤ç™¾å¤šè¡Œå°±æ˜¯å› ä¸ºä¼˜å…ˆçº§å¯¼è‡´çš„ã€‚\nä¸Šé¢æ¦‚å¿µä¸­å¤šæ¬¡æåˆ°ä¼˜å…ˆçº§è¿™ä¸ªè¯ï¼Œä¸‹é¢ç”¨ç®€å•æš´åŠ›çš„è¯è§£ç­”ä¸€ä¸‹ã€‚\n\nBeanDefinitionRegistryPostProcessor çš„ä¼˜å…ˆçº§ä¸€å®šå¤§äº BeanFactoryPostProcessor ï¼Œå°±ç®—å¤©å¡Œäº†ä¹Ÿæ˜¯å…ˆæ‰§è¡Œ BeanDefinitionRegistryPostProcessorã€‚\nè¢«å®šä¹‰ PriorityOrdered çš„ Bean ä¼˜å…ˆçº§ä¸€å®šå¤§äº Ordered çš„å¯¹è±¡ã€‚\nNä¸ªå¯¹è±¡å¦‚æœåŒæ ·è¢« PriorityOrdered æˆ–è€… Ordered å®šä¹‰ï¼Œåˆ™æ¯”è¾ƒå…¶å€¼å¤§å°ã€‚\n\n\næŠ½è±¡æµç¨‹\n\n\nå›¾ç‰‡æ¯”è¾ƒå¤§ï¼Œå»ºè®®æ”¾å¤§åå¯¹æ¯”æºç è§‚çœ‹ã€‚\n\nå¦‚æœç”¨ç®€å•çš„è¯æ€»ç»“æ‰§è¡Œæ­¥éª¤ï¼š\n\nç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œé¢„è®¾çš„ BeanDefinitionRegistryPostProcessor å¯¹è±¡ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ²¡æœ‰é¢„è®¾å¯¹è±¡ï¼‰\nç¬¬äºŒæ­¥ï¼šæ‰§è¡Œç°äº†PriorityOrderedæ¥å£çš„BeanDefinitionRegistryPostProcessor\nç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œå®ç°äº†Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessor\nç¬¬å››æ­¥ï¼šæ‰§è¡Œå‰©ä½™çš„BeanDefinitionRegistryPostProcessor\nç¬¬äº”æ­¥ï¼šæŸ¥è¯¢å®ç° BeanFactoryPostProcessor æ¥å£çš„å¯¹è±¡ï¼Œæ ¹æ®æ˜¯å¦å·²æ‰§è¡Œã€æ˜¯å¦å®ç°PriorityOrderedæˆ–Orderedæ¥å£å»åˆ†ç±»ï¼Œåˆ†åˆ«åŠ å…¥ä¸åŒçš„åˆ—è¡¨ï¼Œç”¨äºæœ€åç»Ÿä¸€çš„æ‰§è¡Œ\nç¬¬å…­æ­¥ï¼šç»Ÿä¸€éå†æ‰§è¡Œå‰é¢æ”¶é›†åˆ°çš„å¤„ç†å™¨å¯¹è±¡\nç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œç»“æŸï¼Œæ¸…ç†å…ƒæ•°æ®ç¼“å­˜\n\nå¦‚ä½•é¢„è®¾çš„å¤„ç†å™¨å¯¹è±¡å‰é¢æœ‰è¯´è¿‡ï¼Œåœ¨ invokeBeanFactoryPostProcessorsä¸­å°† getBeanFactoryPostProcessors()ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº† invokeBeanFactoryPostProcessorsã€‚\nåªéœ€è¦åœ¨æ‰§è¡Œæ­¤æ­¥éª¤ä¹‹å‰å°†å‰ç½®å¤„ç†å™¨æ·»åŠ åˆ° BeanFactoryPostProcessorsä¸­å³å¯ï¼ˆâš ï¸ æ­¤å¤„çš„ BeanFactoryPostProcessorsæœ‰ä¸€ä¸ª sï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼‰ã€‚\nä¾‹å¦‚ï¼š\n\npostProcessBeanFactoryæ˜¯ä¸€ä¸ªé¢„ç•™çš„æ–¹æ³•ï¼Œé‡Œé¢æ²¡æœ‰å®ç°ï¼Œæˆ‘ä»¬åªéœ€è¦é‡å†™è¯¥æ–¹æ³•å³å¯\nprotected void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123;  this.addBeanFactoryPostProcessor(new PreBeanFactoryPostProcessor());&#125;\n\nå…¶ä¸­ PreBeanFactoryPostProcessoræ˜¯è‡ªå·±å®ç°çš„ä¸€ä¸ªå¤„ç†å™¨å¯¹è±¡ã€‚\n\nå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹æºç åœ¨ä»»ä½•åœ°æ–¹æ‰§è¡Œ this.addBeanFactoryPostProcessor\n\n\næºç \nå…¶å®æ•´ä¸ªæµç¨‹èµ°ä¸‹æ¥ï¼Œå‘ç°è¿™å—æºç æ²¡å•¥éš¾çš„å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œç»“åˆæµç¨‹å›¾å’Œå®˜æ–¹æ³¨é‡Šé—®é¢˜ä¸å¤§ã€‚\n\næ€»ç»“ä¸€å¥è¯æ¦‚æ‹¬ï¼šå°±ä¸€ä¸ªæ‰§è¡ŒBeanFactoryå¤„ç†å™¨å¯¹è±¡çš„æ–¹æ³•ï¼Œåªä¸è¿‡å› ä¸ºä¼˜å…ˆçº§çš„é—®é¢˜æå¾—æœ‰ç‚¹å¤æ‚ã€‚\n","categories":["Java"],"tags":["Spring","Springæºç è§£æç³»åˆ—"]},{"title":"Springæºç è§£æ(äº”) è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜","url":"/2022/01/25/Spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E4%BA%94-%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98/","content":"å‰è¨€ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥?@Componentpublic class A &#123;    private B b;&#125;@Componentpublic class B &#123;    private A a;&#125;\n\n\nå¦‚ä¸Šä»£ç ï¼ŒAå’ŒBç›¸äº’ä¾èµ–å¯¹æ–¹\n\n\næ³¨å…¥Aå¯¹è±¡çš„æ—¶å€™å‘ç°éœ€è¦Bå¯¹è±¡ï¼Œé‚£å°±å…ˆå»æ³¨å…¥Bå¯¹è±¡\næ³¨å…¥Bå¯¹è±¡çš„æ—¶å€™å‘ç°éœ€è¦Aå¯¹è±¡ï¼Œé‚£å°±å…ˆå»æ³¨å…¥Aå¯¹è±¡\næ³¨å…¥Aå¯¹è±¡çš„æ—¶å€™å‘ç°éœ€è¦Bå¯¹è±¡ï¼Œé‚£å°±å…ˆå»æ³¨å…¥Bå¯¹è±¡\næ³¨å…¥Bå¯¹è±¡çš„æ—¶å€™å‘ç°éœ€è¦Aå¯¹è±¡ï¼Œé‚£å°±å…ˆå»æ³¨å…¥Aå¯¹è±¡\n\nâ€¦ ä¸æ–­å¾ªç¯å¯¼è‡´æ³¨å…¥å¤±è´¥ã€‚\nè§£å†³æ–¹æ¡ˆ\nä¸€å¥è¯å›ç­”å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ï¼šSpringè§£å†³å¾ªç¯ä¾èµ–çš„æ ¸å¿ƒæ€æƒ³åœ¨äºæå‰æ›å…‰\nåˆ›å»ºBeançš„æ—¶å€™å°†æµç¨‹åˆ†ä¸ºä¸¤æ­¥èµ°ï¼Œå…ˆå®ä¾‹åŒ–å†åˆå§‹åŒ–åªå®ä¾‹åŒ–æ²¡æœ‰åˆå§‹åŒ–çš„å«åŠæˆå“ï¼ˆæ”¾ç½®åœ¨äºŒçº§ç¼“å­˜**earlySingletonObjectsï¼‰åä¹‹åˆ™æ˜¯å®Œæˆå“ï¼ˆæ”¾ç½®åœ¨ä¸€çº§ç¼“å­˜singletonObjects**ï¼‰ã€‚\nAæ³¨å…¥å¯¹è±¡æ—¶é‡åˆ°ä¾èµ–å…¶ä»–å±æ€§å…ˆåˆ°å®Œæˆå“æ± å­å¯»æ‰¾å¯¹è±¡ï¼Œæ²¡æœ‰åˆ™å»åŠæˆå“æ± å­ï¼ŒåŠæˆå“ä¹Ÿæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªåŠæˆå“ã€‚Aå¯¹è±¡æ³¨å…¥æ—¶å…ˆä¸è€ƒè™‘å±æ€§å®Œæˆä¸å¦ï¼Œå…ˆå°†å±æ€§é€ä¸ªæ³¨å…¥ï¼Œä¿è¯è‡ªå·±æ˜¯ä¸ªå®Œæˆå“å¹¶æ”¾ç½®åˆ°ä¸€çº§ç¼“å­˜ï¼Œç„¶åBå¯¹è±¡ä¾èµ–Aå±æ€§æ—¶ç›´æ¥ä»ä¸€çº§ç¼“å­˜å–å‡ºå³å¯ã€‚\n\nè¿™ä¸ªæœºåˆ¶çš„ä¸€ä¸ªå‰æï¼šæ— è®ºæ€ä¹ˆå¡«å……å±æ€§ï¼Œå¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚\n","categories":["Java"],"tags":["Spring","Springæºç è§£æç³»åˆ—"]},{"title":"Springæºç è§£æ(å››) åˆå§‹åŒ–Beanå·¥å‚","url":"/2022/01/21/Spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E5%9B%9B-%E5%88%9D%E5%A7%8B%E5%8C%96Bean%E5%B7%A5%E5%8E%82/","content":"å‰è¨€åˆå§‹åŒ–Beanå·¥å‚ è¿™ä¸ªåå­—èµ·çš„å¥½åƒæœ‰ç‚¹å¤§ï¼Œåœ¨å‰é¢åˆ›å»ºäº†Beanå·¥å‚åå¡«å……äº†ä¸€äº›å±æ€§ï¼Œåˆ›å»ºäº†BeanDifinitionä½†æ˜¯ä¸€ç›´æ²¡æœ‰æ³¨å…¥Beanã€‚\næœ¬ç« Beanå°±å°†æ­£å¼å…¥ä½äº†ã€‚\n\nå»ºè®®ç»“åˆ â€œBeançš„ç”Ÿå‘½å‘¨æœŸâ€ è¿™ä¸ªé—®é¢˜ä¸€èµ·æ€è€ƒ\n\næŠ½è±¡æµç¨‹æºç æµç¨‹\n\nBean çš„ç”Ÿå‘½å‘¨æœŸ\næºç BeanDefinition çš„åˆå¹¶æœºåˆ¶\nåœ¨åˆ›å»ºå·¥å‚å¹¶è¯»å–Beané…ç½®æ—¶ä¼šåˆ›å»ºä¸€ä¸ªBeanDefinitionå¯¹è±¡ï¼ŒBeanDefinitionæ˜¯ä¸€ä¸ªé«˜çº§æ¥å£ï¼Œå‡†ç¡®æ¥è¯´æ—¶åˆ›å»ºä¸ºäº†GenericBeanDefinitionã€‚\nåœ¨ç»å†åˆå¹¶åä¼šå˜æˆRootBeanDefinitionã€‚\nè™½ç„¶æ‰§è¡Œäº†getMergedLocalBeanDefinitionæ–¹æ³•ï¼Œä½†æ˜¯æ­£å¸¸æ¥è¯´è¿™ä¸æ˜¯çœŸæ­£çš„ç¬¬ä¸€æ¬¡åˆå¹¶ã€‚\n\n\nBeanDefinition ä»€ä¹ˆæ—¶å€™åˆå¹¶çš„ï¼Ÿ    \nåœ¨è°ƒç”¨BeanFactoryPostProcessoræ—¶å°±å·²ç»æ‰§è¡Œäº†ã€‚\nString[] postProcessorNames =                    beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);\n\nåœ¨æ ¹æ®ç±»å‹è·å–postProcessorNamesæ—¶ï¼Œéå†æ‰€æœ‰çš„BeanDefinitionNameè·å–åˆå¹¶åçš„BeanDefinition\nRootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);\nä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ\n\nGenericBeanDefinitionç›¸æ¯”è¾ƒRootå¤šäº†ä¸€ä¸ªParentNameçš„å±æ€§ï¼Œç”¨äºè®°å½•Beançš„parentå‚æ•°ã€‚\né€šè¿‡GenericBeanDefinitionå…ˆå®šä¹‰å¥½å¯¹è±¡çš„çˆ¶å­å…³ç³»ï¼Œåé¢çš„RootBeanDefinitionæ ¹æ®å‰é¢æ‰€å®šä¹‰çš„çˆ¶å­å…³ç³»å»åˆ›å»ºBeanï¼Œæ²¡æœ‰çˆ¶ç±»ç›´æ¥åˆ›å»ºï¼Œå­˜åœ¨çˆ¶ç±»é€’å½’çš„å»åˆ›å»ºçˆ¶ç±»ï¼ˆçˆ¶ç±»ä¹Ÿå¯èƒ½å­˜åœ¨çˆ¶ç±»ï¼‰ã€‚\nå¦‚æœä¸æå‰åˆ›å»ºçˆ¶å­å…³ç³»ï¼Œå¾ˆæœ‰å¯èƒ½å‡ºç°åˆ›å»ºå­ç±»æ—¶å‘ç°çˆ¶ç±»è¿˜æ²¡æœ‰åˆ›å»ºæ­¤æ—¶å°±éœ€è¦å¤§é‡çš„åˆ¤æ–­å’ŒæŸ¥è¯¢æ˜¾ç„¶æ˜¯æ²¡æœ‰ä¸¤é˜¶æ®µæœºåˆ¶ä¼˜é›…\n\n\n\nFactoryBean å¤„ç†æœºåˆ¶\nFactoryBean å’Œ BeanFactory çœ‹çš„å¾ˆåƒï¼Œæä¾›çš„æœåŠ¡ä¹Ÿå¾ˆåƒï¼Œä½†æ˜¯åº•å±‚æ—¶å®Œå…¨ä¸åŒçš„ã€‚åœ¨ Spring å®¹å™¨éœ€è¦é’ˆå¯¹çš„åšå‡ºä¸€å¥—å¤„ç†æœºåˆ¶/\n\n// åˆ¤æ–­æ˜¯å¦ä¸ºFactoryBeanif (isFactoryBean(beanName)) &#123;    // [1] æ ¹æ®ï¼ˆ&amp;+beanNameï¼‰çš„è§„åˆ™æ¥è·å–å¯¹è±¡     Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);    // è¿›è¡Œç±»å‹è½¬æ¢    if (bean instanceof FactoryBean) &#123;        FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;        // åˆ¤æ–­è¿™ä¸ªFactoryBeanæ˜¯å¦å¸Œæœ›ç«‹å³åˆå§‹åŒ–        boolean isEagerInit;        if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) &#123;            isEagerInit = AccessController.doPrivileged(                (PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,                getAccessControlContext());        &#125;        else &#123;            // åªæœ‰å®ç°SmartFactoryBeanæ‰å¯ä»¥å®šä¹‰æ˜¯å¦æ€¥è¿«            isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp;                           ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());        &#125;        // [2] å¦‚æœå¸Œæœ›æ€¥åˆ‡çš„åˆå§‹åŒ–ï¼Œåˆ™é€šè¿‡beanNameè·å–beanå®ä¾‹        if (isEagerInit) &#123;            getBean(beanName);        &#125;    &#125;&#125;else &#123;    // [3] å¦‚æœbeanNameå¯¹åº”çš„beanä¸æ˜¯FactoryBeanï¼Œåªæ˜¯æ™®é€šçš„beanï¼Œé€šè¿‡beanNameè·å–beanå®ä¾‹    getBean(beanName);&#125;\n\n\n[1]  æ ¹æ®ï¼ˆ&amp;+beanNameï¼‰çš„è§„åˆ™æ¥è·å–å¯¹è±¡\n\nFactoryBean æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Beanï¼\nFactoryBean æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Beanï¼\nFactoryBean æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Beanï¼\nâš ï¸ é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼Œæ—¢ç„¶ä¹Ÿæ˜¯Beanä¹Ÿæ˜¯éœ€è¦äº¤äºˆSpringå®¹å™¨ç®¡ç†çš„ã€‚æ­£æ˜¯å› ä¸ºFactoryBeançš„ç‰¹æ®Šæ€§ï¼Œæ‹¥æœ‰äº†ä¸å…¶ä»–Beanä¸åŒBeanNameè§„åˆ™ï¼ˆéœ€è¦å‰ç¼€åŠ ä¸€ä¸ª&amp;ï¼‰\n\n\n[2] æ€¥åˆ‡çš„åˆå§‹åŒ–\n\næ­£å¸¸æµç¨‹æ¥è¯´ï¼ŒFactoryBean çš„å¯¹è±¡åœ¨åˆå§‹é˜¶æ®µæ˜¯ä¸ä¼šè¢«æ³¨å…¥åˆ°Springå®¹å™¨çš„ï¼Œéœ€è¦åœ¨getBean()æ‰ä¼šæ³¨å…¥ã€‚\nå¦‚æœisEagerInit = true å°±ä¼šç«‹åˆ»æ³¨å…¥ã€‚\nâš ï¸ æ­¤æ—¶æ³¨å…¥çš„æ˜¯å®é™…çš„Beanï¼Œä¸æ˜¯ä¸Šé¢æ‰€æ³¨å…¥çš„FactoryBean\n\n\n[3] æ™®é€šçš„Bean\n\nä¸æ˜¯FactoryBeanæ­£å¸¸æ‰§è¡ŒgetBean()å³å¯\n\n# doGetBean// å‰é¢è¯´äº† FactoryBean åœ¨BeanNameèµ·åæœ‰ç‹¬ç‰¹çš„è§„èŒƒ// è¯¥æ–¹æ³•å°±æ˜¯å»æ‰äº†&amp;çš„å‰ç¼€String beanName = transformedBeanName(name);Object bean;// æå‰æ£€æŸ¥å•ä¾‹ç¼“å­˜ä¸­æ˜¯å¦æœ‰æ‰‹åŠ¨æ³¨å†Œçš„å•ä¾‹å¯¹è±¡ï¼Œè·Ÿå¾ªç¯ä¾èµ–æœ‰å…³è”Object sharedInstance = getSingleton(beanName);// å¦‚æœbeançš„å•ä¾‹å¯¹è±¡æ‰¾åˆ°äº†ï¼Œä¸”æ²¡æœ‰åˆ›å»ºbeanå®ä¾‹æ—¶è¦ä½¿ç”¨çš„å‚æ•°if (sharedInstance != null &amp;&amp; args == null) &#123;    // ...çœç•¥éƒ¨åˆ†æºç         // è¿”å›å¯¹è±¡çš„å®ä¾‹    bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);&#125;\n\nprotected Object getObjectForBeanInstance(    Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) &#123;    // name å¦‚æœæ˜¯&amp;ä½œä¸ºå‰ç¼€    if (BeanFactoryUtils.isFactoryDereference(name)) &#123;        // å¦‚æœbeanInstanceæ˜¯NullBeanå®ä¾‹        if (beanInstance instanceof NullBean) &#123;            // è¿”å›beanInstance            return beanInstance;        &#125;        // å¦‚æœbeanInstanceä¸æ˜¯FactoryBeanå®ä¾‹        if (!(beanInstance instanceof FactoryBean)) &#123;            // æŠ›å‡ºBeanä¸æ˜¯ä¸€ä¸ªFactoryå¼‚å¸¸            throw new BeanIsNotAFactoryException(beanName, beanInstance.getClass());        &#125;        // å¦‚æœmbdä¸ä¸ºnull        if (mbd != null) &#123;            // è®¾ç½®mbdæ˜¯å¦æ˜¯FactoryBeanæ ‡è®°ä¸ºtrue            mbd.isFactoryBean = true;        &#125;        // è¿”å›beanInstance        return beanInstance;    &#125;    // å¦‚æœä¸æ˜¯FactoryBeanç±»å‹ç›´æ¥è¿”å›    if (!(beanInstance instanceof FactoryBean)) &#123;        return beanInstance;    &#125;    // å®šä¹‰ä¸ºbeanå…¬å¼€çš„å¯¹è±¡ï¼Œåˆå§‹åŒ–ä¸ºnull    Object object = null;    // å¦‚æœmbdä¸ä¸ºnull    if (mbd != null) &#123;        // æ›´æ–°mbdçš„æ˜¯å¦æ˜¯FactoryBeanæ ‡è®°ä¸ºtrue        mbd.isFactoryBean = true;    &#125;    else &#123;        // ä»FactoryBeanè·å¾—çš„å¯¹è±¡ç¼“å­˜é›†ä¸­è·å–beanNameå¯¹åº”çš„Beanå¯¹è±¡        object = getCachedObjectForFactoryBean(beanName);    &#125;    // å¦‚æœobjectä¸ºnull    if (object == null) &#123;        // Return bean instance from factory.        // ä»å·¥å‚è¿”å›Beanå®ä¾‹        // å°†beanInstanceå¼ºè½¬ä¸ºFactoryBeanå¯¹è±¡        FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;        // Caches object obtained from FactoryBean if it is a singleton.        // å¦‚æœæ˜¯å•ä¾‹å¯¹è±¡ï¼Œåˆ™ç¼“å­˜ä»FactoryBeanè·å¾—çš„å¯¹è±¡ã€        // å¦‚æœmbdä¸ºnull&amp;&amp;è¯¥BeanFactoryåŒ…å«beanNameçš„BeanDefinitionå¯¹è±¡ã€‚        if (mbd == null &amp;&amp; containsBeanDefinition(beanName)) &#123;            //è·å–beanNameåˆå¹¶åçš„æœ¬åœ°RootBeanDefintiondå¯¹è±¡            mbd = getMergedLocalBeanDefinition(beanName);        &#125;        // æ˜¯å¦æ˜¯&#x27;synthetic&#x27;æ ‡è®°ï¼šmbdä¸ä¸ºnull &amp;&amp; è¿”å›æ­¤beanå®šä¹‰æ˜¯å¦æ˜¯&quot;synthetic&quot;ã€ä¸€èˆ¬æ˜¯æŒ‡åªæœ‰AOPç›¸å…³çš„prointCuté…ç½®æˆ–è€…        // Adviceé…ç½®æ‰ä¼šå°† syntheticè®¾ç½®ä¸ºtrueã€‘        boolean synthetic = (mbd != null &amp;&amp; mbd.isSynthetic());        // ä»BeanFactoryå¯¹è±¡ä¸­è·å–ç®¡ç†çš„å¯¹è±¡.å¦‚æœä¸æ˜¯syntheticä¼šå¯¹å…¶å¯¹è±¡è¿›è¡Œè¯¥å·¥å‚çš„åç½®å¤„ç†        object = getObjectFromFactoryBean(factory, beanName, !synthetic);    &#125;    // è¿”å›ä¸ºbeanå…¬å¼€çš„å¯¹è±¡    return object;&#125;\n\ngetObjectForBeanInstance æ–¹æ³•å¯èƒ½å‡ºç°ä¸‰ç§æƒ…å†µï¼š\n\næ™®é€šçš„Beanå¯¹è±¡ï¼šç›´æ¥è¿”å›Instance\nå¸¦æœ‰&amp;ç¬¦çš„FactoryBeanï¼šè¿”å›å·¥å‚Bean\nä¸å¸¦&amp;ç¬¦çš„FactoryBeanï¼šè¿”å›å¯¹åº”å·¥å‚çš„å®é™…Bean\n\n\n\nBean æ˜¯å¦æ­£åœ¨åˆ›å»ºä¸­# doGetBeanif (isPrototypeCurrentlyInCreation(beanName)) &#123;    throw new BeanCurrentlyInCreationException(beanName);&#125;protected boolean isPrototypeCurrentlyInCreation(String beanName) &#123;    // è·å–å½“å‰æ­£åœ¨åˆ›å»ºçš„beanåç§°ã€çº¿ç¨‹æœ¬åœ°ã€‘    Object curVal = this.prototypesCurrentlyInCreation.get();    return (curVal != null &amp;&amp;            (curVal.equals(beanName) || (curVal instanceof Set &amp;&amp; ((Set&lt;?&gt;) curVal).contains(beanName))));&#125;\n\n\nâ—è¿”å›Trueè¡¨ç¤ºå½“å‰Beanæ­£åœ¨åˆ›å»º\nå¦‚æœå½“å‰åˆ›å»ºçš„Beanä¸ä¸ºç©ºä¸”ç­‰äºå½“å‰BeanName  æˆ–  å½“å‰æ­£åœ¨åˆ›å»ºçš„beanåç§°æ˜¯Seté›†åˆï¼Œå¹¶åŒ…å«è¯¥beanName\n\nçˆ¶å·¥å‚é—®é¢˜é€šè¿‡BeanNameè·å–Objectæ—¶ï¼Œå¦‚æœå­˜åœ¨çˆ¶å·¥å‚ä¸”å½“å‰å·¥å‚ä¸å­˜åœ¨è¯¥BeanNameæ—¶å¯èƒ½å°±å˜€å’•ï¼Œå®ƒæ˜¯ä¸æ˜¯å­˜åœ¨çˆ¶å·¥å‚äº†ï¼Ÿ\nè§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼šé€šè¿‡é€’å½’çš„æ–¹å¼å±‚å±‚æŸ¥æ‰¾ã€‚\nBeanå­˜åœ¨ä¾èµ–é—®é¢˜ä¾‹å¦‚åœ¨Xmlå®šä¹‰Beanæ—¶å¯èƒ½è®¾å®šä¸€ä¸ª parent å±æ€§ï¼š\n&lt;bean id=&quot;student&quot; class=&quot;com.lksun.debug.entity.Student&quot;&gt;    &lt;property name=&quot;name&quot; value=&quot;miaomiao&quot;/&gt;    &lt;property name=&quot;age&quot; value=&quot;8&quot;/&gt;&lt;/bean&gt;    &lt;bean id=&quot;monitor&quot; class=&quot;com.lksun.debug.entity.Monitor&quot; parent=&quot;student&quot; &gt;    &lt;property name=&quot;className&quot; value=&quot;3-2&quot;/&gt;&lt;/bean&gt;\n\nstudentä½œä¸ºmonitorçš„çˆ¶ç±»æˆ–è€…ä¾èµ–å¯¹è±¡ï¼Œå…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹å°±å¾ˆé‡è¦äº†ã€‚\nå¿…é¡»å…ˆåˆ›å»ºäº†ä¾èµ–Beanå†åˆ›å»ºå½“å‰å¯¹è±¡ã€‚\nè§£å†³æ–¹æ³•åŒæ ·ä½¿ç”¨é€’å½’ï¼Œè·å–å½“å‰å¯¹è±¡æ˜¯å¦æœ‰ä¾èµ–å¯¹è±¡ï¼Œç„¶åå±‚å±‚åˆ¤æ–­\nè§£æBean ClassClass&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);\n\nè·å–åˆ°äº†Classå¯¹è±¡ååªéœ€è¦ä¸€æ­¥resolvedClass.newInstance();å°±å¯ä»¥è·å–åˆ°Objectï¼Œä½†æ˜¯Springæ²¡æœ‰ç›´æ¥è·å–ã€‚\néªŒè¯åŠå‡†å¤‡è¦†ç›–çš„æ–¹æ³•\ntodo â€¦.\nlookup-method  replace-method\n\nå®é™…åˆ›å»ºbeançš„æ–¹æ³• doCreateBean()æ ¹æ®ä¸åŒçš„ç­–ç•¥åˆ›å»ºBeaninstanceWrapper = createBeanInstance(beanName, mbd, args);\n\nè·å–çœŸå®Beanå¯¹è±¡Object bean = instanceWrapper.getWrappedInstance();\n\nåŠ å…¥ç¼“å­˜\nå…³äºè§£å†³å¾ªç¯ä¾èµ–ç›¸å…³çš„é—®é¢˜åç»­ç€é‡è®²\n\naddSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;    Assert.notNull(singletonFactory, &quot;Singleton factory must not be null&quot;);        if (!this.singletonObjects.containsKey(beanName)) &#123;            this.singletonFactories.put(beanName, singletonFactory);            this.earlySingletonObjects.remove(beanName);            this.registeredSingletons.add(beanName);        &#125;    &#125;&#125;\n\n\nåˆ¤æ–­ä¸€çº§ç¼“å­˜ä¸å­˜åœ¨å½“å‰Bean\nç„¶åæ‰§è¡Œï¼š\n1.å°†beanName,singletonFactoryæ”¾åˆ°å•ä¾‹å·¥å‚çš„ç¼“å­˜(ä¸‰çº§ç¼“å­˜)\n2.åœ¨äºŒçº§ç¼“å­˜åˆ é™¤å½“å‰Bean\n3.å°†beanNameæ·»åŠ å·²æ³¨å†Œçš„å•ä¾‹é›†ä¸­\n\nå¡«å……populateBean(beanName, mbd, instanceWrapper);\n\n\n\næ‰§è¡Œåˆå§‹åŒ–é€»è¾‘exposedObject = initializeBean(beanName, exposedObject, mbd);\n\n\nåšäº†å¦‚ä¸‹æ“ä½œï¼š\n1.æ‰§è¡ŒAwareæ¥å£å¤„ç†å™¨\n2.BeanPostProcessorå‰ç½®æ–¹æ³•\n3.è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ï¼Œå…ˆè°ƒç”¨beançš„InitializingBeanæ¥å£æ–¹æ³•ï¼Œåè°ƒç”¨beançš„è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•\n4.BeanPostProcessorå‰ç½®æ–¹æ³•åç½®æ–¹æ³•\n\næ³¨å†ŒDisposable// æ³¨å†Œbeanå¯¹è±¡ï¼Œæ–¹ä¾¿åç»­åœ¨å®¹å™¨é”€æ¯çš„æ—¶å€™é”€æ¯å¯¹è±¡registerDisposableBeanIfNecessary(beanName, bean, mbd);\n\næ ‡è®°ä¸ºâ€œæœªåˆ›å»ºâ€// åˆ›å»ºå•ä¾‹åçš„å›è°ƒ,é»˜è®¤å®ç°å°†å•ä¾‹æ ‡è®°ä¸ºä¸åœ¨åˆ›å»ºä¸­afterSingletonCreation(beanName);\n\næ·»åŠ åˆ°ä¸€çº§ç¼“å­˜\nç­‰ä¸€åˆ‡éƒ½å®Œæˆåæ·»åŠ åˆ°ä¸€çº§ç¼“å­˜\n\n# getSingleton()addSingleton(beanName, singletonObject);protected void addSingleton(String beanName, Object singletonObject) &#123;    synchronized (this.singletonObjects) &#123;        // å°†æ˜ å°„å…³ç³»æ·»åŠ åˆ°å•ä¾‹å¯¹è±¡çš„é«˜é€Ÿç¼“å­˜ä¸­        this.singletonObjects.put(beanName, singletonObject);        // ç§»é™¤beanNameåœ¨å•ä¾‹å·¥å‚ç¼“å­˜ä¸­çš„æ•°æ®        this.singletonFactories.remove(beanName);        // ç§»é™¤beanNameåœ¨æ—©æœŸå•ä¾‹å¯¹è±¡çš„é«˜é€Ÿç¼“å­˜çš„æ•°æ®        this.earlySingletonObjects.remove(beanName);        // å°†beanNameæ·»åŠ åˆ°å·²æ³¨å†Œçš„å•ä¾‹é›†ä¸­        this.registeredSingletons.add(beanName);    &#125;&#125;\n\n\n1.å…ˆæ·»åŠ åˆ°ä¸€çº§ç¼“å­˜\n2.åœ¨ä¸‰çº§ç¼“å­˜ç§»é™¤\n3.åœ¨äºŒçº§ç¼“å­˜ç§»é™¤\n4.ä¿å­˜åˆ°å•ä¾‹é›†åˆä¸­\n\n","categories":["Java"],"tags":["Spring","Springæºç è§£æç³»åˆ—"]},{"title":"Hello World","url":"/2022/01/06/hello-world/","content":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.\nQuick StartCreate a new post$ hexo new &quot;My New Post&quot;\n\nMore info: Writing\nRun server$ hexo server\n\nMore info: Server\nGenerate static files$ hexo generate\n\nMore info: Generating\nDeploy to remote sites$ hexo deploy\n\nMore info: Deployment\n"},{"title":"String str = \"hello\"; å’Œ String = new String(\"hello\"); çš„åŒºåˆ«","url":"/2022/01/08/hello-%E5%92%8C-String-new-String-hello-%E7%9A%84%E5%8C%BA%E5%88%AB/","content":"å‰è¨€String str = &quot;hello&quot;; String = new String(&quot;hello&quot;); \n\nå¦‚ä¸Šä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯åŒºåˆ«è¿˜æ˜¯æœ‰çš„.\nå †å’Œå¸¸é‡æ± çš„å…³ç³»\nå †ï¼ˆHeapï¼‰\n\nJavaå †ï¼ˆJava Heapï¼‰æ˜¯Javaè™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚Heapæ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«åˆ›å»ºã€‚Heapçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚\n\nå­—ç¬¦ä¸²å¸¸é‡æ± \n\nåœ¨jdk1.7ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯å­˜åœ¨äºæ°¸ä¹…ä»£ä¸­ï¼Œåœ¨æ°¸ä¹…ä»£å’Œå †ä¸­çš„åœ°å€æ˜¯å®Œå…¨åˆ†ç¦»çš„ï¼Œä¸ä¼šç›´æ¥å¼•ç”¨ã€‚åœ¨jdk1.7+ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± è¢«æ”¾åœ¨äº†å †ä¸­ã€‚\nå£°æ˜ä¸€ä¸ªå­—ç¬¦ä¸²String Str1 = â€œhelloâ€;å†…å­˜åˆ†å¸ƒå¯¹äºstr1æ¥è¯´ï¼Œç”±äºæ˜¯å¸¸é‡èµ‹å€¼ï¼Œstr1ç›´æ¥æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä»½ã€‚\nString str2 = new String(â€œhelloâ€);å†…å­˜åˆ†å¸ƒString str2 = new String(&quot;ab&quot;);åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒJVMé¦–å…ˆåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥çœ‹å­—ç¬¦ä¸²å¯¹è±¡â€œabâ€æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œåˆ™ç°åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºâ€œabâ€å¯¹è±¡ï¼Œç„¶åå†Heapä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„â€œabâ€å­—ç¬¦ä¸²å¯¹è±¡ã€‚è‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨äº†å­—ç¬¦ä¸²å¯¹è±¡â€œabâ€ï¼Œåˆ™ç›´æ¥åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡â€œabâ€ï¼Œä¸è®¸åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºå¯¹è±¡ï¼Œä½†æ˜¯ä¸ç®¡æ˜¯é‚£ç§æ–¹å¼ï¼Œæ ˆä¸­çš„str2å§‹ç»ˆæŒ‡å‘çš„æ˜¯Heapä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚è‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åŸæœ¬æ²¡æœ‰â€œabâ€å¯¹è±¡ï¼ŒString str2 = new String(â€œabâ€);æ‰§è¡Œåä¼šåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± å’Œå †ä¸­å„åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå³åˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œè‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²å­˜åœ¨äº†â€œabâ€å¯¹è±¡ï¼Œåˆ™åªä¼šåœ¨Heapä¸­åˆ›å»ºï¼Œå³åªåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚\nç¤ºä¾‹ç¤ºä¾‹ä¸€String str1 = &quot;rush b&quot;;String str2 = &quot;rush b&quot;;System.out.println(str1 == str2); // return trueSystem.out.println(str1.equals(str2)); // return trueSystem.out.println(System.identityHashCode(str1)); // return 1163157884System.out.println(System.identityHashCode(str2)); // return 1163157884\n\nstr1 å’Œ str2 æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ä¸ªå˜é‡ï¼Œåœ¨æ ˆç©ºé—´ä¸­åœ°å€æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯é€šè¿‡ System.identityHashCodeå‘ç°ä»–ä»¬å…¶å®ä¹Ÿç›¸åŒã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nç¤ºä¾‹äºŒpublic class StringDemo &#123;\tpublic static void main(String[] args) &#123;\t\tString str1 = &quot;ab&quot;;\t\tString str2 = str1.intern();\t\tSystem.out.println(str1 == str2); // true\t&#125;&#125;\n\n\n\nä»£ç éå¸¸ç®€å•ï¼Œstr1å°±æ˜¯æœ€æ™®é€šçš„å¸¸é‡èµ‹å€¼ï¼Œä¼šç›´æ¥åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºå‡ºâ€abâ€å¯¹è±¡ str1è°ƒç”¨internæ–¹æ³•å¾—åˆ°è¿”å›å€¼èµ‹å€¼ç»™str2ï¼Œinternæ–¹æ³•ä¼šç°åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ£€æµ‹æ˜¯å¦å·²ç»å­˜åœ¨â€abâ€å­—ç¬¦ä¸²å¯¹è±¡ï¼Œè‹¥å·²ç»å­˜åœ¨ï¼Œç›´æ¥æŠŠå­—ç¬¦ä¸²å¸¸é‡æ± é‡Œâ€abâ€å¯¹è±¡çš„åœ°å€èµ‹å€¼ç»™str2ï¼Œæ‰€ä»¥str1==str2ä¸ºtrueã€‚\n\nè‡´è°¢ä½œè€…ï¼šsaojiateteé“¾æ¥ï¼šhttps://juejin.cn/post/6844904015830974472æ¥æºï¼šæ˜é‡‘è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚\n","categories":["Java"],"tags":["JVM","é€ ç«ç®­"]},{"title":"å…³äºMysqlçš„æ±Ÿæ¹–ä¼ è¨€","url":"/2022/01/08/%E5%85%B3%E4%BA%8EMysql%E7%9A%84%E6%B1%9F%E6%B9%96%E4%BC%A0%E8%A8%80/","content":"è°£è¨€ç²‰ç¢æœºè°è¯´å¿…é¡»éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™?åˆ›å»ºç»„åˆç´¢å¼•åœ¨æŸ¥è¯¢è¯­å¥æ—¶å¿…é¡»éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œå³ where æ—¶ç»„åˆç´¢å¼•çš„ç¬¬ä¸€ä¸ªç´¢å¼•åˆ—å¿…é¡»åœ¨æœ€å‰é¢ã€‚ä¸ç„¶ä¼šç´¢å¼•å¤±æ•ˆ!è¿™æ˜¯å¸¸è§çš„å…«è‚¡æ–‡äº†ï¼ŒåŸç†ä¸Šæ²¡æ¯›ç—…ï¼Œåœ¨B+æ ‘ä¸Šæ¯ä¸ªéå¶å­èŠ‚ç‚¹ä¸å¯èƒ½é€ä¸ªæ¯”è¾ƒæ¡ä»¶è¯­å¥ï¼Œé€šè¿‡ç»„åˆç´¢å¼•çš„ç¬¬ä¸€ä¸ªåŒ¹é…ã€‚ä½†æ˜¯ä¼˜åŒ–å™¨åœ¨æ‰§è¡Œå‰ä¼šå¸®åŠ©æˆ‘ä»¬è°ƒæ•´where çš„é¡ºåºï¼Œå¼€å‘è€…ä¸å¼ºåˆ¶é¡ºåºï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯éµå¾ªä¸€ä¸‹ã€‚\n\nSELECT * FROM client  WHERE age = 18 AND shop_id = 1SELECT * FROM client  WHERE shop_id = 1 AND age = 18\n\nå¦‚ä¸Šä¸¤æ¡SQLï¼Œç»“æœä¸€æ ·åªæ˜¯whereçš„é¡ºåºä¸åŒï¼Œç»„åˆç´¢å¼•å­—æ®µè®¾ç½®ä¸º &quot;shop_id &quot;,&quot;age &quot;ï¼Œå¦‚æœæŒ‰ç…§æ±Ÿæ¹–ä¼ è¨€æœ€å·¦åŒ¹é…çš„è¯ç¬¬ä¸€æ¡æ—¶æ— æ³•å‘½ä¸­ç´¢å¼•çš„ï¼Œä½†æ˜¯é€šè¿‡ EXPLAINæŸ¥çœ‹ï¼Œä¸¤æ¡è¯­å¥çš„ç»“æœç›¸åŒã€‚\nè°è¯´ç»„åˆç´¢å¼•é‡åˆ°èŒƒå›´æŸ¥è¯¢å°±å¤±æ•ˆï¼Ÿåœ¨ä¸€ä¸ªç»„åˆç´¢å¼•ä¸­å¦‚ï¼šwhere shop_id = 2 and client_type = 2 and age &gt;18 ,å³ä½¿ &quot;shop_id &quot;,&quot;age &quot;,&quot;client_type &quot;æœ‰ä¸€ä¸ªç»„åˆç´¢å¼•ä½†æ˜¯å› ä¸º ageçš„èŒƒå›´æŸ¥è¯¢ä¼šä¸èµ°ç´¢å¼•ã€‚\né¦–å…ˆè¿™æ˜¯é”™è¯¯çš„ï¼Œåœ¨MySQL5.6ç‰ˆæœ¬åæ¨å‡ºäº†ç´¢å¼•ä¸‹æ¨æœºåˆ¶ï¼Œéç­‰å€¼æŸ¥è¯¢ä¹Ÿå¹¶ä¸ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆäº†ã€‚\nè°è¯´ä½¿ç”¨SQLå‡½æ•°ä¼šç´¢å¼•å¤±æ•ˆ?æŸ¥è¯¢ä¸­ä¸èƒ½ä½¿ç”¨å†…ç½®çš„å‡½æ•°å¦åˆ™ä¼šç´¢å¼•å¤±æ•ˆï¼Œä¹Ÿæ˜¯å¸¸è§çš„å…«è‚¡æ–‡ä¹‹ä¸€äº†é‚£ä¹ˆäº‹å®æƒ…å†µæ˜¯ä»€ä¹ˆæ ·ï¼Ÿ\nEXPLAIN SELECT * FROM client WHERE shop_id = 1 AND nick_name = CONCAT(&quot;é›·&quot;,&quot;è¾¾&quot;) \n\nåœ¨å¦‚ä¸Šè¯­å¥ä¸­ä½¿ç”¨äº† CONCATä½†æ˜¯æŸ¥è¯¢è®¡åˆ’è¿˜æ˜¯å‘½ä¸­ç´¢å¼•\nè¿˜ä¾‹å¦‚ï¼š\nEXPLAIN SELECT * FROM client WHERE shop_id = 1 AND create_time = NOW()\n\nåŒæ ·ä½¿ç”¨äº†ç´¢å¼•\nå†æˆ–è€…\nEXPLAIN SELECT max(age) FROM client WHERE shop_id = 1 AND gmt_create = NOW()\n\n\n\n5.7æ–°å¢ç‰¹æ€§:å¯ä»¥ä½¿ç”¨å‡½æ•°ç´¢å¼•\n\nè°è¯´è®¡ç®—ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ?è¿˜æ˜¯å‰é¢çš„ä¾‹å­\nEXPLAIN SELECT max(age) FROM client WHERE shop_id = 10-9 AND gmt_create = NOW()\n\nshop_idæ²¡æœ‰ç›´æ¥å†™1 ,ä½¿ç”¨äº† 10-9ï¼Œæœ€ç»ˆçš„æ•ˆæœæ—¶ä¸€æ ·çš„ã€‚\n","categories":["MySQL"],"tags":["é€ ç«ç®­","è°è¨€ç²‰ç¢æœº","MySQLè°ƒä¼˜"]}]